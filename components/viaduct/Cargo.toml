[package]
name = "viaduct"
version = "0.1.0"
authors = ["Thom Chiovoloni <tchiovoloni@mozilla.com>"]
edition = "2021"
license = "MPL-2.0"
exclude = ["/android", "/ios"]

[lib]
crate-type = ["lib"]

[dependencies]
async-trait = "0.1"
error-support = { path = "../support/error" }
url = "2"
serde = "1"
serde_json = "1"
once_cell = "1.5"
parking_lot = { version = ">=0.11,<=0.12" }
pollster = "0.3.0"
prost = "0.12"
ffi-support = "0.4"
thiserror = "2"
uniffi = { version = "0.29.0" }
tokio = { version = "1", features = ["rt-multi-thread"], optional = true }
hyper = { version = "0.14", features = ["client", "http1", "http2", "tcp"], optional = true }

# For desktop x86_64 Linux - use NSS
[target.'cfg(all(target_os = "linux", target_arch = "x86_64"))'.dependencies]
bhttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", optional = true }
ohttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", features = ["client", "server", "app-svc", "external-sqlite"], default-features = false, optional = true }

# For desktop x86_64 macOS - use NSS
[target.'cfg(all(target_os = "macos", target_arch = "x86_64"))'.dependencies]
bhttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", optional = true }
ohttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", features = ["client", "server", "app-svc", "external-sqlite"], default-features = false, optional = true }

# For macOS aarch64 (M1/M2 Macs) - use NSS
[target.'cfg(all(target_os = "macos", target_arch = "aarch64"))'.dependencies]
bhttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", optional = true }
ohttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", features = ["client", "server", "app-svc", "external-sqlite"], default-features = false, optional = true }

# For iOS (all architectures) - use rust-hpke
[target.'cfg(target_os = "ios")'.dependencies]
bhttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", optional = true }
ohttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", features = ["client", "server", "rust-hpke"], default-features = false, optional = true }

# For Android (all architectures) - use rust-hpke
[target.'cfg(target_os = "android")'.dependencies]
bhttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", optional = true }
ohttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", features = ["client", "server", "rust-hpke"], default-features = false, optional = true }

# For Windows - use rust-hpke
[target.'cfg(target_os = "windows")'.dependencies]
bhttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", optional = true }
ohttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", features = ["client", "server", "rust-hpke"], default-features = false, optional = true }

# For Linux aarch64 - use rust-hpke (avoid cross-compile issues)
[target.'cfg(all(target_os = "linux", target_arch = "aarch64"))'.dependencies]
bhttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", optional = true }
ohttp = { git = "https://github.com/martinthomson/ohttp.git", rev = "bf6a983845cc0b540effb3a615e92d914dfcfd0b", features = ["client", "server", "rust-hpke"], default-features = false, optional = true }

[features]
default = ["ohttp"]
backend-dev = ["dep:tokio", "dep:hyper"]
ohttp = ["dep:bhttp", "dep:ohttp"]
