name: Generate Swift Docs

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: macos-latest

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install Rust
        run: |
          RUSTUP_PLATFORM=x86_64-apple-darwin
          RUSTUP_VERSION=1.27.0
          curl -sfSL --retry 5 --retry-delay 10 -O "https://static.rust-lang.org/rustup/archive/${RUSTUP_VERSION}/${RUSTUP_PLATFORM}/rustup-init"
          chmod +x rustup-init
          ./rustup-init -y --no-modify-path
          rm rustup-init
          echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $GITHUB_ENV
          source $HOME/.cargo/env

      - name: Set up Ruby environment
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Install Jazzy
        run: gem install jazzy

      - name: Run build script
        run: |
          cd ./automation/swift-components-docs
          ./build.sh

      - name: Deploy
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan swift-docs
          git --work-tree automation/swift-components-docs/docs add --all
          git --work-tree automation/swift-components-docs/docs commit -m "Deploy Swift docs"
          git push origin HEAD:swift-docs --force
