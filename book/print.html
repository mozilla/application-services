<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cross-platform Rust Components</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-8a137ef6.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5592c39f.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Cross-platform Rust Components</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="application-services-rust-components"><a class="header" href="#application-services-rust-components">Application Services Rust Components</a></h1>
<p>Application Services is collection of Rust Components. The components are used to enable Firefox, and related applications to integrate with Firefox accounts, sync and enable experimentation. Each component is built using a core of shared code written in Rust, wrapped with native language bindings for different platforms.</p>
<h2 id="contact-us"><a class="header" href="#contact-us">Contact us</a></h2>
<p>To contact the Application Services team you can:</p>
<ul>
<li>Find us in the chat <a href="https://chat.mozilla.org/#/room/#rust-components:mozilla.org">#rust-components:mozilla.org</a> (<a href="https://wiki.mozilla.org/Matrix#Connect_to_Matrix">How to connect</a>)</li>
<li>To report issues with sync on <strong>Firefox Desktop</strong>, file a bug in <a href="https://bugzilla.mozilla.org/enter_bug.cgi?product=Firefox&amp;component=Sync">Bugzilla for Firefox :: Sync</a></li>
<li>To report issues with our components, file an issue in <a href="https://github.com/mozilla/application-services/issues">the GitHub issue tracker</a></li>
</ul>
<p>The source code is available <a href="https://github.com/mozilla/application-services/">on GitHub</a>.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>The Application Services Source Code is subject to the terms of the Mozilla Public License v2.0.
You can obtain a copy of the MPL at <a href="https://mozilla.org/MPL/2.0/">https://mozilla.org/MPL/2.0/</a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="contributing-to-application-services"><a class="header" href="#contributing-to-application-services">Contributing to Application Services</a></h1>
<p>Anyone is welcome to help with the <a href="#application-services-rust-components">Application Services</a> project. Feel free to get in touch with <a href="#contact-us">other community members on Matrix or through issues on GitHub.</a></p>
<p>Participation in this project is governed by the
<a href="https://www.mozilla.org/en-US/about/governance/policies/participation/">Mozilla Community Participation Guidelines</a>.</p>
<h2 id="bug-reports"><a class="header" href="#bug-reports">Bug Reports</a></h2>
<p>You can file issues on <a href="https://github.com/mozilla/application-services/issues">GitHub</a>. Please try to include as much information as you can and under what conditions
you saw the issue.</p>
<h2 id="building-the-project"><a class="header" href="#building-the-project">Building the project</a></h2>
<p>Build instructions are available in the <a href="#building-application-services"><code>building</code></a> page. Please let us know if you encounter any pain-points setting up your environment.</p>
<h2 id="finding-issues"><a class="header" href="#finding-issues">Finding issues</a></h2>
<p>Below are a few different queries you can use to find appropriate issues to work on. Feel free to reach out if you need any additional clarification before picking up an issue.</p>
<ul>
<li><strong><a href="https://github.com/mozilla/application-services/issues?q=is%3Aopen+is%3Aissue+label%3Agood-first-issue">good first issues</a></strong> -  If you are a new contributor, search for issues labeled <code>good-first-issue</code></li>
<li><strong><a href="https://github.com/mozilla/application-services/labels/good-second-issue">good second issues</a></strong> - Once you’ve got that first PR approved and you are looking for something a little more challenging, we are keeping a list of next-level issues. Search for the <code>good-second-issue</code> label.</li>
<li><strong><a href="https://github.com/mozilla/application-services/issues?utf8=%E2%9C%93&amp;q=is%3Aissue+is%3Aopen+%22Epic%3A+papercuts%22+">papercuts</a></strong> - A collection of smaller sized issues that may be a bit more advanced than a first or second issue.</li>
<li><strong><a href="https://github.com/mozilla/application-services/issues?utf8=%E2%9C%93&amp;q=is%3Aissue+is%3Aopen+%22Epic%3A+important+not+urgent%22">important, but not urgent</a></strong> - For more advanced contributors, we have a collection of issues that we consider important and would like to resolve sooner, but work isn’t currently prioritized by the core team.</li>
</ul>
<h2 id="sending-pull-requests"><a class="header" href="#sending-pull-requests">Sending Pull Requests</a></h2>
<p>Patches should be submitted as <a href="https://help.github.com/articles/about-pull-requests/">pull requests</a> (PRs).</p>
<blockquote>
<p>When submitting PRs, We expect external contributors to push patches to a <a href="https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks">fork</a> of <a href="https://github.com/mozilla/application-services"><code>application-services</code></a>. For more information about submitting PRs from forks, read <a href="https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork">GitHub’s guide</a>.</p>
</blockquote>
<p>Before submitting a PR:</p>
<ul>
<li>Your patch should include new tests that cover your changes, or be accompanied by explanation for why it doesn’t need any. It is your and your reviewer’s responsibility to ensure your patch includes adequate tests.
<ul>
<li>Consult the <a href="#guide-to-testing-a-rust-component">testing guide</a> for some tips on writing effective tests.</li>
</ul>
</li>
<li>Your code should pass all the automated tests before you submit your PR for review.
<ul>
<li>Before pushing your changes, run <code>./automation/tests.py changes</code>. The script will calculate which components were changed and run test suites, linters and formatters against those components. Because the script runs a limited set of tests, the script should execute in a fairly reasonable amount of time.</li>
</ul>
</li>
<li>Your patch should include a changelog entry in <a href="https://github.com/mozilla/application-services/blob/main/CHANGELOG.md">CHANGELOG.md</a> or an explanation of why
it does not need one. Any breaking changes to Swift or Kotlin binding APIs should be noted explicitly.</li>
<li>If your patch adds new dependencies, they must follow our <a href="#dependency-management-guidelines">dependency management guidelines</a>.
Please include a summary of the due diligence applied in selecting new dependencies.</li>
<li>After you open a PR, our Continuous Integration system will run a full test suite.  It’s possible that this step will result in errors not caught with the script so make sure to check the results.</li>
<li>“Work in progress” pull requests are welcome, but should be clearly labeled as such and should not be merged until all tests pass and the code has been reviewed.
<ul>
<li>You can label pull requests as “Work in progress” by using the Github PR UI to indicate this PR is a draft (<a href="https://docs.github.com/en/github/collaborating-with-issues-and-pull-requests/about-pull-requests#draft-pull-requests">learn more about draft PRs</a>).</li>
</ul>
</li>
</ul>
<p>When submitting a PR:</p>
<ul>
<li>You agree to license your code under the project’s open source license (<a href="https://github.com/mozilla/application-services/blob/main/LICENSE">MPL 2.0</a>).</li>
<li>Base your branch off the current <code>main</code> branch.</li>
<li>Add both your code and new tests if relevant.</li>
<li>Please do not include merge commits in pull requests; include only commits with the new relevant code.</li>
<li>We encourage you to <a href="https://help.github.com/articles/managing-commit-signature-verification">GPG sign your commits</a>.</li>
</ul>
<h2 id="code-review"><a class="header" href="#code-review">Code Review</a></h2>
<p>This project is production Mozilla code and subject to our <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Committing_Rules_and_Responsibilities">engineering practices and quality standards</a>. Every patch must be peer reviewed by a member of the Application Services team.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/contributing.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="building-application-services"><a class="header" href="#building-application-services">Building Application Services</a></h1>
<p>When working on Application Services, it’s important to set up your environment for building the Rust code and the Android or iOS code needed by the application.</p>
<h2 id="first-time-builds"><a class="header" href="#first-time-builds">First time builds</a></h2>
<p>Building for the first time is more complicated than a typical Rust project.
To build for an end-to-end experience that enables you to test changes in
client applications like <strong>Firefox for Android (Fenix)</strong> and <strong>Firefox iOS</strong>, there are a number of build
systems required for all the dependencies. The initial setup is likely to take
a number of hours to complete.</p>
<h2 id="building-the-rust-components"><a class="header" href="#building-the-rust-components">Building the Rust Components</a></h2>
<p><em>Complete this section before moving to the android/iOS build instructions.</em></p>
<ol>
<li>Make sure you cloned the repository:</li>
</ol>
<pre><code class="language-shell">  $ git clone https://github.com/mozilla/application-services # (or use the ssh link)
  $ cd application-services
  $ git submodule update --init --recursive
</code></pre>
<ol start="2">
<li>
<p>Install Rust: install <a href="https://www.rust-lang.org/tools/install">via rustup</a></p>
</li>
<li>
<p>Install your system dependencies:</p>
<h4 id="linux"><a class="header" href="#linux">Linux</a></h4>
<ol>
<li>
<p>Install the system dependencies required for building NSS</p>
<ol>
<li>Install gyp: <code>apt install gyp</code> (required for NSS)</li>
<li>Install ninja-build: <code>apt install ninja-build</code></li>
<li>Install python3 (at least 3.6): <code>apt install python3</code></li>
<li>Install zlib: <code>apt install zlib1g-dev</code></li>
<li>Install perl (needed to build openssl): <code>apt install perl</code></li>
<li>Install patch (to build the libs): <code>apt install patch</code></li>
</ol>
</li>
<li>
<p>Install the system dependencies required for SQLcipher</p>
<ol>
<li>Install tcl: <code>apt install tclsh</code> (required for SQLcipher)</li>
</ol>
</li>
<li>
<p>Install the system dependencies required for bindgen</p>
<ol>
<li>Install libclang: <code>apt install libclang-dev</code></li>
</ol>
</li>
</ol>
<h4 id="macos"><a class="header" href="#macos">MacOS</a></h4>
<ol>
<li>Install Xcode: check the <a href="https://github.com/mozilla/application-services/blob/main/.circleci/config.yml">ci config</a> for the correct version.</li>
<li>Install Xcode tools: <code>xcode-select --install</code></li>
<li>Install homebrew via its <a href="https://brew.sh/">installation instructions</a> (it’s what we use for ci).</li>
<li>Install the system dependencies required for building NSS:
<ol>
<li>Install ninja and python: <code>brew install ninja python</code></li>
<li>Make sure <code>which python3</code> maps to the freshly installed homebrew python.
<ol>
<li>If it isn’t, add the following to your bash/zsh profile and <code>source</code> the profile before continuing:
<pre><code class="language-shell">alias python3=$(brew --prefix)/bin/python3
</code></pre>
</li>
<li>Ensure <code>python</code> maps to the same Python version. You may have to
create a symlink:
<pre><code class="language-shell">PYPATH=$(which python3); ln -s $PYPATH `dirname $PYPATH`/python
</code></pre>
</li>
</ol>
</li>
<li>Install gyp:
<pre><code class="language-shell">wget https://bootstrap.pypa.io/ez_setup.py -O - | python3 -
git clone https://chromium.googlesource.com/external/gyp.git ~/tools/gyp
cd ~/tools/gyp
pip install .
</code></pre>
<ol>
<li>Add <code>~/tools/gyp</code> to your path:
<pre><code class="language-shell">export PATH="~/tools/gyp:$PATH"
</code></pre>
</li>
<li>If you have additional questions, consult <a href="https://github.com/mogemimi/pomdog/wiki/How-to-Install-GYP">this guide</a>.</li>
</ol>
</li>
<li>Make sure your homebrew python’s bin folder is on your path by updating your bash/zsh profile with the following:
<pre><code class="language-shell">export PATH="$PATH:$(brew --prefix)/opt/python@3.9/Frameworks/Python.framework/Versions/3.9/bin"
</code></pre>
</li>
</ol>
</li>
</ol>
<h4 id="windows"><a class="header" href="#windows">Windows</a></h4>
<p><em>Install windows build tools</em></p>
<blockquote>
<p>Why <a href="https://docs.microsoft.com/en-us/windows/wsl/about">Windows Subsystem for Linux (WSL)</a>?</p>
<p>It’s currently tricky to get some of these builds working on Windows, primarily due to our use of SQLcipher. By using WSL it is possible to get builds working, but still have them published to your “native” local maven cache so it’s available for use by a “native” Android Studio.</p>
</blockquote>
<ol>
<li>Install <a href="https://docs.microsoft.com/en-us/windows/wsl/about">WSL</a> (recommended over native tooling)</li>
<li>Install unzip: <code>sudo apt install unzip</code></li>
<li>Install python3: <code>sudo apt install python3</code> <em>Note: must be python 3.6 or later</em></li>
<li>Install system build tools: <code>sudo apt install build-essential</code></li>
<li>Install zlib: <code>sudo apt-get install zlib1g-dev</code></li>
<li>Install tcl: <code>sudo apt install tcl-dev</code></li>
</ol>
</li>
<li>
<p><a href="https://github.com/mozilla/application-services/blob/main/libs/README.md">Build the required NSS libraries</a>.</p>
</li>
<li>
<p>Check dependencies and environment variables by running: <code>./libs/verify-desktop-environment.sh</code></p>
</li>
</ol>
<blockquote>
<p>Note that this script might instruct you to set some environment variables, set those by adding them to your
<code>.zshrc</code> or <code>.bashrc</code> so they are set by default on your terminal. If it does so instruct you, you must
run the command again after setting them so the libraries are built.</p>
</blockquote>
<ol start="5">
<li>Run cargo test: <code>cargo test</code></li>
</ol>
<p>Once you have successfully run <code>./libs/verify-desktop-environment.sh</code> and <code>cargo test</code> you can move to the <a href="#building-for-fenix"><strong>Building for Fenix</strong></a> and <a href="#building-for-firefox-ios"><strong>Building for iOS</strong></a> sections below to setup your local environment for testing with our client applications.</p>
<hr>
<h2 id="building-for-fenix"><a class="header" href="#building-for-fenix">Building for Fenix</a></h2>
<p>The following instructions assume that you are building <code>application-services</code> for Fenix, and want to take advantage of the
<a href="#using-locally-published-components-in-fenix">Fenix Auto-publication workflow for android-components and application-services</a>.</p>
<ol>
<li>Install Android SDK, JAVA, NDK and set required env vars
<ol>
<li>Clone the <a href="https://github.com/mozilla-mobile/firefox-android">firefox-android</a> repository (<strong>not</strong> inside the Application Service repository).</li>
<li>Install <a href="https://www.oracle.com/java/technologies/downloads/#java17">Java <strong>17</strong></a> for your system</li>
<li>Set <code>JAVA_HOME</code> to point to the JDK 17 installation directory.</li>
<li>Download and install <a href="https://developer.android.com/studio/#downloads">Android Studio</a>.</li>
<li>Set <code>ANDROID_SDK_ROOT</code> and <code>ANDROID_HOME</code> to the Android Studio sdk location and add it to your rc file (either <code>.zshrc</code> or <code>.bashrc</code> depending on the shell you use for your terminal).</li>
<li>Configure the required versions of NDK
<code>Configure menu &gt; System Settings &gt; Android SDK &gt; SDK Tools &gt; NDK &gt; Show Package Details &gt; NDK (Side by side)</code>
<ul>
<li>29.0.14206865 (required by Application Services, <a href="https://github.com/mozilla/application-services/blob/main/build.gradle#L33">as configured</a>)</li>
</ul>
</li>
</ol>
</li>
<li>If you are on Windows using WSL - drop to the section below, <a href="#windows-setup-for-android-via-wsl">Windows setup
for Android (WSL)</a> before proceeding.</li>
<li>Check dependencies, environment variables
<ol>
<li>Run <code>./libs/verify-android-environment.sh</code></li>
<li>Follow instructions and rerun until it is successful.</li>
</ol>
</li>
</ol>
<h3 id="windows-setup-for-android-via-wsl"><a class="header" href="#windows-setup-for-android-via-wsl">Windows setup for Android (via WSL)</a></h3>
<p>Note: For non-Ubuntu linux versions, it may be necessary to execute <code>$ANDROID_HOME/tools/bin/sdkmanager "build-tools;26.0.2" "platform-tools" "platforms;android-26" "tools"</code>. See also <a href="https://gist.github.com/fdmnio/fd42caec2e5a7e93e12943376373b7d0">this gist</a> for additional information.</p>
<h4 id="configure-maven"><a class="header" href="#configure-maven">Configure Maven</a></h4>
<p>Configure maven to use the native windows maven repository - then, when doing <code>./gradlew install</code> from WSL, it ends up in the Windows maven repo. This means we can do a number of things with Android Studio in “native” windows and have then work correctly with stuff we built in WSL.</p>
<ol>
<li>Install maven: <code>sudo apt install maven</code></li>
<li>Confirm existence of (or create) a <code>~/.m2</code> folder</li>
<li>In the <code>~/.m2</code> create a file called <code>settings.xml</code></li>
<li>Add the content below replacing <code>{username}</code> with your username:</li>
</ol>
<pre><code class="language-xml">    &lt;settings&gt;
      &lt;localRepository&gt;/mnt/c/Users/{username}/.m2/repository&lt;/localRepository&gt;
    &lt;/settings&gt;
</code></pre>
<hr>
<h2 id="building-for-firefox-ios"><a class="header" href="#building-for-firefox-ios">Building for Firefox iOS</a></h2>
<ol>
<li>
<p>Install <a href="https://github.com/xcpretty/xcpretty#installation">xcpretty</a>: <code>gem install xcpretty</code></p>
</li>
<li>
<p>Run <code>./libs/verify-ios-environment.sh</code> to check your setup and environment
variables.</p>
<ul>
<li>Make any corrections recommended by the script and re-run.</li>
</ul>
</li>
<li>
<p>Run <code>./automation/build_ios_artifacts.sh</code> to build all the binaries, UniFFi bindings, Glean metrics generation</p>
<blockquote>
<p>Note: The artifacts generated in the above steps can then be used in any consuming product</p>
</blockquote>
</li>
</ol>
<h3 id="locally-building-firefox-ios-against-a-local-application-services"><a class="header" href="#locally-building-firefox-ios-against-a-local-application-services">Locally building Firefox iOS against a local Application Services</a></h3>
<p>Detailed steps to build Firefox iOS against a local application services can be found <a href="#how-to-locally-test-swift-package-manager-components-on-firefox-ios">this document</a></p>
<footer id="open-on-gh-1">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/building.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="using-locally-published-components-in-fenix"><a class="header" href="#using-locally-published-components-in-fenix">Using locally published components in Fenix</a></h1>
<p>It’s often important to test work-in-progress changes to Application Services components against a real-world
consumer project. The most reliable method of performing such testing is to publish your
components to a local Maven repository, and adjust the consuming project to install them
from there.</p>
<p>With support from the upstream project, it’s possible to do this in a single step using
our auto-publishing workflow.</p>
<h1 id="using-the-auto-publishing-workflow"><a class="header" href="#using-the-auto-publishing-workflow">Using the auto-publishing workflow</a></h1>
<p>mozilla-central has support for automatically publishing and including a local development version of application-services in the build.
This is supported for most of the Android targets available in mozilla-central including Fenix - this
doc will focus on Fenix, but the same general process is used for all. The workflow is:</p>
<h2 id="pre-requisites"><a class="header" href="#pre-requisites">Pre-requisites:</a></h2>
<ol>
<li>Ensure you have a regular <a href="#building-application-services">build of application-services working</a>.</li>
<li>Disable the gradle cache in mozilla-central - edit <code>./gradle.properties</code>, comment out <code>org.gradle.configuration-cache=true</code></li>
<li>Ensure you have a regular build of Fenix from mozilla-central testable in Android Studio or an emulator.</li>
</ol>
<h2 id="setup-2-x-localproperties"><a class="header" href="#setup-2-x-localproperties">Setup 2 x <code>local.properties</code></a></h2>
<p>Edit (or create) the file <code>local.properties</code> in each of the repos:</p>
<h3 id="app-services"><a class="header" href="#app-services">app-services</a></h3>
<p>In the root of the app-services repo:</p>
<p>Please be sure you have read <a href="#building-for-fenix">our guide to building Fenix</a> and successfully built
using the instructions there. In particular, this may lead you to adding <code>sdk.dir</code> and <code>ndk.dir</code> properties, and/or
set environment variables <code>ANDROID_SDK_ROOT</code> and <code>ANDROID_HOME</code>.</p>
<p>In addition to those instructions, you will need:</p>
<h4 id="rusttargets"><a class="header" href="#rusttargets">rust.targets</a></h4>
<p>Both the auto-publishing and manual workflows can be sped up significantly by
using the <code>rust.targets</code> property which limits which architectures the Rust
code gets build against.  Adding a line like
<code>rust.targets=x86,linux-x86-64</code>.  The trick is knowing which targets to put in
that comma separated list:</p>
<ul>
<li>Use <code>x86</code> for running the app on most emulators on Intel hardware (in rare cases, when you have a 64-bit emulator, you’ll want <code>x86_64</code>).</li>
<li>Use <code>arm64</code> for emulators running on Apple Silicon Macs.</li>
<li>If you’re running the <code>android-components</code> or <code>fenix</code> unit tests, then you’ll need the architecture of your machine:
<ul>
<li>OSX running Intel chips: <code>darwin-x86-64</code></li>
<li>OSX running M1 chips: <code>darwin-aarch64</code></li>
<li>Linux: <code>linux-x86-64</code></li>
</ul>
</li>
</ul>
<p>eg, on a Mac your <code>local.properties</code> file will have a single line, <code>rust.targets=darwin-aarch64,arm64</code></p>
<h3 id="mozilla-central"><a class="header" href="#mozilla-central">mozilla-central</a></h3>
<p><code>local.properties</code> can be in the root of the mozilla-central checkout,
or in the project specific directory (eg, <code>mobile/android/fenix</code>) and you tell it where to
find your local checkout of application-services by adding a line like:</p>
<p><code>autoPublish.application-services.dir=path/to/your/checkout/of/application-services</code></p>
<p>Note that the path can be absolute or relative from <code>local.properties</code>. For example, if <code>application-services</code>
and <code>mozilla-central</code> are at the same level, and you are using a <code>local.properties</code> in the root of mozilla-central,
the relative path would be <code>../application-services</code></p>
<h2 id="build-and-test-your-fenix-again"><a class="header" href="#build-and-test-your-fenix-again">Build and test your Fenix again.</a></h2>
<p>After configuring as described above, build and test your Fenix again.</p>
<p>If all goes well, this should automatically build your checkout of <code>application-services</code>, publish it
to a local maven repository, and configure the consuming project to install it from there instead of
from our published releases.</p>
<h1 id="other-notes"><a class="header" href="#other-notes">Other notes</a></h1>
<h3 id="using-windowswsl"><a class="header" href="#using-windowswsl">Using Windows/WSL</a></h3>
<p>Good luck! This implies you are also building mozilla-central in a Windows/WSL environment;
please contribute docs if you got this working.</p>
<p>However, there’s an excellent chance that you will need to execute
<code>./automation/publish_to_maven_local_if_modified.py</code> from your local <code>application-services</code> root.</p>
<h3 id="caveats"><a class="header" href="#caveats">Caveats</a></h3>
<ol>
<li>This assumes you are able to build both Fenix and application-services directly before following any of these instructions.</li>
<li>Make sure you’re fully up to date in all repos, unless you know you need to
not be.</li>
<li><a href="README.html#contact-us">Contact us</a> if you get stuck.</li>
</ol>
<footer id="open-on-gh-2">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/locally-published-components-in-fenix.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="how-to-locally-test-swift-package-manager-components-on-firefox-ios"><a class="header" href="#how-to-locally-test-swift-package-manager-components-on-firefox-ios">How to locally test Swift Package Manager components on Firefox iOS</a></h1>
<blockquote>
<p>This guide explains how to build and test <strong>Firefox iOS against a local Application Services</strong> checkout.
For background on our Swift Package approach, see the <a href="#distributing-swift-packages">ADR</a>.</p>
</blockquote>
<hr>
<h2 id="at-a-glance"><a class="header" href="#at-a-glance">At a glance</a></h2>
<p><strong>Goal:</strong> Build a local Firefox iOS against a local Application Services.</p>
<p><strong>Current workflow (recommended):</strong></p>
<ol>
<li>Build an <strong>XCFramework</strong> from your local <code>application-services</code>.</li>
<li>Point <strong>Firefox iOS’s local Swift package</strong> (<code>MozillaRustComponents/Package.swift</code>) at that artifact (either an HTTPS URL + checksum, <strong>or</strong> a local <code>path:</code>).</li>
<li>Update UniFFI generated swift source files.</li>
<li>Reset package caches in Xcode and build Firefox iOS.</li>
</ol>
<p>A legacy flow that uses the <strong><code>rust-components-swift</code></strong> package is documented at the end while we’re in mid-transition to the new system.</p>
<hr>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ol>
<li>A local checkout of <strong>Firefox iOS</strong> that builds: <a href="https://github.com/mozilla-mobile/firefox-ios#building-the-code">https://github.com/mozilla-mobile/firefox-ios#building-the-code</a></li>
<li>A local checkout of <strong>Application Services</strong> prepared for iOS builds: see <a href="#building-for-firefox-ios">Building for Firefox iOS</a></li>
</ol>
<hr>
<h2 id="step-1--build-all-artifacts-needed-from-application-services"><a class="header" href="#step-1--build-all-artifacts-needed-from-application-services">Step 1 — Build all artifacts needed from Application Services.</a></h2>
<p>This step builds an XCFramework and also generates swift sources for the components with UniFFI.</p>
<p>From the root of your <code>application-services</code> checkout, execute:</p>
<pre><code class="language-bash">./automation/build_ios_artifacts.sh
</code></pre>
<p>This produces:</p>
<ul>
<li><code>megazords/ios-rust/MozillaRustComponents.xcframework</code>, containing:</li>
<li>The compiled Rust code as a static library (for all iOS targets)</li>
<li>C headers and Swift module maps for the components</li>
<li><code>megazords/ios-rust/MozillaRustComponents.xcframework.zip</code>, which is a zip
of the above directory. By default, firefox-ios consumes the .zip file, although
as we discuss below, we will change firefox-ios to use the directory itself.</li>
<li><code>megazords/ios-rust/Sources/MozillaRustComponentsWrapper/Generated/*.swift</code>, which are
the source files generated by UniFFI.</li>
</ul>
<h2 id="step-2--point-firefox-ios-to-your-local-artifact"><a class="header" href="#step-2--point-firefox-ios-to-your-local-artifact">Step 2 — Point Firefox iOS to your local artifact</a></h2>
<p>Firefox iOS consumes Application Services via a local Swift package in-repo at:</p>
<pre><code>{path-to-firefox-ios}/MozillaRustComponents/Package.swift
</code></pre>
<p>update it as described below:</p>
<ol>
<li>Switch the binaryTarget to a local path - note however that the path can’t be absolute but must be relative to <code>Package.swift</code>.
For example, if you have <code>application-services</code> checked out next to the <code>firefox-ios</code> repo, a suitable relative path might be
<code>../../application-services/megazords/ios-rust/MozillaRustComponents.xcframework</code></li>
<li>Comment out or remove the <code>url</code> and <code>checksum</code> elements - they aren’t needed when pointing to a local path:</li>
</ol>
<pre><code class="language-swift">// In firefox-ios/MozillaRustComponents/Package.swift
.binaryTarget(
  name: "MozillaRustComponents",
  // ** Comment out the existing `url` and `checksum` entries
  // url: url,
  // checksum: checksum
  // ** Add a new `path` entry.
  path: "../../application-services/megazords/ios-rust/MozillaRustComponents.xcframework"
)
</code></pre>
<ol start="3">
<li>Update UniFFI generated files: manually copy <code>./megazords/ios-rust/Sources/MozillaRustComponentsWrapper/Generated/*.swift</code> from
your <code>application-services</code> directory to the existing <code>./MozillaRustComponents/Sources/MozillaRustComponentsWrapper/Generated/.</code>
directory in your <code>firefox-ios</code> checkout.</li>
</ol>
<p>for example, from the root of your application-services directory:</p>
<pre><code class="language-bash">cp ./megazords/ios-rust/Sources/MozillaRustComponentsWrapper/Generated/*.swift ../firefox-ios/MozillaRustComponents/Sources/MozillaRustComponentsWrapper/Generated/.
</code></pre>
<h2 id="step-3--reset-caches-and-build"><a class="header" href="#step-3--reset-caches-and-build">Step 3 — Reset caches and build</a></h2>
<p>In Xcode:</p>
<ul>
<li>File → Packages → Reset Package Caches</li>
<li>(If needed) File → Packages → Update to Latest Package Versions</li>
<li>Product → Clean Build Folder, then build and run Firefox iOS.</li>
</ul>
<p>If you still see stale artifacts (rare), delete:</p>
<pre><code class="language-swift">~/Library/Caches/org.swift.swiftpm
~/Library/Developer/Xcode/DerivedData/*
</code></pre>
<p>…and build again.</p>
<hr>
<h2 id="using-an-external-xcframework-artifact"><a class="header" href="#using-an-external-xcframework-artifact">Using an external XCFramework artifact.</a></h2>
<p>The instructions above all assume you have an XCFramework you built locally. However, it might be
the case where you want to use a <code>MozillaRustComponents.xcframework.zip</code> from an HTTPS-accessible URL
(e.g., a Taskcluster or GitHub artifact URL).</p>
<p>In this scenario, you also need the checksum of the zip file - this can be obtained by executing</p>
<pre><code class="language-bash">swift package compute-checksum megazords/ios-rust/MozillaRustComponents.xcframework.zip
</code></pre>
<p>However, that means you need to have the .zip file locally - in which case you might as well
unzip it and use the instructions above for consuming it from a local path!</p>
<p>But for completeness, once you have a https URL and the checksum you should
edit <code>MozillaRustComponents/Package.swift</code> and set the binaryTarget to the zip URL and checksum:</p>
<pre><code class="language-swift">// In firefox-ios/MozillaRustComponents/Package.swift
.binaryTarget(
  name: "MozillaRustComponents",
  url: "https://example.com/path/MozillaRustComponents.xcframework.zip",
  checksum: "&lt;sha256 from `swift package compute-checksum`&gt;"
)
</code></pre>
<blockquote>
<p>Note: Every time you produce a new zip, you must update the checksum.</p>
</blockquote>
<blockquote>
<p>Note: The above instructions do not handle copying updated files generated by UniFFI.
If you have changed the public API of any components, this process as written will not work.</p>
</blockquote>
<h2 id="disabling-local-development"><a class="header" href="#disabling-local-development">Disabling local development</a></h2>
<p>To revert quickly:</p>
<ol>
<li>Restore your changes to MozillaRustComponents/Package.swift (e.g., git checkout – MozillaRustComponents/Package.swift).</li>
<li>Reset Package Caches in Xcode.</li>
<li>Build Firefox iOS.</li>
</ol>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<ul>
<li>Old binary still in use: Reset caches and clear DerivedData, then rebuild.</li>
<li>Branch switches in application-services: Rebuild the XCFramework and update the package reference (URL/checksum or path:).</li>
<li>Checksum mismatch (URL mode): Run swift package compute-checksum on the new zip and update Package.swift.</li>
<li>Build script issues: Re-run ./build-xcframework.sh from megazords/ios-rust.</li>
</ul>
<h2 id="legacy-using-rust-components-swift-remote-package"><a class="header" href="#legacy-using-rust-components-swift-remote-package">Legacy: using rust-components-swift (remote package)</a></h2>
<p>[!WARNING]
Status: rust-components-swift is deprecated for Firefox iOS. Prefer the local package at MozillaRustComponents/ unless you must validate against the legacy package for a specific task.</p>
<p>Some teams may still need the legacy flow temporarily. Historically, Firefox iOS consumed Application Services through the rust-components-swift package. To test locally with that setup:</p>
<ol>
<li>Build the XCFramework from application-services.</li>
<li>In a local checkout of rust-components-swift, point its Package.swift to the local path of the unzipped XCFramework:
<pre><code class="language-swift">.binaryTarget(
name: "MozillaRustComponents",
path: "./MozillaRustComponents.xcframework"
)
</code></pre>
</li>
<li>Commit the changes in rust-components-swift (Xcode only reads committed package content).</li>
<li>In Firefox iOS, replace the package dependency with a local reference to your rust-components-swift checkout (e.g., via Xcode’s “Add Local…” in Package Dependencies).</li>
</ol>
<footer id="open-on-gh-3">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/locally-published-components-in-firefox-ios.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="how-to-locally-test-swift-package-manager-components-on-focus-ios"><a class="header" href="#how-to-locally-test-swift-package-manager-components-on-focus-ios">How to locally test Swift Package Manager components on Focus iOS</a></h1>
<blockquote>
<p>This is a guide on testing the Swift Package Manager component locally against a local build of Focus iOS. For more information on our Swift Package Manager design, read the <a href="#distributing-swift-packages">ADR that introduced it</a></p>
</blockquote>
<p><strong>NOTE</strong> - This guide is slightly out of date and needs to be updated. Better instructions can be found in the <a href="#how-to-locally-test-swift-package-manager-components-on-firefox-ios">instructions for Firefox</a>, but that process needs some Focus-specific tweaks.</p>
<blockquote>
<p>This guide assumes the component you want to test is already distributed with the <a href="https://github.com/mozilla/rust-components-swift"><code>rust-components-swift</code></a> repository, you can read <a href="#including-the-component-in-the-swift-package-manager-megazord">the guide for adding a new component</a> if you would like to distribute a new component.</p>
</blockquote>
<p>To test a component locally, you will need to do the following:</p>
<ol>
<li>Build an xcframework in a local checkout of <code>application-services</code></li>
<li>Include the xcframework in a local checkout of <code>rust-components-swift</code></li>
<li>Run the <code>make-tag</code> script in <code>rust-components-swift</code> using a local checkout of <code>application-services</code></li>
<li>Include the local checkout of <code>rust-components-swift</code> in <code>Focus</code></li>
</ol>
<p>Below are more detailed instructions for each step</p>
<h2 id="building-the-xcframework"><a class="header" href="#building-the-xcframework">Building the xcframework</a></h2>
<p>To build the <a href="https://developer.apple.com/documentation/swift_packages/distributing_binary_frameworks_as_swift_packages">xcframework</a> do the following:</p>
<ol>
<li>In a local checkout of <code>application-services</code>, navigate to <a href="https://github.com/mozilla/application-services/tree/main/megazords/ios-rust"><code>megazords/ios-rust/</code></a></li>
<li>Run the <code>build-xcframework.sh</code> script:</li>
</ol>
<pre><code class="language-bash">$ ./build-xcframework.sh --focus
</code></pre>
<p>This will produce a file name <code>FocusRustComponents.xcframework.zip</code> in the <code>focus</code> directory that contains the following, built for all our target iOS platforms.</p>
<ul>
<li>The compiled Rust code for all the crates listed in <code>Cargo.toml</code> as a static library</li>
<li>The C header files and <a href="https://clang.llvm.org/docs/Modules.html">Swift module maps</a> for the components</li>
</ul>
<h2 id="include-the-xcframework-in-a-local-checkout-of-rust-components-swift"><a class="header" href="#include-the-xcframework-in-a-local-checkout-of-rust-components-swift">Include the xcframework in a local checkout of <code>rust-components-swift</code></a></h2>
<p>After you generated the <code>FocusRustComponents.xcframework.zip</code> in the previous step, do the following to include it in a local checkout of <code>rust-components-swift</code>:</p>
<ol>
<li>clone a local checkout of <code>rust-components-swift</code>, <strong>not</strong> inside the <code>application-services</code> repository:
<pre><code class="language-sh">git clone https://github.com/mozilla/rust-components.swift.git
</code></pre>
</li>
<li>Unzip the <code>FocusRustComponents.xcframework.zip</code> into the <code>rust-components-swift</code> repository: (Assuming you are in the root of the <code>rust-components-swift</code> directory and <code>application-services</code> is a neighbor directory)
<pre><code class="language-sh"> unzip -o ../application-services/megazords/ios-rust/focus/FocusRustComponents.xcframework.zip -d .
</code></pre>
</li>
<li>Change the <code>Package.swift</code>’s reference to the xcframework to point to the unzipped <code>FocusRustComponents.xcframework</code> that was created in the previous step. You can do this by uncommenting the following line:
<pre><code class="language-swift">    path: "./FocusRustComponents.xcframework"
</code></pre>
and commenting out the following lines:
<pre><code class="language-swift">    url: focusUrl,
    checksum: focusChecksum,
</code></pre>
</li>
</ol>
<h2 id="run-the-generation-script-with-a-local-checkout-of-application-services"><a class="header" href="#run-the-generation-script-with-a-local-checkout-of-application-services">Run the generation script with a local checkout of application services</a></h2>
<p>For this step, run the following script from inside the <code>rust-components-swift</code> repository (assuming that <code>application-services</code> is a neighboring directory to <code>rust-components-swift</code>).</p>
<pre><code class="language-sh">./generate.sh ../application-services
</code></pre>
<p>Once that is done, <strong>stage and commit</strong> the changes the script ran. Xcode can only pick up committed changes.</p>
<h2 id="include-the-local-checkout-of-rust-components-swift-in-focus"><a class="header" href="#include-the-local-checkout-of-rust-components-swift-in-focus">Include the local checkout of <code>rust-components-swift</code> in <code>Focus</code></a></h2>
<p>This is the final step to include your local changes into <code>Focus</code>. Do the following steps:</p>
<ol>
<li>
<p>Clone a local checkout of <code>Focus</code> if you haven’t already. Make sure you also install the project dependencies, more information in their <a href="https://github.com/mozilla-mobile/focus-ios#build-instructions">build instructions</a></p>
</li>
<li>
<p>Open <code>Blockzilla.xcodeproj</code> in Xcode</p>
</li>
<li>
<p>Navigate to the Swift Packages in Xcode:
<img src="howtos/img/xcode-blockzilla.png" alt="Screenshot of where to find the setting for Blockzilla">
<img src="howtos/img/xcode-package-deps.png" alt="Screenshot of where to find the package dependencies"></p>
</li>
<li>
<p>Remove the dependency on <code>rust-components-swift</code> as listed on Xcode, you can click the dependency then click the <code>-</code></p>
</li>
<li>
<p>Add a new swift package by clicking the <code>+</code>:</p>
<ol>
<li>On the top right, enter the full path to your <code>rust-components-swift</code> checkout, preceded by <code>file://</code>. If you don’t know what that is, run <code>pwd</code> in while in <code>rust-components-swift</code>. For example: <code>file:///Users/tarikeshaq/code/rust-components-swift</code></li>
<li>Change the branch to be the checked-out branch of rust-component-swift you have locally. This is what the dialog should look like:
<img src="howtos/img/xcode-include-packages-focus-ios.png" alt="Dialog for including the rust-components-swift package"></li>
<li>Click <code>Add Package</code></li>
<li>Now include the <code>FocusAppServices</code> library.</li>
</ol>
<blockquote>
<p>Note: If Xcode prevents you from adding the dependency to reference a local package, you will need to manually modify the <code>Blockzilla.xcodeproj/project.pbxproj</code> and replace every occurrence of <code>https://github.com/mozilla/rust-components-swift</code> with the full path to your local checkout.</p>
</blockquote>
</li>
<li>
<p>Finally, attempt to build focus, and if all goes well it should launch  with your code. If you face any problems, feel free to <a href="#contact-us">contact us</a></p>
</li>
</ol>
<footer id="open-on-gh-4">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/locally-published-components-in-focus-ios.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="building-and-using-a-locally-modified-version-of-jna"><a class="header" href="#building-and-using-a-locally-modified-version-of-jna">Building and using a locally-modified version of JNA</a></h1>
<p><a href="https://github.com/java-native-access/jna/">Java Native Access</a> is an important dependency
for the Application Services components on Android, as it provides the low-level interface
from the JVM into the natively-compiled Rust code.</p>
<p>If you need to work with a locally-modified version of JNA (e.g. to investigate an apparent
JNA bug) then you may find these notes helpful.</p>
<hr>
<p>The JNA docs do have an <a href="https://github.com/java-native-access/jna/blob/master/www/AndroidDevelopmentEnvironment.md">Android Development Environment guide</a>
that is a good starting point, but the instructions did not work for me and appear a little out of date.
Here are the steps that worked for me:</p>
<ul>
<li>
<p>Modify your environment to specify <code>$NDK_PLATFORM</code>, and to ensure the Android NDK tools
for each target platform are in your <code>$PATH</code>. On my Mac with Android Studio the
config was as follows:</p>
<pre><code>export NDK_ROOT="$HOME/Library/Android/sdk/ndk/28.2.13676358"
export NDK_PLATFORM="$NDK_ROOT/platforms/android-25"
export PATH="$PATH:$NDK_ROOT/toolchains/llvm/prebuilt/darwin-x86_64/bin"
export PATH="$PATH:$NDK_ROOT/toolchains/aarch64-linux-android-4.9/prebuilt/darwin-x86_64/bin"
export PATH="$PATH:$NDK_ROOT/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin"
export PATH="$PATH:$NDK_ROOT/toolchains/x86-4.9/prebuilt/darwin-x86_64/bin"
export PATH="$PATH:$NDK_ROOT/toolchains/x86_64-4.9/prebuilt/darwin-x86_64/bin"
</code></pre>
<p>You will probably need to tweak the paths and version numbers based on your operating system and
the details of how you installed the Android NDK.</p>
</li>
<li>
<p>Install the <code>ant</code> build tool (using <code>brew install ant</code> worked for me).</p>
</li>
<li>
<p>Checkout the <a href="https://github.com/java-native-access/jna">JNA source</a> from Github. Try doing a basic
build via <code>ant dist</code> and <code>ant test</code>. This won’t build for Android but will test the rest of the tooling.</p>
</li>
<li>
<p>Adjust <code>./native/Makefile</code> for compatibility with your Android NSK install. Here’s what I had to do for mine:</p>
<ul>
<li>Adjust the <code>$CC</code> variable to use clang instead of gcc: <code>CC=aarch64-linux-android21-clang</code>.</li>
<li>Adjust thd <code>$CCP</code> variable to use the version from your system: <code>CPP=cpp</code>.</li>
<li>Add <code>-landroid -llog</code> to the list of libraries to link against in <code>$LIBS</code>.</li>
</ul>
</li>
<li>
<p>Build the JNA native libraries for the target platforms of interest:</p>
<ul>
<li><code>ant -Dos.prefix=android-aarch64</code></li>
<li><code>ant -Dos.prefix=android-armv7</code></li>
<li><code>ant -Dos.prefix=android-x86-64</code></li>
</ul>
</li>
<li>
<p>Package the newly-built native libraries into a JAR/AAR using <code>ant dist</code>.
This should produce <code>./dist/jna.aar</code>.</p>
</li>
<li>
<p>Configure <code>build.gradle</code> for the consuming application to use the locally-built JNA artifact:</p>
<pre><code>// Tell gradle where to look for local artifacts.
repositories {
    flatDir {
        dirs "/PATH/TO/YOUR/CHECKOUT/OF/jna/dist"
    }
}

// Tell gradle to exclude the published version of JNA.
configurations {
    implementation {
        exclude group: "net.java.dev.jna", module:"jna"
    }
}

// Take a direct dependency on the local JNA AAR.
dependencies {
    implementation name: "jna", ext: "aar"
}
</code></pre>
</li>
<li>
<p>Rebuild and run your consuming application, and it should be using the locally-built JNA!</p>
</li>
</ul>
<p>If you’re trying to debug some unexpected JNA behaviour (and if you favour old-school printf-style debugging)
then you can this code snippet to print to the Android log from the compiled native code:</p>
<pre><code>#ifdef __ANDROID__
#include &lt;android/log.h&gt;
#define HACKY_ANDROID_LOG(...) __android_log_print(ANDROID_LOG_VERBOSE, "HACKY-DEBUGGING-FOR-ALL", __VA_ARGS__)
#else
#define HACKY_ANDROID_LOG(MSG)
#endif

HACKY_ANDROID_LOG("this will go to the android logcat output");
HACKY_ANDROID_LOG("it accepts printf-style format sequences, like this: %d", 42);
</code></pre>
<footer id="open-on-gh-5">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/locally-building-jna.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="branch-builds"><a class="header" href="#branch-builds">Branch builds</a></h1>
<p>Branch builds are a way to build and test Fenix using branches from <code>application-services</code> and <code>firefox-android</code>.
iOS is not currently supported, although we may add it in the future (see <a href="https://github.com/mozilla/application-services/issues/4966">#4966</a>).</p>
<h2 id="application-services-nightlies"><a class="header" href="#application-services-nightlies">Application-services nightlies</a></h2>
<p>When we make non-breaking changes, we typically merge them into main and let them sit there until the next release. In
order to check that the current main really does only have non-breaking changes, we run a nightly branch build from the
<code>main</code> branch of <code>application-services</code>,</p>
<ul>
<li>To view the latest branch builds:
<ul>
<li>Open the <a href="https://firefox-ci-tc.services.mozilla.com/tasks/index/project.application-services.v2.branch.main.latest.taskgraph/decision-nightly">latest decision task</a> from the task index.</li>
<li>Click the “View Task” link</li>
<li>Click “Task Group” in the top-left</li>
<li>You should now see a list of tasks from the latest nightly
<ul>
<li><code>*-build</code> were for building the application.  A failure here indicates there’s probably a breaking change that
needs to be resolved.</li>
<li>To get the APK, navigate to <code>branch-build-fenix-build</code> and download <code>app-x86-debug.apk</code> from the artifacts list</li>
<li><code>branch-build-ac-test.*</code> are the android-components tests tasks.  These are split up by gradle project, which matches
how the android-components CI handles things.  Running all the tests together often leads to failures.</li>
<li><code>branch-build-fenix-test</code> is the Fenix tests.  These are not split up per-project.</li>
</ul>
</li>
</ul>
</li>
<li>These builds are triggered by our <a href="https://github.com/mozilla/application-services/blob/main/.cron.yml">.cron.yml</a> file</li>
</ul>
<footer id="open-on-gh-6">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/branch-builds.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="guide-to-testing-a-rust-component"><a class="header" href="#guide-to-testing-a-rust-component">Guide to Testing a Rust Component</a></h1>
<p>This document gives a high-level overview of how we test components in <code>application-services</code>.
It will be useful to you if you’re adding a new component, or working on increasing the test
coverage of an existing component.</p>
<p>If you are only interested in running the existing test suite, please consult the
<a href="#contributing-to-application-services">contributor docs</a> and the <a href="https://github.com/mozilla/application-services/blob/main/automation/tests.py">tests.py</a> script.</p>
<h2 id="unit-and-functional-tests"><a class="header" href="#unit-and-functional-tests">Unit and Functional Tests</a></h2>
<h3 id="rust-code"><a class="header" href="#rust-code">Rust code</a></h3>
<p>Since the core implementations of our components live in rust, so does the core of our testing strategy.</p>
<p>Each rust component should be accompanied by a suite of unit tests, following the <a href="https://doc.rust-lang.org/book/ch11-00-testing.html">guidelines for writing
tests</a> from the <a href="https://doc.rust-lang.org/book/title-page.html">Rust
Book</a>.
Some additional tips:</p>
<ul>
<li>
<p>Where possible, it’s better use use the Rust typesystem to make bugs impossible than to write
tests to assert that they don’t occur in practice. But given that the ultimate consumers of our
code are not in Rust, that’s sometimes not possible. The best idiomatic Rust API for a feature
is not necessarily the best API for consuming it over an FFI boundary.</p>
</li>
<li>
<p>Rust’s builtin assertion macros are sparse; we use the <a href="https://crates.io/crates/more_asserts">more_asserts</a>
for some additional helpers.</p>
</li>
<li>
<p>Rust’s strict typing can make test mocks difficult. If there’s something you need to mock out in tests,
make it a Trait and use the <a href="https://crates.io/crates/mockiato">mockiato</a> crate to mock it.</p>
</li>
</ul>
<p>The Rust tests for a component should be runnable via <code>cargo test</code>.</p>
<h3 id="ffi-layer-code"><a class="header" href="#ffi-layer-code">FFI Layer code</a></h3>
<p>We are currently using <a href="howtos/converting-a-component-to-uniffi.html"><code>uniffi</code></a> to generate most ((and soon all!) of our FFI code and thus the FFI code itself does not need to be extensively tested.</p>
<h3 id="kotlin-code"><a class="header" href="#kotlin-code">Kotlin code</a></h3>
<p>The Kotlin wrapper code for a component should have its own test suite, which should follow the general guidelines for
<a href="https://github.com/mozilla-mobile/shared-docs/blob/main/android/testing.md#jvm-testing">testing Android code in Mozilla projects</a>.
In practice that means we use
<a href="https://github.com/mozilla-mobile/shared-docs/blob/main/android/testing.md#junit-testing-framework">JUnit</a>
as the test framework and
<a href="https://github.com/mozilla-mobile/shared-docs/blob/main/android/testing.md#robolectric-android-api-shadows">Robolectric</a>
to provide implementations of Android-specific APIs.</p>
<p>The Kotlin tests for a component should be runnable via <code>./gradlew &lt;component&gt;:test</code>.</p>
<p>The tests at this layer are designed to ensure that the API binding code is working as intended,
and should not repeat tests for functionality that is already well tested at the Rust level.
But given that the Kotlin bindings involve a non-trivial amount of hand-written boilerplate code,
it’s important to exercise that code thoroughly.</p>
<p>One complication with running Kotlin tests is that the code needs to run on your local development machine,
but the Kotlin code’s native dependencies are typically compiled and packaged for Android devices. The
tests need to ensure that an appropriate version of JNA and of the compiled Rust code is available in
their library search path at runtime. Our <code>build.gradle</code> files contain a collection of hackery that ensures
this, which should be copied into any new components.</p>
<p>The majority of our Kotlin bindings are autogenerated using <a href="howtos/converting-a-component-to-uniffi.html"><code>uniffi</code></a> and do not need extensive testing.</p>
<h3 id="swift-code"><a class="header" href="#swift-code">Swift code</a></h3>
<p>The Swift wrapper code for a component should have its own test suite, using Apple’s
<a href="https://developer.apple.com/documentation/xctest">Xcode unittest framework</a>.</p>
<p>Due to the way that all rust components need to be compiled together into a single <a href="#megazording">“megazord”</a>
framework, this entire repository is a single Xcode project. The Swift tests for each component
thus need to live under <code>megazords/ios-rust/MozillaTestServicesTests/</code> rather than in the directory
for the corresponding component. (XXX TODO: is this true? it would be nice to find a way to avoid having
them live separately because it makes them easy to overlook).</p>
<p>The tests at this layer are designed to ensure that the API binding code is working as intended,
and should not repeat tests for functionality that is already well tested at the Rust level.
But given that the Swift bindings involve a non-trivial amount of hand-written boilerplate code,
it’s important to exercise that code thoroughly.</p>
<p>The majority of our Swift bindings are autogenerated using <a href="howtos/converting-a-component-to-uniffi.html"><code>uniffi</code></a> and do not need extensive testing.</p>
<h2 id="integration-tests"><a class="header" href="#integration-tests">Integration tests</a></h2>
<h3 id="end-to-end-sync-tests"><a class="header" href="#end-to-end-sync-tests">End-to-end Sync Tests</a></h3>
<h4 id="-those-tests-were-disabled-because-of-how-flakey-the-stage-server-was-see-3909-"><a class="header" href="#-those-tests-were-disabled-because-of-how-flakey-the-stage-server-was-see-3909-">⚠️ Those tests were disabled because of how flakey the stage server was. See <a href="https://github.com/mozilla/application-services/issues/3909">#3909</a> ⚠️</a></h4>
<p>The <a href="https://github.com/mozilla/application-services/tree/main/testing/sync-test"><code>testing/sync-test</code></a> directory contains a test harness for running sync-related
Rust components against a live Firefox Sync infrastructure, so that we can verifying the functionality
end-to-end.</p>
<p>Each component that implements a sync engine should have a corresponding suite of tests in this directory.</p>
<ul>
<li>XXX TODO: places doesn’t.</li>
<li>XXX TODO: send-tab doesn’t (not technically a sync engine, but still, it’s related)</li>
<li>XXX TODO: sync-manager doesn’t</li>
</ul>
<h3 id="android-components-test-suite"><a class="header" href="#android-components-test-suite">Android Components Test Suite</a></h3>
<p>It’s important that changes in <code>application-services</code> are tested against upstream consumer code in the
<a href="https://github.com/mozilla-mobile/android-components/">android-components</a> repo. This is currently
a manual process involving:</p>
<ul>
<li>Configuring your local checkout of android-components to <a href="#using-locally-published-components-in-fenix">use your local application-services
build</a>.</li>
<li>Running the android-components test suite via <code>./gradle test</code>.</li>
<li>Manually building and running the android-components sample apps to verify that they’re still working.</li>
</ul>
<p>Ideally some or all of this would be automated and run in CI, but we have not yet invested in such automation.</p>
<h2 id="ideas-for-improvement"><a class="header" href="#ideas-for-improvement">Ideas for Improvement</a></h2>
<ul>
<li>ASan, Memsan, and maybe other sanitizer checks, especially around the points where we cross FFI boundaries.</li>
<li>General-purpose fuzzing, such as via https://github.com/jakubadamw/arbitrary-model-tests</li>
<li>We could consider making a mocking backend for viaduct, which would also be mockable from Kotlin/Swift.</li>
<li>Add more end-to-end integration tests!</li>
<li>Live device tests, e.g. actual Fenixes running in an emulator and syncing to each other.</li>
<li>Run consumer integration tests in CI against main.</li>
</ul>
<footer id="open-on-gh-7">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/testing-a-rust-component.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="smoke-testing-application-services-against-end-user-apps"><a class="header" href="#smoke-testing-application-services-against-end-user-apps">Smoke testing Application Services against end-user apps</a></h1>
<p>This is a great way of finding integration bugs with <code>application-services</code>.
The testing can be done manually using substitution scripts, but we also have scripts that will do the smoke-testing for you.</p>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>Run <code>pip3 install -r automation/requirements.txt</code> to install the required Python packages.</p>
<h2 id="android-components"><a class="header" href="#android-components">Android Components</a></h2>
<p>The <code>automation/smoke-test-android-components.py</code> script will clone (or use a local version) of
android-components and run a subset of its tests against the current <code>application-services</code> worktree.
It tries to only run tests that might be relevant to <code>application-services</code> functionality.</p>
<h2 id="fenix"><a class="header" href="#fenix">Fenix</a></h2>
<p>The <code>automation/smoke-test-fenix.py</code> script will clone (or use a local version) of Fenix and
run tests against the current <code>application-services</code> worktree.</p>
<h2 id="firefox-ios"><a class="header" href="#firefox-ios">Firefox iOS</a></h2>
<p>The <code>automation/smoke-test-fxios.py</code> script will clone (or use a local version) of Firefox iOS and
run tests against the current <code>application-services</code> worktree.</p>
<footer id="open-on-gh-8">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/smoke-testing-app-services.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="testing-faster-how-to-avoid-making-compile-times-worse-by-adding-tests"><a class="header" href="#testing-faster-how-to-avoid-making-compile-times-worse-by-adding-tests">Testing faster: How to avoid making compile times worse by adding tests</a></h1>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>We’d like to keep <code>cargo test</code>, <code>cargo build</code>, <code>cargo check</code>, … reasonably
fast, and we’d <em>really</em> like to keep them fast if you pass <code>-p</code> for a specific
project. Unfortunately, there are a few ways this can become unexpectedly slow.
The easiest of these problems for us to combat at the moment is the unfortunate
placement of dev-dependencies in our build graph.</p>
<p>If you perform a <code>cargo test -p foo</code>, all dev-dependencies of <code>foo</code> must be
compiled before <code>foo</code>’s tests can start. This includes dependencies only used
non-test targets, such as examples or benchmarks.</p>
<p>In an ideal world, cargo could run your tests as soon as it finished with the
dependencies it needs for those tests, instead of waiting for your benchmark
suite, or the arg-parser your examples use, or etc.</p>
<p>Unfortunately, all cargo knows is that these are <code>dev-dependencies</code>, and not
which targets actually use them.</p>
<p>Additionally, unqualified invocations of cargo (that is, without <code>-p</code>) might
have an even worse time if we aren’t careful. If I run, <code>cargo test</code>, cargo
knows <em>every</em> crate in the workspace needs to be built with all dev
dependencies, if <code>places</code> depends on <code>fxa-client</code>, all of <code>fxa-clients</code>
dev-dependencies must be compiled, ready, and linked in at least to the <code>lib</code>
target before we can even think about starting on <code>places</code>.</p>
<p>We have not been careful about what shape the dependency graph ends up as when example code is
taken into consideration (as it is by cargo during certain builds), and as a
result, we have this problem. Which isn’t really a problem we
want to fix: Example code can and should depend on several different components,
and use them together in interesting ways.</p>
<p>So, because we don’t want to change what our examples do, or make
major architectural changes of the non-test code for something like this, we
need to do something else.</p>
<h2 id="the-solution"><a class="header" href="#the-solution">The Solution</a></h2>
<p>To fix this, we manually insert “cuts” into the dependency graph to help cargo
out. That is, we pull some of these build targets (e.g. examples, benchmarks,
tests if they cause a substantial compile overhead) into their own dedicated
crates so that:</p>
<ol>
<li>They can be built in parallel with each other.</li>
<li>Crates depending on the component itself are not waiting on the
test/bench/example build in order for their test build to begin.</li>
<li>A potentially smaller set of our crates need to be rebuilt – and a smaller
set of possible configurations exist meaning fewer items to add pressure to
caches.</li>
<li>…</li>
</ol>
<p>Some rules of thumb for when / when not to do this:</p>
<ul>
<li>
<p>All rust examples should be put in <code>examples/*</code>.</p>
</li>
<li>
<p>All rust benchmarks should be put in <code>testing/separated/*</code>. See the section
below on how to set your benchmark up to avoid redundant compiles.</p>
</li>
<li>
<p>Rust tests which brings in heavyweight dependencies should be evaluated on an
ad-hoc basis. If you’re concerned, measure how long compilation takes
with/without, and consider how many crates depend on the crate where the test
lives (e.g. a slow test in support/foo might be far worse than one in a leaf
crate), etc…</p>
</li>
</ul>
<h3 id="appendix-how-to-avoid-redundant-compiles-for-benchmarks-and-integration-tests"><a class="header" href="#appendix-how-to-avoid-redundant-compiles-for-benchmarks-and-integration-tests">Appendix: How to avoid redundant compiles for benchmarks and integration tests</a></h3>
<p>To be clear, this is way more important for benchmarks (which always compile as
release and have a costly link phase).</p>
<p>Say you have a directory structure like the following:</p>
<pre><code>mycrate
 ├── src
 │   └── lib.rs
 | ...
 ├── benches
 │   ├── bench0.rs
 |   ├── bench1.rs
 │   └── bench2.rs
 ├── tests
 │   ├── test0.rs
 |   ├── test1.rs
 │   └── test2.rs
 └── ...
</code></pre>
<p>When you run your integration tests or benchmarks, each of <code>test0</code>, <code>test1</code>,
<code>test2</code> or <code>bench0</code>, <code>bench1</code>, <code>bench2</code> is compiled as it’s own crate that runs
the tests in question and exits.</p>
<p>That means 3 benchmark executables are built on release settings, and 3
integration test executables.</p>
<p>If you’ve ever tried to add a piece of shared utility code into your integration
tests, only to have cargo (falsely) complain that it is dead code: this is why.
Even if <code>test0.rs</code> and <code>test2.rs</code> <em>both</em> use the utility function, unless
<em>every</em> test crate uses <em>every</em> shared utility, the crate that doesn’t will
complain.</p>
<p>(Aside: This turns out to be an unintentional secondary benefit of this approach
– easier shared code among tests, without having to put a
<code>#![allow(dead_code)]</code> in your utils.rs. We haven’t hit that very much here,
since we tend to stick to unit tests, but it came up in mentat several times,
and is a frequent complaint people have)</p>
<p>Anyway, the solution here is simple: Create a new crate. If you were working in
<code>components/mycrate</code> and you want to add some integration tests or benchmarks,
you should do <code>cargo new --lib testing/separated/mycrate-test</code> (or
<code>.../mycrate-bench</code>).</p>
<p>Delete <code>.../mycrate-test/src/lib.rs</code>. Yep, really, we’re making a crate that
only has integration tests/benchmarks (See the “FAQ0” section at the bottom of
the file if you’re getting incredulous).</p>
<p>Now, add a <code>src/tests.rs</code> or a <code>src/benches.rs</code>. This file should contain <code>mod foo;</code> declarations for each submodule containing tests/benchmarks, if any.</p>
<p>For benches, this is also where you set up the benchmark harness (refer to
benchmark library docs for how).</p>
<p>Now, for a test, add: into your Cargo.toml</p>
<pre><code class="language-toml">[[test]]
name = "mycrate-test"
path = "src/tests.rs"
</code></pre>
<p>and for a benchmark, add:</p>
<pre><code class="language-toml">[[bench]]
name = "mycrate-benches"
path = "src/benches.rs"
harness = false
</code></pre>
<p>Because we aren’t using <code>src/lib.rs</code>, this is what declares which file is the
root of the test/benchmark crate. Because there’s only one target (unlike with
<code>tests/*</code> / <code>benches/*</code> under default settings), this will compile more quickly.</p>
<p>Additionally, <code>src/tests.rs</code> and <code>src/benches.rs</code> will behave like a normal
crate, the only difference being that they don’t produce a lib, and that they’re
triggered by <code>cargo test</code>/<code>cargo run</code> respectively.</p>
<h3 id="faq0-why-put-testsbenches-in-src-instead-of-disabling-autotestsautobenches"><a class="header" href="#faq0-why-put-testsbenches-in-src-instead-of-disabling-autotestsautobenches">FAQ0: Why put tests/benches in <code>src/*</code> instead of disabling <code>autotests</code>/<code>autobenches</code></a></h3>
<p>Instead of putting tests/benchmarks inside <code>src</code>, we could just delete the <code>src</code>
dir outright, and place everything in <code>tests</code>/<code>benches</code>.</p>
<p>Then, to get the same one-rebuild-per-file behavior that we’ll get in <code>src</code>, we
need to add <code>autotests = false</code> or <code>autobenches = false</code> to our Cargo.toml,
adding a root <code>tests/tests.rs</code> (or <code>benches/benches.rs</code>) containing <code>mod</code> decls
for all submodules, and finally by referencing that “root” in the Cargo.toml
<code>[[tests]]</code> / <code>[[benches]]</code> list, exactly the same way we did for using <code>src/*</code>.</p>
<p>This would work, and on the surface, using <code>tests/*.rs</code> and <code>benches/*.rs</code> seems
more consistent, so it seems weird to use <code>src/*.rs</code> for these files.</p>
<p>My reasoning is as follows: Almost universally, <code>tests/*.rs</code>, <code>examples/*.rs</code>,
<code>benches/*.rs</code>, etc. are automatic. If you add a test into the tests folder, it
will run without anything else.</p>
<p>If we’re going to set up one-build-per-{test,bench}suite as I described, this
fundamentally cannot be true. In this paradigm, if you add a test file named
<code>blah.rs</code>, you must add a <code>mod blah</code> it to the parent module.</p>
<p>It seems both confusing and error-prone to use <code>tests/*</code>, but have it behave
that way, however this is absolutely the normal behavior for files in <code>src/*.rs</code>
– When you add a file, you then need to add it to it’s parent module, and this
is something Rust programmers are pretty used to.</p>
<p>(In fact, we even replicated this behavior (for no reason) in the places
integration tests, and added the <code>mod</code> declarations to a “controlling” parent
module – It seems weird to be in an environment where this <em>isn’t</em> required)</p>
<p>So, that’s why. This way, we make it <em>way</em> less likely that you add a test file
to some directory, and have it get ignored because you didn’t realize that in
this one folder, you need to add a <code>mod mytest</code> into a neighboring tests.rs.</p>
<footer id="open-on-gh-9">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/test-faster.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="debugging-sql"><a class="header" href="#debugging-sql">Debugging Sql</a></h1>
<p>It can be quite tricky to debug what is going on with sql statement, especially
once the sql gets complicated or many triggers are involved.</p>
<p>The <code>sql_support</code> create provides some utilities to help. Note that
these utilities are gated behind a <code>debug-tools</code> feature. <a href="https://mozilla.github.io/application-services/book/rust-docs/sql_support/debug_tools/index.html">The module
provides docstrings, so you should read them before you start</a>.</p>
<p>This document describes how to use these capabilities and we’ll use <code>places</code>
as an example.</p>
<p>First, we must enable the feature:</p>
<pre><code class="language-diff">--- a/components/places/Cargo.toml
+++ b/components/places/Cargo.toml
@@ -22,7 +22,7 @@ lazy_static = "1.4"
 url = { version = "2.1", features = ["serde"] }
 percent-encoding = "2.1"
 caseless = "0.2"
-sql-support = { path = "../support/sql" }
+sql-support = { path = "../support/sql", features=["debug-tools"] }
</code></pre>
<p>and we probably need to make the debug functions available:</p>
<pre><code class="language-diff">--- a/components/places/src/db/db.rs
+++ b/components/places/src/db/db.rs
@@ -108,6 +108,7 @@ impl ConnectionInitializer for PlacesInitializer {
         ";
         conn.execute_batch(initial_pragmas)?;
         define_functions(conn, self.api_id)?;
+        sql_support::debug_tools::define_debug_functions(conn)?;
</code></pre>
<p>We now have a Rust function <code>print_query()</code> and a SQL function <code>dbg()</code> available.</p>
<p>Let’s say we were trying to debug a test such as <code>test_bookmark_tombstone_auto_created</code>.
We might want to print the entire contents of a table, then instrument a query to check
what the value of a query is. We might end up with a patch something like:</p>
<pre><code class="language-diff">index 28f19307..225dccbb 100644
--- a/components/places/src/db/schema.rs
+++ b/components/places/src/db/schema.rs
@@ -666,7 +666,8 @@ mod tests {
             [],
         )
         .expect("should insert regular bookmark folder");
-        conn.execute("DELETE FROM moz_bookmarks WHERE guid = 'bookmarkguid'", [])
+        sql_support::debug_tools::print_query(&amp;conn, "select * from moz_bookmarks").unwrap();
+        conn.execute("DELETE FROM moz_bookmarks WHERE dbg('CHECKING GUID', guid) = 'bookmarkguid'", [])
             .expect("should delete");
         // should have a tombstone.
         assert_eq!(
</code></pre>
<p>There are 2 things of note:</p>
<ul>
<li>We used the <code>print_query</code> function to dump the entire <code>moz_bookmarks</code> table before executing the query.</li>
<li>We instrumented the query to print the <code>guid</code> every time sqlite reads a row and compares it against
a literal.</li>
</ul>
<p>The output of this test now looks something like:</p>
<pre><code>running 1 test
query: select * from moz_bookmarks
+----+------+------+--------+----------+---------+---------------+---------------+--------------+------------+-------------------+
| id | fk   | type | parent | position | title   | dateAdded     | lastModified  | guid         | syncStatus | syncChangeCounter |
+====+======+======+========+==========+=========+===============+===============+==============+============+===================+
| 1  | null | 2    | null   | 0        | root    | 1686248350470 | 1686248350470 | root________ | 1          | 1                 |
+----+------+------+--------+----------+---------+---------------+---------------+--------------+------------+-------------------+
| 2  | null | 2    | 1      | 0        | menu    | 1686248350470 | 1686248350470 | menu________ | 1          | 1                 |
+----+------+------+--------+----------+---------+---------------+---------------+--------------+------------+-------------------+
| 3  | null | 2    | 1      | 1        | toolbar | 1686248350470 | 1686248350470 | toolbar_____ | 1          | 1                 |
+----+------+------+--------+----------+---------+---------------+---------------+--------------+------------+-------------------+
| 4  | null | 2    | 1      | 2        | unfiled | 1686248350470 | 1686248350470 | unfiled_____ | 1          | 1                 |
+----+------+------+--------+----------+---------+---------------+---------------+--------------+------------+-------------------+
| 5  | null | 2    | 1      | 3        | mobile  | 1686248350470 | 1686248350470 | mobile______ | 1          | 1                 |
+----+------+------+--------+----------+---------+---------------+---------------+--------------+------------+-------------------+
| 6  | null | 3    | 1      | 0        | null    | 1             | 1             | bookmarkguid | 2          | 1                 |
+----+------+------+--------+----------+---------+---------------+---------------+--------------+------------+-------------------+
test db::schema::tests::test_bookmark_tombstone_auto_created ... FAILED

failures:

---- db::schema::tests::test_bookmark_tombstone_auto_created stdout ----
CHECKING GUID root________
CHECKING GUID menu________
CHECKING GUID toolbar_____
CHECKING GUID unfiled_____
CHECKING GUID mobile______
CHECKING GUID bookmarkguid
</code></pre>
<p>It’s unfortunate that the output of <code>print_table()</code> goes to the tty while the output of <code>dbg</code> goes to <code>stderr</code>, so
you might find the output isn’t quite intermingled as you would expect, but it’s better than nothing!</p>
<footer id="open-on-gh-10">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/debug-sql.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="dependency-management-guidelines"><a class="header" href="#dependency-management-guidelines">Dependency Management Guidelines</a></h1>
<p>This repository uses third-party code from a variety of sources, so we need to be mindful
of how these dependencies will affect our consumers.  Considerations include:</p>
<ul>
<li>General code quality.</li>
<li><a href="https://www.mozilla.org/en-US/MPL/license-policy/#Licenses_Compatible_with_the_MPL">Licensing compatibility</a>.</li>
<li>Handling of security vulnerabilities.</li>
<li>The potential for <a href="https://medium.com/intrinsic/compromised-npm-package-event-stream-d47d08605502">supply-chain compromise</a>.</li>
</ul>
<p>We’re still evolving our policies in this area, but these are the
guidelines we’ve developed so far.</p>
<h2 id="rust-code-1"><a class="header" href="#rust-code-1">Rust Code</a></h2>
<p>Unlike <a href="https://firefox-source-docs.mozilla.org/build/buildsystem/rust.html">Firefox</a>,
we do not vendor third-party source code directly into the repository.  Instead we rely on
<code>Cargo.lock</code> and its hash validation to ensure that each build uses an identical copy
of all third-party crates.  These are the measures we use for ongoing maintence of our
existing dependencies:</p>
<ul>
<li>Check <code>Cargo.lock</code> into the repository.</li>
<li>Generate built artifacts using the <code>--locked</code> flag to <code>cargo build</code>, as an additional
assurance that the existing <code>Cargo.lock</code> will be respected.</li>
<li>Regularly run <a href="https://github.com/RustSec/cargo-audit">cargo-audit</a> in CI to alert us to
security problems in our dependencies.
<ul>
<li>It runs on every PR, and once per hour on the <code>main</code> branch</li>
</ul>
</li>
<li>Use <a href="https://github.com/mozilla/application-services/blob/main/tools/dependency_summary.py">a home-grown tool</a> to generate a summary of dependency licenses
and to check them for compatibility with MPL-2.0.
<ul>
<li>Check these summaries into the repository and have CI alert on unexpected changes,
to guard against pulling in new versions of a dependency under a different license.</li>
</ul>
</li>
</ul>
<p>Adding a new dependency, whether we like it or not, is a big deal - that dependency and everything
it brings with it will become part of Firefox-branded products that we ship to end users.
We try to balance this responsibility against the many benefits of using existing code, as follows:</p>
<ul>
<li>In general, be conservative in adding new third-party dependencies.
<ul>
<li>For trivial functionality, consider just writing it yourself.
Remember the cautionary tale of <a href="https://www.theregister.co.uk/2016/03/23/npm_left_pad_chaos/">left-pad</a>.</li>
<li>Check if we already have a crate in our dependency tree that can provide the needed functionality.</li>
</ul>
</li>
<li>Prefer crates that have a a high level of due-diligence already applied, such as:
<ul>
<li>Crates that are <a href="https://dxr.mozilla.org/mozilla-central/source/third_party/rust">already vendored into Firefox</a>.</li>
<li>Crates from <a href="https://github.com/rust-lang-nursery">rust-lang-nursery</a>.</li>
<li>Crates that appear to be widely used in the rust community.</li>
</ul>
</li>
<li>Check that it is clearly licensed and is <a href="https://www.mozilla.org/en-US/MPL/license-policy/#Licenses_Compatible_with_the_MPL">MPL-2.0 compatible</a>.</li>
<li>Take the time to investigate the crate’s source and ensure it is suitably high-quality.
<ul>
<li>Be especially wary of uses of <code>unsafe</code>, or of code that is unusually resource-intensive to build.</li>
<li>Dev dependencies do not require as much scrutiny as dependencies that will ship in consuming applications,
but should still be given some thought.
<ul>
<li>There is still the potential for supply-chain compromise with dev dependencies!</li>
</ul>
</li>
</ul>
</li>
<li>As part of the PR that introduces the new dependency:
<ul>
<li>Regenerate dependency summary files using the <a href="https://github.com/mozilla/application-services/blob/main/tools/regenerate_dependency_summaries.sh">regenerate_dependency_summaries.sh</a>.</li>
<li>Explicitly describe your consideration of the above points.</li>
</ul>
</li>
</ul>
<p>Updating to new versions of existing dependencies is a normal part of software development
and is not accompanied by any particular ceremony.</p>
<h2 id="androidkotlin-code"><a class="header" href="#androidkotlin-code">Android/Kotlin Code</a></h2>
<p>We currently depend only on the following Kotlin dependencies:</p>
<ul>
<li><a href="https://github.com/java-native-access/jna">JNA</a></li>
<li><a href="https://github.com/google/protobuf-gradle-plugin">protobuf-gradle-plugin</a></li>
</ul>
<p>We currently depend on the following <strong>developer</strong> dependencies in the Kotlin codebase,
but they do not get included in built distribution files:</p>
<ul>
<li>detekt</li>
<li>ktlint</li>
</ul>
<p>No additional Kotlin dependencies should be added to the project unless absolutely necessary.</p>
<h2 id="iosswift-code"><a class="header" href="#iosswift-code">iOS/Swift Code</a></h2>
<p>We currently do not depend on any Swift dependencies. And no Swift dependencies should be added to the project unless absolutely necessary.</p>
<h2 id="other-code"><a class="header" href="#other-code">Other Code</a></h2>
<p>We currently depend on local builds of the following system dependencies:</p>
<ul>
<li><a href="https://hg.mozilla.org/projects/nss">NSS</a> and <a href="https://hg.mozilla.org/projects/nspr">NSPR</a></li>
<li><a href="https://github.com/sqlcipher/sqlcipher">SQLCipher</a></li>
<li><a href="https://github.com/protocolbuffers/protobuf">Protobuf</a></li>
</ul>
<p>No additional system dependencies should be added to the project unless absolutely necessary.</p>
<footer id="open-on-gh-11">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/dependency-management.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="adding-a-new-component-to-application-services"><a class="header" href="#adding-a-new-component-to-application-services">Adding a new component to Application Services</a></h1>
<p>This is a rapid-fire list for adding a component from scratch and generating Kotlin/Swift bindings.</p>
<h2 id="the-rust-code"><a class="header" href="#the-rust-code">The Rust Code</a></h2>
<p>Your component should live under <code>./components</code> in this repo.
Use <code>cargo new --lib ./components/&lt;your_crate_name&gt;</code>to create a new library crate.</p>
<p>See the <a href="#guide-to-building-a-syncable-rust-component">Guide to Building a Rust Component</a> for general
advice on designing and structuring the actual Rust code, and follow the
<a href="#dependency-management-guidelines">Dependency Management Guidelines</a> if your crate
introduces any new dependencies.</p>
<p>Use <a href="https://mozilla.github.io/uniffi-rs/">UniFFI</a> to define how your crate’s
API will get exposed to foreign-language bindings. Lookup the installed uniffi
version on other packages (eg <code>grep uniffi components/init_rust_components/Cargo.toml</code>) and use the same version. Place
the following in your <code>Cargo.toml</code>:</p>
<pre><code>[dependencies]
uniffi = { version = "&lt;current uniffi version&gt;" }
</code></pre>
<p>New components should prefer using the
<a href="https://mozilla.github.io/uniffi-rs/latest/proc_macro/index.html">proc-macro</a> approach rather than
a UDL file based approach.  If you do use a UDL file, add this to <code>Cargo.toml</code> as well.</p>
<pre><code>[build-dependencies]
uniffi = { version = "&lt;current uniffi version&gt;" }
</code></pre>
<p>Include your new crate in the <code>application-services</code> workspace, by adding
it to the <code>members</code> and <code>default-members</code> lists in the <code>Cargo.toml</code> at
the root of the repository.</p>
<p>Run <code>cargo check -p &lt;your_crate_name&gt;</code> in the repository root to confirm that
things are configured properly. This will also have the side-effect of updating
<code>Cargo.lock</code> to contain your new crate and its dependencies.</p>
<h2 id="the-android-bindings"><a class="header" href="#the-android-bindings">The Android Bindings</a></h2>
<p>Run the <code>cargo start-bindings android &lt;your_crate_name&gt; &lt;component_description&gt;</code> command to auto-generate the initial code.  Follow the directions in the output.</p>
<p>You will end up with a directory structure something like this:</p>
<ul>
<li><code>components/&lt;your_crate_name&gt;/</code>
<ul>
<li><code>Cargo.toml</code></li>
<li><code>uniffi.toml</code></li>
<li><code>src/</code>
<ul>
<li>Rust code here.</li>
</ul>
</li>
<li><code>android/</code>
<ul>
<li><code>build.gradle</code></li>
<li><code>src/</code>
<ul>
<li><code>main/</code>
<ul>
<li><code>AndroidManifest.xml</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="dependent-crates"><a class="header" href="#dependent-crates">Dependent crates</a></h3>
<p>If your crate uses types from another crate in it’s public API, you need to include a dependency for
the corresponding project in your <code>android/build.gradle</code> file.</p>
<p>For example, suppose use the <code>remote_settings::RemoteSettingsServer</code> type in your public API so that
consumers can select which server they want.  In that case, you need to a dependency on the
remotesettings project:</p>
<pre><code>dependencies {
    api project(":remotesettings")
}
</code></pre>
<h3 id="async-dependencies"><a class="header" href="#async-dependencies">Async dependencies</a></h3>
<p>If your components exports async functions, add the following to your <code>android/build.gradle</code> file:</p>
<pre><code>dependencies {
    implementation libs.kotlin.coroutines
}
</code></pre>
<h3 id="hand-written-code"><a class="header" href="#hand-written-code">Hand-written code</a></h3>
<p>You can include hand-written Kotlin code alongside the automatically
generated bindings, by placing `.kt`` files in a directory named:</p>
<ul>
<li><code>./android/src/test/java/mozilla/appservices/&lt;your_crate_name&gt;/</code></li>
</ul>
<p>You can write Kotlin-level tests that consume your component’s API,
by placing `.kt`` files in a directory named:</p>
<ul>
<li><code>./android/src/test/java/mozilla/appservices/&lt;your_crate_name&gt;/</code>.</li>
</ul>
<p>You can run the tests with <code>./gradlew &lt;your_crate_name&gt;:test</code></p>
<h2 id="the-ios-bindings"><a class="header" href="#the-ios-bindings">The iOS Bindings</a></h2>
<ul>
<li>Run the <code>cargo start-bindings ios &lt;your_crate_name&gt;</code> command to auto-generate the initial code</li>
<li>Run <code>cargo start-bindings ios-focus &lt;your_crate_name&gt;</code> if you also want to expose your component to Focus.</li>
<li>Follow the directions in the output.</li>
</ul>
<p>You will end up with a directory structure something like this:</p>
<ul>
<li><code>components/&lt;your_crate_name&gt;/</code>
<ul>
<li><code>Cargo.toml</code></li>
<li><code>uniffi.toml</code></li>
<li><code>src/</code>
<ul>
<li>Rust code here.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="adding-your-component-to-the-swift-package-megazord"><a class="header" href="#adding-your-component-to-the-swift-package-megazord">Adding your component to the Swift Package Megazord</a></h3>
<blockquote>
<p><em>For more information on our how we ship components using the Swift Package Manager, check the <a href="#distributing-swift-packages">ADR that introduced the Swift Package Manager</a></em></p>
</blockquote>
<p>Add your component into the iOS <a href="#megazording">“megazord”</a> through the local Swift Package Manager (SPM) package <code>MozillaRustComponentsWrapper</code>. Note this SPM is for ease of testing APIs locally. The official SPM that is consumed by firefox-ios is a <a href="https://github.com/mozilla-mobile/firefox-ios/tree/main/MozillaRustComponents">local package in their repo</a>.</p>
<ol>
<li>Place your Swift test code in:
<pre><code>megazords/ios-rust/tests/MozillaRustComponentsWrapper/
</code></pre>
</li>
</ol>
<blockquote>
<p>Note: swift-specific tests are ideally suited in the consuming app as there is better integration coverage and ensures we’re accurately testing how it’s being consumed</p>
</blockquote>
<p>That’s it! At this point, if you don’t intend on writing tests <em>(are you sure?)</em> you can skip this next section.</p>
<h3 id="writing-and-running-tests"><a class="header" href="#writing-and-running-tests">Writing and Running Tests</a></h3>
<p>The current system combines all rust crates into one binary (megazord). To use your rust APIs simply
import the local SPM into your tests:</p>
<pre><code class="language-swift">@testable import MozillaRustComponentsWrapper
</code></pre>
<p>To test your component:</p>
<ul>
<li>Run the script:</li>
</ul>
<pre><code>./automation/build_ios_artifacts.sh
</code></pre>
<p>The script will:</p>
<ol>
<li>Build the XCFramework (combines all rust binaries for SPM)</li>
<li>Generate UniFFi bindings (generated files will be found in <code>megazords/ios-rust/sources/MozillaRustComponentsWrapper/Generated/</code>)</li>
<li>Generate Glean metrics</li>
<li>Run any tests found in the test dir mentioned above</li>
</ol>
<h3 id="distribution-of-the-component"><a class="header" href="#distribution-of-the-component">Distribution of the component</a></h3>
<p>The UniFFi files will be generated &amp; packaged via <code>taskcluster/scripts/build-and-test-swift.py</code>.</p>
<p>Consumers (eg: Firefox iOS) pull the latest artifacts via a nightly <a href="https://github.com/mozilla-mobile/firefox-ios/actions/workflows/update-appservices-nightly.yml">Gitub action</a>. Once your changes are pulled via a nightly release you’ll be able to use your new APIs!</p>
<blockquote>
<p>Note: If you don’t want to wait for a nightly, once the CI finishes your build – you can request the action run in firefox-ios to get it sooner</p>
</blockquote>
<blockquote>
<p>Note pt2: If you want to locally test against firefox-ios, follow <a href="https://github.com/mozilla/application-services/blob/main/docs/howtos/locally-published-components-in-firefox-ios.md">this guide</a></p>
</blockquote>
<footer id="open-on-gh-12">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/adding-a-new-component.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="guide-to-building-a-syncable-rust-component"><a class="header" href="#guide-to-building-a-syncable-rust-component">Guide to Building a Syncable Rust Component</a></h1>
<blockquote>
<p>This is a guide to creating a new Syncable Rust Component like many of the components in this repo. If you are looking for information how to build (ie,compile, etc) the existing components, you are looking for <a href="#building-application-services">our build documentation</a></p>
</blockquote>
<p>Welcome!</p>
<p>It’s great that you want to build a Rust Component - this guide should help
get you started. It documents some nomenclature, best-practices and other
tips and tricks to get you started.</p>
<p>This document is just for general guidance - every component will be different
and we are still learning how to make these components. Please update this
document with these learnings.</p>
<p>To repeat with emphasis - <strong>please consider this a living document</strong>.</p>
<h1 id="general-design-and-structure-of-the-component"><a class="header" href="#general-design-and-structure-of-the-component">General design and structure of the component</a></h1>
<p>We think components should be structured as described here.</p>
<h2 id="we-build-libraries-not-frameworks"><a class="header" href="#we-build-libraries-not-frameworks">We build libraries, not frameworks</a></h2>
<p>Think of building a “library”, not a “framework” - the application should be in
control and calling functions exposed by your component, not providing functions
for your component to call.</p>
<h2 id="the-store-is-the-entry-point"><a class="header" href="#the-store-is-the-entry-point">The “store” is the “entry-point”</a></h2>
<p>[Note that some of the older components use the term “store” differently; we
should rename them! In Places, it’s called an “API”; in Logins an “engine”. See
<code>webext-storage</code> for a more recent component that uses the term “Store” as we
think it should be used.]</p>
<p>The “Store” is the entry-point for the consuming application - it provides the
core functionality exposed by the component and manages your databases and other
singletons. The responsibilities of the “Store” will include things like creating the
DB if it doesn’t exist, doing schema upgrades etc.</p>
<p>The functionality exposed by the “Store” will depend on the complexity of the
API being exposed. For example, for <code>webext-storage</code>, where there are only a
handful of simple public functions, it just directly exposes all the
functionality of the component. However, for Places, which has a much more
complex API, the (logical) Store instead supplies “Connection” instances which
expose the actual functionality.</p>
<h2 id="using-sqlite"><a class="header" href="#using-sqlite">Using sqlite</a></h2>
<p>We prefer sqlite instead of (say) JSON files or RKV.</p>
<p>Always put sqlite into WAL mode, then have exactly 1 writer connection and as
many reader connections you need - which will depend on your use-case - for
example, <code>webext_storage</code> has 1 reader, while <code>places</code> has many.</p>
<p>(Note that places has 2 writers (one for sync, one for the api), but we
believe this was a mistake and should have been able to make things work
better with exactly 1 shared between sync and the api)</p>
<p>We typically have a “DB” abstraction which manages the database itself - the
logic for handling schema upgrades etc and enforcing the “only 1 writer” rule
is done by this.</p>
<p>However, this is just a convenience - the DB abstractions aren’t really passed
around - we just pass raw connections (or transactions) around. For example, if
there’s a utility function that reads from the DB, it will just have a Rusqlite
connection passed. (Again, older components don’t really do this well, but
<code>webext-storage</code> does)</p>
<p>We try and leverage rust to ensure transactions are enforced at the correct
boundaries - for example, functions which write data but which must be done as
part of a transaction will accept a Rusqlite <code>Transaction</code> reference as the
param, whereas something that only reads the Db will accept a Rusqlite
<code>Connection</code> - note that because <code>Transaction</code> supports
<code>Deref&lt;Target = Connection&gt;</code>, you can pass a <code>&amp;Transaction</code> wherever a
<code>&amp;Connection</code> is needed - but not vice-versa.</p>
<h3 id="meta-data"><a class="header" href="#meta-data">Meta-data</a></h3>
<p>You are likely to have a table just for key/value metadata, and this table will
be used by sync (and possibly other parts of the component) to track the
sync IDs, lastModified timestamps etc.</p>
<h3 id="schema-management"><a class="header" href="#schema-management">Schema management</a></h3>
<p>The schemas are stored in the tree in .sql files and pulled into the source at
build time via <code>include_str!</code>. Depending on the complexity of your component,
there may be a need for different Connections to have different Sql (for
example, it may be that only your ‘write’ connection requires the sql to define
triggers or temp tables, so these might be in their own file.)</p>
<p>Because requirements evolve, there will be a need to support schema upgrades.
This is done by way of sqlite’s <code>PRAGMA user_version</code> - which can be thought of
as simple metadata for the database itself. In short, immediately after opening
the database for the first time, we check this version and if it’s less than
expected we perform the schema upgrades necessary, then re-write the version
to the new version.</p>
<p>This is easier to read than explain, so read the <code>upgrade()</code> function in
<a href="https://github.com/mozilla/application-services/blob/main/components/places/src/db/schema.rs">the Places schema code</a></p>
<p>You will need to be a big careful here because schema upgrades are going to
block the calling application immediately after they upgrade to a new version,
so if your schema change requires a table scan of a massive table, you are going
to have a bad time. Apart from that though, you are largely free to do whatever
sqlite lets you do!</p>
<p>Note that most of our components have very similar schema and database
management code - these are screaming out to be refactored so common logic can
be shared. Please be brave and have a go at this!</p>
<h3 id="triggers"><a class="header" href="#triggers">Triggers</a></h3>
<p>We tend to like triggers for encompassing application logic - for example, if
updating one row means a row in a different table should be updated based on
that data, we’d tend to prefer an, eg,  <code>AFTER UPDATE</code> trigger than having our
code manually implement the logic.</p>
<p>However, you should take care here, because functionality based on triggers is
difficult to debug (eg, logging in a trigger is difficult) and the functionality
can be difficult to locate (eg, users unfamiliar with the component may wonder
why they can’t find certain functionity in the rust code and may not consider
looking in the sqlite triggers)</p>
<p>You should also be careful when creating triggers on persistent main tables.
For example, bumping the change counter isn’t a good use for a trigger,
because it’ll run for all changes on the table—including those made by Sync.
This means Sync will end up tracking its own changes, and getting into infinite
syncing loops. Triggers on temporary tables, or ones that are used for
bookkeeping where the caller doesn’t matter, like bumping the foreign
reference count for a URL, are generally okay.</p>
<h2 id="general-structure-of-the-rust-code"><a class="header" href="#general-structure-of-the-rust-code">General structure of the rust code</a></h2>
<p>We prefer flatter module hierarchies where possible. For example, in <code>Places</code>
we ended up with <code>sync_history</code> and <code>sync_bookmarks</code> sub-modules rather than
a <code>sync</code> submodule itself with <code>history</code> and <code>bookmarks</code>.</p>
<p>Note that the raw connections are never exposed to consumers - for example, they
will tend to be stored as private fields in, eg, a Mutex.</p>
<h1 id="syncing"><a class="header" href="#syncing">Syncing</a></h1>
<p>The traits you need to implement to sync aren’t directly covered here.</p>
<p>All meta-data related to sync must be stored in the same database as the
data itself - often in a <code>meta</code> table.</p>
<p>All logic for knowing which records need to be sync must be part of the
application logic, and will often be implemented using <code>triggers</code>. It’s quite
common for components to use a “change counter” strategy, which can be
summarized as:</p>
<ul>
<li>
<p>Every table which defines the “top level” items being synced will have a
column called something like ‘sync_change_counter’ - the app will probably
track this counter manually instead of using a trigger, because sync itself
will need different behavior when it updates the records.</p>
</li>
<li>
<p>At sync time, items with a non-zero change counter are candidates for syncing.</p>
</li>
<li>
<p>As the sync starts, for each item, the current value of the change counter is
remembered. At the end of the sync, the counter is decremented by this value.
Thus, items which were changed between the time the sync started and completed
will be left with a non-zero change counter at the end of the sync.</p>
</li>
</ul>
<h2 id="syncing-faqs"><a class="header" href="#syncing-faqs">Syncing FAQs</a></h2>
<p>This section is stolen from <a href="https://docs.google.com/document/d/1s9ld2F4e83eQ944kN6QXXTRlqrX74w2AJS6W2fDyAJ8">this document</a></p>
<h3 id="whats-the-global-sync-id-and-the-collection-sync-id"><a class="header" href="#whats-the-global-sync-id-and-the-collection-sync-id">What’s the global sync ID and the collection sync ID?</a></h3>
<p>Both guids, both used to identify when the data in the server has changed
radically underneath us (eg, when looking at lastModified is no longer a sane
thing to do.)</p>
<p>The “global sync ID” changing means that every collection needs to be assumed as
having changed radically, whereas just the “collection sync ID” changing means
just that one collection.</p>
<p>These global IDs are most likely to change on a node reassignment (which should
be rare now with durable storage), a password reset, etc. An example of when the
collection ID will change is a “bookmarks restore” - handling an old version of
a database re-appearing is why we store these IDs in the database itself.</p>
<h3 id="whats-get_sync_assoc-why-is-it-important-what-is-storesyncassociation"><a class="header" href="#whats-get_sync_assoc-why-is-it-important-what-is-storesyncassociation">What’s <code>get_sync_assoc</code>, why is it important? What is <code>StoreSyncAssociation</code>?</a></h3>
<p>They are all used to track the guids above. It’s vitally important we know when
these guids change.</p>
<p>StoreSyncAssociation is a simple enum which reflects the state a sync engine
can be in - either <code>Disconnected</code> (ie, we have no idea what the GUIDs are) or
<code>Connected</code> where we know what we think the IDs are (but the server may or may
not match with this)</p>
<p>These GUIDs will typically be stored in the DB in the metadata table.</p>
<h3 id="what-is-apply_incoming-versus-sync_finished"><a class="header" href="#what-is-apply_incoming-versus-sync_finished">what is <code>apply_incoming</code> versus <code>sync_finished</code></a></h3>
<p><code>apply_incoming</code> is where any records incoming from the server (ie, possibly
all records on the server if this is a first-sync, records with a timestamp
later than our last sync otherwise) are processed.</p>
<p><code>sync_finished</code> is where we’ve done all the sync work other than uploading new
changes to the server.</p>
<h3 id="whats-the-diff-between-reset-and-wipe"><a class="header" href="#whats-the-diff-between-reset-and-wipe">What’s the diff between reset and wipe?</a></h3>
<ul>
<li>Reset means “I don’t know what’s on the server - I need to reconcile everything there with everything I have”. IOW, a “first sync”</li>
<li>Wipe means literally “wipe all server data”</li>
</ul>
<h1 id="exposing-to-consumers"><a class="header" href="#exposing-to-consumers">Exposing to consumers</a></h1>
<p>You will need an FFI or some other way of exposing stuff to your consumers.</p>
<p>We use a tool called <a href="https://github.com/mozilla/uniffi-rs/">UniFFI</a> to automatically
generate FFI bindings from the Rust code.</p>
<p>If UniFFI doesn’t work for you, then you’ll need to hand-write the FFI layer.
Here are some earlier blog posts on the topic which might be helpful:</p>
<ul>
<li><a href="https://mozilla.github.io/firefox-browser-architecture/experiments/2017-09-21-rust-on-android.html">Building and Deploying a Rust library on Android</a></li>
<li><a href="https://mozilla.github.io/firefox-browser-architecture/experiments/2017-09-06-rust-on-ios.html">Building and Deploying a Rust library on iOS</a></li>
<li><a href="https://discourse.mozilla.org/t/dear-diary-turns-out-x-platform-is-hard/25348">Blog post re: lessons in binding to Rust code from iOS</a></li>
</ul>
<p>The above are likely to be superseded by uniffi docs, but for now, good luck!</p>
<footer id="open-on-gh-13">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/building-a-rust-component.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="naming-conventions"><a class="header" href="#naming-conventions">Naming Conventions</a></h1>
<p>All names in this project should adhere to the guidelines outlined in this document.</p>
<h2 id="rust-code-2"><a class="header" href="#rust-code-2">Rust Code</a></h2>
<p>TL;DR: do what Rust’s builtin warnings and clippy lints tell you
(and CI will fail if there are any unresolved warnings or clippy lints).</p>
<h3 id="overview"><a class="header" href="#overview">Overview</a></h3>
<ul>
<li>
<p>All variable names, function names, module names, and macros in Rust code should follow typical <code>snake_case</code> conventions.</p>
</li>
<li>
<p>All Rust types, traits, structs, and enum variants must follow <code>UpperCamelCase</code>.</p>
</li>
<li>
<p>Static and constant variables should be written in <code>SCREAMING_SNAKE_CASE</code>. s</p>
</li>
</ul>
<p>For more in-depth Rust conventions, see the <a href="https://doc.rust-lang.org/1.0.0/style/style/naming/README.html">Rust Style Guide</a>.</p>
<h3 id="examples"><a class="header" href="#examples">Examples:</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn sync15_passwords_get_all()
struct PushConfiguration{...}
const COMMON_SQL
<span class="boring">}</span></code></pre>
<h2 id="swift-code-1"><a class="header" href="#swift-code-1">Swift Code</a></h2>
<h3 id="overview-1"><a class="header" href="#overview-1">Overview</a></h3>
<ul>
<li>
<p>Names of types and protocols are <code>UpperCamelCase</code>.</p>
</li>
<li>
<p>All other uses are <code>lowerCamelCase</code>.</p>
</li>
</ul>
<p>For more in-depth Swift conventions, check out the <a href="https://swift.org/documentation/api-design-guidelines/">Swift API Design Guidelines</a>.</p>
<h3 id="examples-1"><a class="header" href="#examples-1">Examples:</a></h3>
<pre><code class="language-swift">enum CheckChildren{...}
func checkTree()
public var syncKey: String
</code></pre>
<h2 id="kotlin-code-1"><a class="header" href="#kotlin-code-1">Kotlin Code</a></h2>
<p>If a source file contains only a top-level class, the source file should reflect the case-sensitive name of the class plus the <em>.kt</em> extension. Otherwise, if the source contains multiple top-level declarations, choose a name that describes the contents of the file, apply <code>UpperCamelCase</code> and append <code>.kt</code> extension.</p>
<h3 id="overview-2"><a class="header" href="#overview-2">Overview</a></h3>
<ul>
<li>
<p>Names of packages are always lower case and do not include underscores. Using multi-word names should be avoided. However, if used, they should be concatenated or use <code>lowerCamelCase</code>.</p>
</li>
<li>
<p>Names of classes and objects use <code>UpperCamelCase</code>.</p>
</li>
<li>
<p>Names of functions, properties, and local variables use <code>lowerCamelCase</code>.</p>
</li>
</ul>
<p>For more in-depth Kotlin Conventions, see the <a href="https://kotlinlang.org/docs/reference/coding-conventions.html#naming-rules">Kotlin Style Guide</a>.</p>
<h3 id="examples-2"><a class="header" href="#examples-2">Examples:</a></h3>
<pre><code class="language-kotlin">//FooBar.kt
class FooBar{...}
fun fromJSONString()
package mozilla.appservices.places
</code></pre>
<footer id="open-on-gh-14">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/naming-conventions.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="rust--android-faqs"><a class="header" href="#rust--android-faqs">Rust + Android FAQs</a></h1>
<h3 id="how-do-i-expose-rust-code-to-kotlin"><a class="header" href="#how-do-i-expose-rust-code-to-kotlin">How do I expose Rust code to Kotlin?</a></h3>
<p>Use <a href="https://mozilla.github.io/uniffi-rs/">UniFFI</a>, which can produce Kotlin
bindings for your Rust code from an interface definition file.</p>
<p>If UniFFI doesn’t currently meet your needs, please <a href="https://github.com/mozilla/uniffi-rs/issues">open an issue</a> to discuss how the tool can
be improved.</p>
<p>As a last resort, you can make hand-written bindings from Rust to Kotlin,
essentially manually performing the steps that UniFFI tries to automate
for you: flatten your Rust API into a bunch of <code>pub extern "C"</code> functions,
then use <a href="https://github.com/java-native-access/jna">JNA</a> to call them
from Kotlin. The details of how to do that are well beyond the scope of
this document.</p>
<h3 id="how-should-i-name-the-package"><a class="header" href="#how-should-i-name-the-package">How should I name the package?</a></h3>
<p>Published packages should be named <code>org.mozilla.appservices.$NAME</code> where <code>$NAME</code>
is the name of your component, such as <code>logins</code>.  The Java namespace in which
your package defines its classes etc should be <code>mozilla.appservices.$NAME.*</code>.</p>
<h3 id="how-do-i-publish-the-resulting-package"><a class="header" href="#how-do-i-publish-the-resulting-package">How do I publish the resulting package?</a></h3>
<p>Add it to <code>.buildconfig-android.yml</code> in the root of this repository.
This will cause it to be automatically included as part of our release
publishing pipeline.</p>
<h3 id="how-do-i-know-what-library-name-to-load-to-access-the-compiled-rust-code"><a class="header" href="#how-do-i-know-what-library-name-to-load-to-access-the-compiled-rust-code">How do I know what library name to load to access the compiled rust code?</a></h3>
<p>Assuming that you’re building the Rust code as part of the application-services
build and release process, your <code>pub extern "C"</code> API should always be available
from a file named <code>libmegazord.so</code>.</p>
<h3 id="what-challenges-exist-when-calling-back-into-kotlin-from-rust"><a class="header" href="#what-challenges-exist-when-calling-back-into-kotlin-from-rust">What challenges exist when calling back into Kotlin from Rust?</a></h3>
<p>There are a number of them. The issue boils down to the fact that you need to be
completely certain that a JVM is associated with a given thread in order to call
java code on it. The difficulty is that the JVM can GC its threads and will not
let rust know about it.</p>
<p>JNA can work around this for us to some extent, at the cost of some complexity.
The approach it takes is essentially to spawn a thread for each callback
invocation. If you are certain you’re going to do a lot of callbacks and they
all originate on the same thread, you can have them all run on a single thread
by using the <a href="https://java-native-access.github.io/jna/4.2.1/com/sun/jna/CallbackThreadInitializer.html"><code>CallbackThreadInitializer</code></a>.</p>
<p>With the help of JNA’s workarounds, calling back from Rust into Kotlin isn’t too bad
so long as you ensure that Kotlin cannot GC the callback while rust code holds onto it
(perhaps by stashing it in a global variable), and so long as you can either accept the overhead of extra threads being instantiated on each call or are willing to manage
the threads explicitly.</p>
<p>Note that the situation would be somewhat better if we used JNI directly (and
not JNA), but this would cause us to need to generate different Rust FFI code for
Android than for iOS.</p>
<p>Ultimately, in any case where there is an alternative to using a callback, you
should probably pursue that alternative.</p>
<p>For example if you’re using callbacks to implement async I/O, it’s likely better to
move to doing a blocking call, and have the calling code dispatch it on a background
thread. It’s very easy to run such things on a background thread in Kotlin, is in line
with the Android documentation on JNI usage, and in our experience is vastly simpler
and less painful than using callbacks.</p>
<p>(Of course, not every case is solvable like this).</p>
<h3 id="why-are-we-using-jna-rather-than-jni-and-what-tradeoffs-does-that-involve"><a class="header" href="#why-are-we-using-jna-rather-than-jni-and-what-tradeoffs-does-that-involve">Why are we using JNA rather than JNI, and what tradeoffs does that involve?</a></h3>
<p>We get a couple things from using JNA that we wouldn’t with JNI.</p>
<ol>
<li>
<p>We are able to use the same Rust FFI code on all platforms. If we used JNI we’d
need to generate an Android-specific Rust FFI crate that used the JNI APIs, and
a separate Rust FFI crate for exposing to Swift.</p>
</li>
<li>
<p>JNA provides a mapping of threads to callbacks for us, making callbacks over
the FFI possible. That said, in practice this is still error prone, and easy
to misuse/cause memory safety bugs, but it’s required for cases like logging,
among others, and so it is a nontrivial piece of complexity we’d have to
reimplement.</p>
</li>
</ol>
<p>However, it comes with the following downsides:</p>
<ol>
<li>JNA has bugs. In particular, its not safe to use bools with them, it thinks
they are 32 bits, when on most platforms (every platform Rust supports) they
are 8 bits. They’ve been unwilling to fix the issue due to it breaking
backwards compatibility (which is… somewhat fair, there is a lot of C89
code out there that uses <code>bool</code> as a typedef for a 32-bit <code>int</code>).</li>
<li>JNA makes it really easy to do the wrong thing and have it work but corrupt
memory. Several of the caveats around this are documented in the
<a href="https://docs.rs/ffi-support/*/ffi_support/"><code>ffi_support</code> docs</a>, but a
major one is when to use <code>Pointer</code> vs <code>String</code> (getting this wrong will
often work, but may corrupt memory).</li>
</ol>
<p>We aim to avoid triggering these bugs by auto-generating the JNA bindings
rather than writing them by hand.</p>
<h3 id="how-do-i-debug-rust-code-with-the-step-debugger-in-android-studio"><a class="header" href="#how-do-i-debug-rust-code-with-the-step-debugger-in-android-studio">How do I debug Rust code with the step-debugger in Android Studio</a></h3>
<ol>
<li>Uncomment the <code>packagingOptions { doNotStrip "**/*.so" }</code> line from the
build.gradle file of the component you want to debug.</li>
<li>In the rust code, either:
<ol>
<li>Cause something to crash where you want the breakpoint. Note: Panics
don’t work here, unfortunately. (I have not found a convenient way to
set a breakpoint to rust code, so
<code>unsafe { std::ptr::write_volatile(0 as *const _, 1u8) }</code> usually is
what I do).</li>
<li>If you manage to get an LLDB prompt, you can set a breakpoint using
<code>breakpoint set --name foo</code>, or <code>breakpoint set --file foo.rs --line 123</code>.
I don’t know how to bring up this prompt reliably, so I often do step 1 to
get it to appear, delete the crashing code, and then set the
breakpoint using the CLI. This is admittedly suboptimal.</li>
</ol>
</li>
<li>Click the Debug button in Android Studio, to display the “Select Deployment
Target” window.</li>
<li>Make sure the debugger selection is set to “Both”. This tends to unset
itself, so make sure.</li>
<li>Click “Run”, and debug away.</li>
</ol>
<footer id="open-on-gh-15">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/android-faqs.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="breaking-changes-in-application-services-code"><a class="header" href="#breaking-changes-in-application-services-code">Breaking changes in application-services code</a></h1>
<p>Application-services components are consumed by multiple consumers including Firefox Android,
Firefox iOS, Focus Android, and Focus iOS.  To minimize the disruption to those projects when making
breaking API changes, we follow a simple rule: <strong>Have approved PRs ready to land that fix the
breakage in the other repos before merging the PR into application-services</strong>.</p>
<p>This means writing code for the
<a href="https://github.com/mozilla-mobile/firefox-android/">firefox-android</a> and
<a href="https://github.com/mozilla-mobile/firefox-ios/">firefox-ios</a> repositories that resolves any
breaking changes, creating a PR in those repositories, and waiting for it to be approved.</p>
<p>You can test this code locally using the autopublish flow (<a href="#using-locally-published-components-in-fenix">Android</a>, <a href="#how-to-locally-test-swift-package-manager-components-on-firefox-ios">iOS</a>) and use the <a href="#branch-builds">branch build system</a> to run CI tests.</p>
<h2 id="merging"><a class="header" href="#merging">Merging</a></h2>
<p>Do not merge any PRs until all are approved.  Once they are all approved then:</p>
<ul>
<li>Merge the <code>application-services</code> PR into <code>main</code></li>
<li>Manually trigger a new nightly build using the taskcluster hook:
https://firefox-ci-tc.services.mozilla.com/hooks/project-releng/cron-task-mozilla-application-services%2Fnightly</li>
<li>Once the nightly task completes, trigger a new build in firefox-ios using the github action:
https://github.com/mozilla-mobile/firefox-ios/actions/workflows/update-appservices-nightly.yml</li>
<li>Update the <code>firefox-android</code> and <code>firefox-ios</code> PRs to use the newly built nightly:
<ul>
<li><a href="https://github.com/mozilla-mobile/firefox-android/pull/4056/files">example of firefox-android changes</a></li>
<li><a href="https://github.com/mozilla-mobile/firefox-ios/pull/16783/files">example of firefox-ios changes</a></li>
</ul>
</li>
<li>Ideally, get the PRs merged before the firefox-android/firefox-ios nightly bump the next day.
If you don’t get these merged, then the nightly bump PR will fail.  Add a link to your PR in
the nightly bump PR so the mobile teams know how to fix this.</li>
</ul>
<footer id="open-on-gh-16">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/breaking-changes.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="how-to-vendor-application-services-into-mozilla-central"><a href="#how-to-vendor-application-services-into-mozilla-central" class="header">How to vendor application-services into mozilla-central</a></h1>
<h2 id="vendoring-application-services-into-mozilla-central"><a class="header" href="#vendoring-application-services-into-mozilla-central">Vendoring Application Services into mozilla-central</a></h2>
<p>Some of these components are used in <a href="https://hg.mozilla.org/mozilla-central/">mozilla-central</a>.
This document describes how to update existing components or add new components.</p>
<p>The general process for <a href="https://firefox-source-docs.mozilla.org/build/buildsystem/rust.html">vendoring rust code into mozilla-central has its own
documentation</a> -
please make sure you read that before continuing.</p>
<h3 id="when-to-vendor"><a class="header" href="#when-to-vendor">When to vendor</a></h3>
<p>We want to keep our versions in moz-central relatively up-to-date, but it takes some manual effort
to do.  The main possibility of breakage is from a dependency mismatch, so our current vendoring
policy is:</p>
<ul>
<li>Whenever a 3rd-party dependency is added or updated, the dev who made the change is responsible
for vendoring.</li>
<li>At the start of the <a href="https://wiki.mozilla.org/Release_Management/Calendar">release cycle</a> the
triage owner is response for vendoring.</li>
</ul>
<h3 id="updating-existing-components"><a class="header" href="#updating-existing-components">Updating existing components.</a></h3>
<p>To update components which are already in mozilla-central, follow these steps:</p>
<ol>
<li>
<p>Ensure your mozilla-central build environment is setup correctly to make
“non-artifact” builds - check you can get a full working build before
starting this process.</p>
</li>
<li>
<p>Run <code>./tools/update-moz-central-vendoring.py [path-to-moz-central]</code> from the application-services
root directory.</p>
</li>
<li>
<p>If this generates errors regarding duplicate crates, you will enter a world
of pain, and probably need to ask for advice from the application-services
team, and/or the <a href="https://matrix.to/#/#build:mozilla.org"><code>#build</code> channel on matrix</a>.</p>
</li>
<li>
<p>Run <code>./mach cargo vet</code> to check if there any any new dependencies that need to be vetted.  If
there are ask for advice from the application-services team.</p>
</li>
<li>
<p>Build and test your tree. Ideally make a try run.</p>
</li>
<li>
<p>Put your patch up to phabricator, requesting review from, at least, someone
on the application-services team and one of the “build peers” - asking on
<a href="https://matrix.to/#/#build:mozilla.org"><code>#build</code> on matrix</a> for a suitable
reviewer might help. Alternatively, try and find the bug which made the
most recent update and ask the same reviewer in that patch.</p>
</li>
<li>
<p>Profit!</p>
</li>
</ol>
<h3 id="adding-a-new-component"><a class="header" href="#adding-a-new-component">Adding a new component</a></h3>
<p>Follow the <a href="https://github.com/mozilla/gecko-dev/blob/master/docs/writing-rust-code/uniffi.md">Uniffi documentation on mozilla-central</a> to understand where you’ll need to add your crate path and UDL. In general:</p>
<ul>
<li>The consuming component will specify the dependency as a nominal “version 0.1”</li>
<li>The top-level <code>Cargo.toml</code> will override that dependency with a specific git
revision.</li>
</ul>
<p>For example, consider the webext-storage crate:</p>
<ul>
<li>The <a href="https://searchfox.org/mozilla-central/source/toolkit/components/extensions/storage/webext_storage_bridge/Cargo.toml#23">consuming crate specifies version 0.1
</a></li>
<li>The <a href="https://searchfox.org/mozilla-central/search?q=application-services+overrides&amp;path=Cargo.toml">top-level Cargo.toml</a>
specifies the exact revision.</li>
</ul>
<p>Adding a new component implies there will be related mozilla-central changes
which leverage it. The best practice here is to land both the vendoring of the
new component and the related <code>mozilla-central</code> changes in the same bug, but in
different phabricator patches. As noted above, the best-practice is that all
application-services components are on the same revision, so adding a new
component implies you will generally also be updating all the existing
components.</p>
<p>For an example of a recently added component, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1791851">the tabs was recently added to mozilla-central with uniffi</a> and shows a general process to follow.</p>
<h3 id="vendoring-an-unreleased-version-for-testing-purposes"><a class="header" href="#vendoring-an-unreleased-version-for-testing-purposes">Vendoring an unreleased version for testing purposes</a></h3>
<p>Sometimes you will need to make changes in application-services and in mozilla-central
simultaneously - for example, you may need to add new features or capabilities
to a component, and matching changes in mozilla-central to use that new feature.</p>
<p>In that scenario, you don’t want to check your changes in and re-vendor as you
iterate - it would be far better to use a local checkout of application-services
with uncommitted changes with your mozilla-central tree which also has uncommitted
changes.</p>
<p>To do this, you can edit the top-level <code>Cargo.toml</code> to specify a path. Note
however that in this scenario, you need to specify the path to the
individual component rather than to the top-level of the repo.</p>
<p>For example, you might end up with something like:</p>
<pre><code># application-services overrides to make updating them all simpler.
context_id = { path = "../application-services/components/context_id" }
error-support = { path = "../application-services/components/support/error" }
filter_adult = { path = "../application-services/components/filter_adult" }
interrupt-support = { path = "../application-services/components/support/interrupt" }
relevancy = { path = "../application-services/components/relevancy" }
search = { path = "../application-services/components/search" }
sql-support = { path = "../application-services/components/support/sql" }
suggest = { path = "../application-services/components/suggest" }
sync15 = { path = "../application-services/components/sync15" }
tabs = { path = "../application-services/components/tabs" }
tracing-support = { path = "../application-services/components/support/tracing" }
viaduct = { path = "../application-services/components/viaduct" }
webext-storage = { path = "../application-services/components/webext-storage" }
</code></pre>
<p>Note that when you first do this, it will still be necessary to run
<code>./mach vendor rust</code> and to re-build.</p>
<p>After you make a change to the local repository, you <em>do not</em> need to run
<code>./mach vendor rust</code>, but you do still obviously need to rebuild.</p>
<p>Once you are happy with all the changes, you would:</p>
<ul>
<li>Open a PR up in application-services and land your changes there.</li>
<li>Follow the process above to re-vendor your new changes, and in that same
bug (although not necessarily the same phabricator patch), include the other
mozilla-central changes which rely on the new version.</li>
</ul>
<footer id="open-on-gh-17">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/vendoring-into-mozilla-central.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="logging"><a href="#logging" class="header">Logging</a></h1>
<h2 id="application-services-logging"><a class="header" href="#application-services-logging">Application Services Logging</a></h2>
<p>When writing code in application-services, code implemented in Rust, Kotlin,
Java, or Swift might have to write debug logs. To do so, one should generally
log using the normal logging facilities for the language. Where the logs go
depends on the application which is embedding the components.</p>
<h3 id="accessing-logs-when-running-firefox-android"><a class="header" href="#accessing-logs-when-running-firefox-android">Accessing logs when running Firefox Android</a></h3>
<p>On android, logs currently go to logcat. (This may change in the future.)
Android Studio can be used to view the logcat logs; connect the device over USB
and view the Logcat tab at the bottom of Android Studio. Check to make sure you
have the right device selected at the top left of the Logcat pane, and the
correct process to the right of that. One trick to avoid having to select the
correct process (as there are main and content processes) is to choose “No
Filters” from the menu on the top right of the Logcat pane. Then, use the search
box to search for the log messages you are trying to find.</p>
<p>There are also many other utilities, command line and graphical, that can be
used to view logcat logs from a connected android device in a more flexible
manner.</p>
<h4 id="changing-the-loglevel-in-firefox-android"><a class="header" href="#changing-the-loglevel-in-firefox-android">Changing the loglevel in Firefox Android</a></h4>
<p>If you need more verbose logging, after the call to <code>RustLog.enable()</code> in
<code>FenixApplication</code>, you may call <code>RustLog.setMaxLevel(Log.Priority.DEBUG, true)</code>.</p>
<h3 id="accessing-logs-when-running-firefox-ios"><a class="header" href="#accessing-logs-when-running-firefox-ios">Accessing logs when running Firefox iOS</a></h3>
<p>If you’re using <code>Xcode</code>, then you can view the logs in the debugger.</p>
<p>If you’re not using <code>Xcode</code>, then:</p>
<ul>
<li>Navigate to the settings page</li>
<li>tap the version number 5 times to get to the secret menu</li>
<li>Select “copy log files to container”</li>
<li>Find the logs on your files folder</li>
</ul>
<h3 id="accessing-logs-when-running-firefox-desktop"><a class="header" href="#accessing-logs-when-running-firefox-desktop">Accessing logs when running Firefox Desktop</a></h3>
<p>[TODO]</p>
<footer id="open-on-gh-18">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/logging.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="uniffi-object-destruction-on-kotlin"><a class="header" href="#uniffi-object-destruction-on-kotlin">UniFFI object destruction on Kotlin</a></h1>
<p>UniFFI supports <a href="https://mozilla.github.io/uniffi-rs/udl/interfaces.htm">interface objects</a>, which are implemented by Boxing a Rust object and sending the raw pointer to the foreign code.  Once the objects are no longer in use, the foreign code needs to destroy the object and free the underlying resources.</p>
<p>This is slightly tricky on Kotlin.  <a href="https://web.archive.org/web/20230211201050/https://www.informit.com/articles/article.aspx?p=1216151&amp;seqNum=7">The prevailing Java wisdom is to use explicit destructors and avoid using finalizers for destruction</a>, which means we can’t simply rely on the garbage collector to free the pointer.  The wisdom seems simple to follow, but in practice it can be difficult to know how to apply it to specific situations.  This document examines provides guidelines for handling UniFFI objects.</p>
<h2 id="you-can-create-objects-in-a-function-if-you-also-destroy-them-there"><a class="header" href="#you-can-create-objects-in-a-function-if-you-also-destroy-them-there">You can create objects in a function if you also destroy them there</a></h2>
<p>The simplest way to get destruction right is to create an object and destroy it in the same function.  The <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/use.html">use</a> function makes this really easy:</p>
<pre><code>SomeUniFFIObject()
  .use { obj -&gt;
      obj.doSomething()
      obj.doSomethingElse()
  }
</code></pre>
<h2 id="you-can-create-and-store-objects-in-singletons"><a class="header" href="#you-can-create-and-store-objects-in-singletons">You can create and store objects in singletons</a></h2>
<p>If we are okay with UniFFI objects living for the entire application lifetime, then they can be stored in singletons.  This is how we handle our database connections, for example <a href="https://github.com/mozilla-mobile/firefox-android/blob/main/android-components/components/service/sync-logins/src/main/java/mozilla/components/service/sync/logins/SyncableLoginsStorage.kt#L98-L114">SyncableLoginsStorage</a> and <a href="https://github.com/mozilla-mobile/firefox-android/blob/9de5ab8cc098674aad5190ce8b00ae6be65e9bd0/android-components/components/browser/storage-sync/src/main/java/mozilla/components/browser/storage/sync/Connection.kt#L75-L96">PlacesReaderConnection</a>.</p>
<h2 id="you-can-create-and-store-objects-in-an-class-then-destroy-them-in-a-corresponding-lifecycle-method"><a class="header" href="#you-can-create-and-store-objects-in-an-class-then-destroy-them-in-a-corresponding-lifecycle-method">You can create and store objects in an class, then destroy them in a corresponding lifecycle method</a></h2>
<p>UniFFI objects can stored in classes like the Android <a href="https://developer.android.com/guide/fragments/lifecycle">Fragment</a> class that have a defined lifecycle, with methods called at different stages.  Classes can construct <code>UniFFI</code> objects in one of the lifecycle methods, then destroy it in the corresponding one.  For example, creating an object in <code>Fragment.onCreate</code> and destroying it in <code>Fragment.onDestroy()</code>.</p>
<h2 id="you-can-share-objects"><a class="header" href="#you-can-share-objects">You can share objects</a></h2>
<p>Several classes can hold references to an object, as long as (exactly) one class is responsible for managing it and destroying it when it’s not used. A good example is the <a href="https://github.com/mozilla-mobile/firefox-android/blob/009fb6350072b8b4cf2b87bd1a8f497843f67843/android-components/components/service/sync-logins/src/main/java/mozilla/components/service/sync/logins/GeckoLoginStorageDelegate.kt#L46-L49">GeckoLoginStorageDelegate</a>.  The <code>LoginStorage</code> is initialized and managed by another object, and <code>GeckoLoginStorageDelegate</code> is passed a (lazy) reference to it.</p>
<p>Care should be taken to ensure that once the managing class destroys the object, no other class attempts to use it.  If they do, then the generate code will raise an <code>IllegalStateException</code>.  This clearly should be avoided, although it won’t result in memory corruption.</p>
<h2 id="destruction-may-not-always-happen"><a class="header" href="#destruction-may-not-always-happen">Destruction may not always happen</a></h2>
<p>Destructors may not run when a process is killed, which can easily happen on Android.  This is especially true of lifecycle methods.  This is normally fine, since the OS will close resources like file handles and network connections on its own.  However, be aware that custom code in the destructor may not run.</p>
<footer id="open-on-gh-19">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/uniffi-object-destruction-on-kotlin.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="architectural-decision-log"><a class="header" href="#architectural-decision-log">Architectural Decision Log</a></h1>
<p>This log lists the architectural decisions for MADR.</p>
<!-- adrlog -- Regenerate the content by using `./update-readme.sh`. Make sure to install `adr-log` via `npm install -g adr-log` -->
<ul>
<li><a href="#use-markdown-architectural-decision-records">ADR-0000</a> - Use Markdown Architectural Decision Records</li>
<li><a href="#update-logins-api">ADR-0001</a> - Update Logins API</li>
<li><a href="#handling-database-corruption">ADR-0002</a> - Handling Database Corruption</li>
<li><a href="#distributing-swift-packages">ADR-0003</a> - Distributing Swift Packages</li>
<li><a href="#running-experiments-on-first-run-early-startup">ADR-0004</a> - Running experiments on first run early startup</li>
<li><a href="#a-remote-settings-client-for-our-mobile-browsers">ADR-0005</a> - A remote-settings client for our mobile browsers.</li>
<li><a href="#limit-visits-migrated-to-places-history-in-firefox-ios">ADR-0007</a> - Limit Visits Migrated to Places History in Firefox iOS</li>
<li><a href="adr/0008-fts-prefix-config.m">ADR-0008</a> - Full Text Search (FTS) prefix configuration</li>
<li><a href="adr/0009-use-tracing.html">ADR-0009</a> - Replace logging and error reporting infrastructure with tracing.</li>
</ul>
<!-- adrlogstop -->
<p>For new ADRs, please use <a href="adr/template.html">template.md</a> as basis.
More information on MADR is available at <a href="https://adr.github.io/madr/">https://adr.github.io/madr/</a>.
General information about architectural decision records is available at <a href="https://adr.github.io/">https://adr.github.io/</a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="use-markdown-architectural-decision-records"><a class="header" href="#use-markdown-architectural-decision-records">Use Markdown Architectural Decision Records</a></h1>
<h2 id="context-and-problem-statement"><a class="header" href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>We want to record architectural decisions made in this project.
Which format and structure should these records follow?</p>
<h2 id="considered-options"><a class="header" href="#considered-options">Considered Options</a></h2>
<ul>
<li><a href="https://adr.github.io/madr/">MADR</a> 2.1.2 – The Markdown Architectural Decision Records</li>
<li><a href="http://thinkrelevance.com/blog/2011/11/15/documenting-architecture-decisions">Michael Nygard’s template</a> – The first incarnation of the term “ADR”</li>
<li><a href="https://www.infoq.com/articles/sustainable-architectural-design-decisions">Sustainable Architectural Decisions</a> – The Y-Statements</li>
<li>Other templates listed at <a href="https://github.com/joelparkerhenderson/architecture_decision_record">https://github.com/joelparkerhenderson/architecture_decision_record</a></li>
<li>Formless – No conventions for file format and structure</li>
</ul>
<h2 id="decision-outcome"><a class="header" href="#decision-outcome">Decision Outcome</a></h2>
<p>Chosen option: “MADR 2.1.2”, because</p>
<ul>
<li>Implicit assumptions should be made explicit.
Design documentation is important to enable people understanding the decisions later on.
See also <a href="https://doi.org/10.1109/TSE.1986.6312940">A rational design process: How and why to fake it</a>.</li>
<li>The MADR format is lean and fits our development style.</li>
<li>The MADR structure is comprehensible and facilitates usage &amp; maintenance.</li>
<li>The MADR project is vivid.</li>
<li>Version 2.1.2 is the latest one available when starting to document ADRs.</li>
</ul>
<!-- markdownlint-disable-file MD013 -->
<footer id="open-on-gh-20">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/adr/0000-use-markdown-architectural-decision-records.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="update-logins-api"><a class="header" href="#update-logins-api">Update Logins API</a></h1>
<ul>
<li>Status: accepted</li>
<li>Date: 2021-06-17</li>
</ul>
<p>Technical Story: <a href="https://github.com/mozilla/application-services/issues/4101">#4101</a></p>
<h2 id="context-and-problem-statement-1"><a class="header" href="#context-and-problem-statement-1">Context and Problem Statement</a></h2>
<p>We no longer want to depend on SQLCipher and want to use SQLite directly for build complexity and concerns over the long term future of the rust bindings. The encryption approach taken by SQLCipher means that in practice, the entire database is decrypted at startup, even if the logins functionality is not interacted with, defeating some of the benefits of using an encrypted database.</p>
<p>The per-field encryption in autofill, which we are planning to replicate in logins, separates the storage and encryption logic by limiting the storage layer to the management of encrypted data. Applying this approach in logins will break the existing validation and deduping code so we need a way to implement per-field encryption while supporting the validation and de-duping behavior.</p>
<h2 id="decision-drivers"><a class="header" href="#decision-drivers">Decision Drivers</a></h2>
<ul>
<li>Addressing previously identified deficiencies in the logins API while we are breaking the API for the encryption work</li>
<li>Continuing to support the existing logins validation and deduping logic</li>
<li>Avoiding the implementation of new security approaches that may require additional time and security resources</li>
<li>Establishing a standard encryption approach across components</li>
</ul>
<h2 id="considered-options-1"><a class="header" href="#considered-options-1">Considered Options</a></h2>
<ul>
<li>Option 1 - Reduce the API functions that require the encryption key and pass the key to the remaining functions</li>
<li>Option 2 - Keep the general shape of the API that is in place now - the app can pass the encryption key at any time to “unlock” the API, and re-lock it at any time, but the API in its entirety is only available when unlocked</li>
</ul>
<h2 id="decision-outcome-1"><a class="header" href="#decision-outcome-1">Decision Outcome</a></h2>
<p>Chosen Option: “Reduce the API functions that require the encryption key and pass the key to the remaining functions” because it will not require a security review as similar to the approach we have established in the codebase.</p>
<h2 id="pros-and-cons-of-the-options"><a class="header" href="#pros-and-cons-of-the-options">Pros and Cons of the Options</a></h2>
<h3 id="option-1---reduce-the-api-functions-that-require-the-encryption-key-and-pass-the-key-to-the-remaining-functions"><a class="header" href="#option-1---reduce-the-api-functions-that-require-the-encryption-key-and-pass-the-key-to-the-remaining-functions">Option 1 - Reduce the API functions that require the encryption key and pass the key to the remaining functions</a></h3>
<ul>
<li>
<p>Description</p>
<p>Currently the below logins API functions would require the per-field encryption key:</p>
<ul>
<li>
<p><a href="https://github.com/mozilla/application-services/blob/1248a352cb2701b92395f2783bee8a88d18de455/components/logins/src/db.rs#L362">add</a></p>
</li>
<li>
<p><a href="https://github.com/mozilla/application-services/blob/1248a352cb2701b92395f2783bee8a88d18de455/components/logins/src/db.rs#L611">update</a></p>
</li>
<li>
<p><a href="https://github.com/mozilla/application-services/blob/1248a352cb2701b92395f2783bee8a88d18de455/components/logins/src/db.rs#L273">get_all</a></p>
</li>
<li>
<p><a href="https://github.com/mozilla/application-services/blob/1248a352cb2701b92395f2783bee8a88d18de455/components/logins/src/db.rs#L279">get_by_base_domain</a></p>
</li>
<li>
<p><a href="https://github.com/mozilla/application-services/blob/1248a352cb2701b92395f2783bee8a88d18de455/components/logins/src/db.rs#L330">get_by_id</a></p>
</li>
<li>
<p><a href="https://github.com/mozilla/application-services/blob/1248a352cb2701b92395f2783bee8a88d18de455/components/logins/src/db.rs#L663">check_valid_with_no_dupes</a></p>
</li>
<li>
<p><a href="https://github.com/mozilla/application-services/blob/1248a352cb2701b92395f2783bee8a88d18de455/components/logins/src/db.rs#L721">potential_dupes_ignoring_username</a></p>
</li>
<li>
<p><a href="https://github.com/mozilla/application-services/blob/1248a352cb2701b92395f2783bee8a88d18de455/components/logins/src/db.rs#L455">import_multiple</a></p>
<p><strong>Note:</strong></p>
<ul>
<li>Functions related to sync have been omitted as it is assumed they will have access to decrypted data.</li>
<li>The <code>get_all</code>, <code>get_by_base_domain</code>, and <code>get_by_id</code> functions will require the encryption key because they call the validate and fixup logic, not because we want to return logins with decrypted data.</li>
</ul>
</li>
</ul>
<p>Proposed changes:</p>
<ul>
<li>Combine the <code>add</code> and <code>update</code> functions into a new <code>add_or_update</code> function
<ul>
<li>This will allow the removal of consumer code that distinguishes when a login record should be created or updated</li>
<li><strong>Note:</strong> This function needs the encryption key for the fixup and deduping logic <em>and</em> for continued support of the accurate population of the <code>time_password_changed</code> field</li>
</ul>
</li>
<li>Pass the per-field encryption key to the <code>import_multiple</code> function
<ul>
<li>This function will be removed once the Fennec to Fenix migration period ends</li>
</ul>
</li>
<li>Remove both the <code>potential_dupes_ignoring_username</code> and <code>check_valid_with_no_dupes</code> from the API
<ul>
<li>Neither function is called in Firefox iOS</li>
<li>Android Components uses both to provide validation and de-duping before logins are added or updated so we can eliminate the need to externalize these functions by replicating this logic in the new <code>add_or_update</code> function</li>
</ul>
</li>
<li>Create a <code>decrypt_and_fixup_login</code> function that both decrypts a login <em>and</em> performs the validate and fixup logic
<ul>
<li>This will eliminate the need for the <code>get_all</code>, <code>get_by_base_domain</code>, and <code>get_by_id</code> API functions to perform the fixup logic</li>
</ul>
</li>
</ul>
<p>Making the above changes will reduce the API functions requiring the encryption key to the following:</p>
<ul>
<li><code>add_or_update</code></li>
<li><code>decrypt_and_fixup_login</code></li>
<li><code>import_multiple</code></li>
</ul>
</li>
<li>
<p>Pros</p>
<ul>
<li>Improves the logins API for consumers by combining add/update functionality (see <a href="https://github.com/mozilla/application-services/issues/3899">#3899</a> for details)</li>
<li>Removes redundant validation and de-duping logic in consumer code</li>
<li>Uses the same encryption model as autofill so there is consistency in our approaches</li>
</ul>
</li>
<li>
<p>Cons</p>
<ul>
<li>Requires consumer code to both encrypt login fields <em>and</em> pass the encryption key when calling either <code>add_or_update</code> and <code>import_multiple</code></li>
</ul>
</li>
</ul>
<h3 id="option-2---implement-a-different-key-management-approach"><a class="header" href="#option-2---implement-a-different-key-management-approach">Option 2 - Implement a different key management approach</a></h3>
<ul>
<li>
<p>Description</p>
<p>Unlike the first option, the publicly exposed login API would only handle decrypted login records and all encryption is internal (which works because we always have the key). Any attempt to use the API will fail as the login records are not encrypted or decrypted if the key is not available.</p>
<p>Proposed changes:</p>
<ul>
<li>Combine the <code>add</code> and <code>update</code> functions into <code>add_or_update</code></li>
<li>Remove both the <code>potential_dupes_ignoring_username</code> and <code>check_valid_with_no_dupes</code> from the API</li>
</ul>
</li>
<li>
<p>Pros</p>
<ul>
<li>Prevents the consumer from having to encrypt or decrypt login records</li>
<li>Maintains our current fixup and validation approach</li>
<li>Improves the logins API for consumers by combining add/update functionality</li>
<li>Removes redundant validation and de-duping logic in consumer code</li>
</ul>
</li>
<li>
<p>Cons</p>
<ul>
<li>Makes us responsible for securing the encryption key and will most likely require a security review</li>
</ul>
</li>
</ul>
<h2 id="links"><a class="header" href="#links">Links</a></h2>
<ul>
<li><a href="https://docs.google.com/drawings/d/1GZExe9lNpNDCoywpmg4RxHHNoqyaQ2CapbUyoM3K-KQ/edit?usp=sharing">Logins Validate and Fixup Call Tree</a></li>
</ul>
<footer id="open-on-gh-21">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/adr/0001-update-logins-api.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="handling-database-corruption"><a class="header" href="#handling-database-corruption">Handling Database Corruption</a></h1>
<ul>
<li>Status: accepted</li>
<li>Date: 2021-06-08</li>
</ul>
<h2 id="context-and-problem-statement-2"><a class="header" href="#context-and-problem-statement-2">Context and Problem Statement</a></h2>
<p>Some of our users have corrupt SQLite databases and this makes the related
component unusable.  The best way to deal with corrupt databases is to simply
delete the database and start fresh (#2628).  However, we only want to do this
for persistent errors, not transient errors like programming logic errors, disk
full, etc.  This ADR deals with 2 related questions:</p>
<ul>
<li>A) When and how do we identify corrupted databases?</li>
<li>B) What do we do when we identify corrupted databases?</li>
</ul>
<h2 id="decision-drivers-1"><a class="header" href="#decision-drivers-1">Decision Drivers</a></h2>
<ul>
<li>Deleting valid user data should be avoided at almost any cost</li>
<li>Keeping a corrupted database around is almost as bad.  It currently prevents
the component from working at all.</li>
<li>We don’t currently have a good way to distinguish between persistent and
transient errors, but this can be improved by reviewing telemetry and sentry
data.</li>
</ul>
<h2 id="considered-options-2"><a class="header" href="#considered-options-2">Considered Options</a></h2>
<ul>
<li>A) When and how do we identify corrupted databases?
<ul>
<li>1: Assume all errors when opening a database are from corrupt databases</li>
<li>2: Check for errors when opening a database and compare against known corruption error types</li>
<li>3: Check for errors for all database operations and compare against known corruption error types</li>
</ul>
</li>
<li>B) What do we do when we identify corrupted databases?
<ul>
<li>1: Delete the database file and recreate the database</li>
<li>2: Move the database file and recreate the database</li>
<li>3: Have the component fail</li>
</ul>
</li>
</ul>
<h2 id="decision-outcome-2"><a class="header" href="#decision-outcome-2">Decision Outcome</a></h2>
<ul>
<li>A2: Check for errors when opening a database and compare against known corruption error types</li>
<li>B1: Delete the database file and recreate the database</li>
</ul>
<p>Decision B follows from the choice of A.  Since we’re being conservative in
identifying errors, we can delete the database file with relative confidence.</p>
<p>“Check for errors for all database operations and compare against known
corruption error types” also seems like a reasonable solution that we may
pursue in the future, but we decided to wait for now.  Checking for errors
during opening time is the simpler solution to implement and should fix the
issue in many cases.  The plan is to implement that first, then monitor
sentry/telemetry to decide what to do next.</p>
<h1 id="pros-and-cons-of-the-options-1"><a class="header" href="#pros-and-cons-of-the-options-1">Pros and Cons of the Options</a></h1>
<h3 id="a1-assume-all-errors-when-opening-a-database-are-from-corrupt-databases"><a class="header" href="#a1-assume-all-errors-when-opening-a-database-are-from-corrupt-databases">A1: Assume all errors when opening a database are from corrupt databases</a></h3>
<ul>
<li>Good, because the sentry data indicates that many errors happen during opening time</li>
<li>Good, because migrations are especially likely to trigger corruption errors</li>
<li>Good, because it’s a natural time to delete the database – the consumer code
hasn’t run any queries yet and doesn’t have any open connections.</li>
<li>Bad, because it will delete valid user data in several situations that are
relatively common: migration logic errors, OOM errors, Disk full.</li>
</ul>
<h3 id="a2-check-for-errors-when-opening-a-database-and-compare-against-known-corruption-error-types-decided"><a class="header" href="#a2-check-for-errors-when-opening-a-database-and-compare-against-known-corruption-error-types-decided">A2: Check for errors when opening a database and compare against known corruption error types (Decided)</a></h3>
<ul>
<li>Good, because should eliminate the possibility of deleting valid user data.</li>
<li>Good, because the sentry data indicates that many errors happen during opening time</li>
<li>Good, because it’s a natural time to delete the database – the consumer code
hasn’t run any queries yet and doesn’t have any open connections.</li>
<li>Bad, because we don’t currently have a good list corruption errors</li>
</ul>
<h3 id="a3-check-for-errors-for-all-database-operations-and-compare-against-known-corruption-error-types"><a class="header" href="#a3-check-for-errors-for-all-database-operations-and-compare-against-known-corruption-error-types">A3: Check for errors for all database operations and compare against known corruption error types</a></h3>
<ul>
<li>Good, because the sentry data indicates that many errors happen outside of opening time</li>
<li>Good, because should eliminate the possibility of deleting valid user data.</li>
<li>Bad, because the consumer code probably doesn’t expect the database to be
deleted and recreated in the middle of a query.  However, this is just an
extreme case of normal database behavior – for example any given row can be
deleted during a sync.</li>
<li>Bad, because we don’t currently have a good list corruption errors</li>
</ul>
<h3 id="b1-delete-the-database-file-and-recreate-the-database-decided"><a class="header" href="#b1-delete-the-database-file-and-recreate-the-database-decided">B1: Delete the database file and recreate the database (Decided)</a></h3>
<ul>
<li>Good, because it would allow users with corrupted databases to use the
affected components again</li>
<li>Bad, because any misidentification will lead to data loss.</li>
</ul>
<h3 id="b2-move-the-database-file-and-recreate-the-database"><a class="header" href="#b2-move-the-database-file-and-recreate-the-database">B2: Move the database file and recreate the database</a></h3>
<p>This option would be similar to 1, but instead of deleting the file we would
move it to a backup location.  When we started up, we could look for backup
files and try to import lost data.</p>
<ul>
<li>Good, because if we misidentify corrupt databases, then we have the
possibility of recovering the data</li>
<li>Good, because it allows a way for users to delete their data (in theory).
If the consumer code executed a <code>wipe()</code> on the database, we could also
delete any backup data.</li>
<li>Bad, because it’s very difficult to write a recovery function that merged
deleted data with any new data.  This function would be fairly hard to test
and it would be easy to introduce a new logic error.</li>
<li>Bad, because it adds significant complexity to the database opening code</li>
<li>Bad, because the user experience would be strange.  A user would open the
app, discover that their data was gone, then sometime later discover that the
data is back again.</li>
</ul>
<h3 id="b3-return-a-failure-code"><a class="header" href="#b3-return-a-failure-code">B3: Return a failure code</a></h3>
<ul>
<li>Good, because this option leaves no chance of user data being deleted</li>
<li>Good, because it’s the simplest to implement</li>
<li>Bad, because the component will not be usable if the database is corrupt</li>
<li>Bad, because the user’s data is potentially exposed in the corrupted database
file and we don’t provide any way for them to delete it.</li>
</ul>
<footer id="open-on-gh-22">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/adr/0002-database-corruption.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="distributing-swift-packages"><a class="header" href="#distributing-swift-packages">Distributing Swift Packages</a></h1>
<ul>
<li>Status: accepted</li>
<li>Deciders: rfkelly</li>
<li>Date: 2021-07-22</li>
</ul>
<h2 id="context-and-problem-statement-3"><a class="header" href="#context-and-problem-statement-3">Context and Problem Statement</a></h2>
<p>Our iOS consumers currently obtain application-services as a pre-compiled <code>.framework</code> bundle
distributed via <a href="https://github.com/Carthage/Carthage">Carthage</a>. The current setup is not
compatible with building on new M1 Apple Silicon machines and has a number of other problems.
As part of a broader effort to modernize the build process of iOS applications at Mozilla,
we have been asked to re-evaluate how application-services components are dsitributed for iOS.</p>
<p>See <a href="#problems-with-the-current-setup">Problems with the current setup</a> for more details.</p>
<h2 id="decision-drivers-2"><a class="header" href="#decision-drivers-2">Decision Drivers</a></h2>
<ul>
<li>Ease-of-use for iOS consumers.</li>
<li>Compatibility with M1 Apple Silicon machines.</li>
<li>Consistency with other iOS components being developed at Mozilla.</li>
<li>Ability for the Nimbus Swift bindings to easily depend on Glean.</li>
<li>Ease of maintainability for application-services developers.</li>
</ul>
<h2 id="considered-options-3"><a class="header" href="#considered-options-3">Considered Options</a></h2>
<ul>
<li><strong>(A) Do Nothing</strong>
<ul>
<li>Keep our current build and distribution setup as-is.</li>
</ul>
</li>
<li><strong>(B) Use Carthage to build XCFramework bundles</strong>
<ul>
<li>Make a minimal change to our Carthage setup so that it builds
the newer XCFramework format, which can support M1 Apple Silicon.</li>
</ul>
</li>
<li><strong>(C) Distribute a single pre-compiled Swift Package</strong>
<ul>
<li>Convert the all-in-one <code>MozillaAppServices</code> Carthage build to a similar
all-in-one Swift Package, distributed as a binary artifact.</li>
</ul>
</li>
<li><strong>(D) Distribute multiple source-based Swift Package targets, with pre-compiled Rust code</strong>
<ul>
<li>Split the all-in-one <code>MozillaAppServices</code> Carthage build into a separate
Swift Package target for each component, with a shared dependency on pre-compiled
Rust code as a binary artiact.</li>
</ul>
</li>
</ul>
<h2 id="decision-outcome-3"><a class="header" href="#decision-outcome-3">Decision Outcome</a></h2>
<p>Chosen option: <strong>(D) Distribute multiple source-based Swift Packages, with pre-compiled Rust code</strong>.</p>
<p>This option will provide the best long-term consumer experience for iOS developers, and
has the potential to simplify maintenance for application-services developers after an
initial investment of effort.</p>
<h3 id="positive-consequences"><a class="header" href="#positive-consequences">Positive Consequences</a></h3>
<ul>
<li>Swift packages are very convenient to consume in newer versions of Xcode.</li>
<li>Different iOS apps can choose to import a different subset of the available components,
potentiallying helping keep application size down.</li>
<li>Avoids issues with mis-matched Swift version between application-services build
and consumers, since Swift files are distributed in source form.</li>
<li>Encourages better conceptual separation between Swift code for different components;
e.g. it will make it possible for two Swift components to define an item of the same
name without conflicts.</li>
<li>Reduces the need to use Xcode as part of application-services build process, in favour
of command-line tools.</li>
</ul>
<h3 id="negative-consequences"><a class="header" href="#negative-consequences">Negative Consequences</a></h3>
<ul>
<li>More up-front work to move to this new setup.</li>
<li>We may be less likely to notice if our build setup breaks when used from within Xcode,
because we’re not exercising that code path ourselves.</li>
<li>May be harder to concurrently publish a Carthage framework for current consumers who aren’t
able to move to Swift packages.</li>
<li>There is likely to be some amount of API breakage for existing consumers, if only in having
to replace a single <code>import MozillaAppServices</code> with independent imports of each component.</li>
</ul>
<h3 id="implementation-sketch"><a class="header" href="#implementation-sketch">Implementation Sketch</a></h3>
<p>We will maintain the existing Carthage build infrastructure in the application-services repo and continue publishing a pre-built Carthage framework,
to support firefox-ios until they migrate to Swift Packages.</p>
<p>We will add an additional iOS build task in the application-services repo, that builds <em>just the Rust code</em> as a <code>.xcframework</code> bundle.
An initial prototype shows that this can be achieved using a relatively straightforward shell script, rather than requiring a second Xcode project.
It will be published as a <code>.zip</code> artifact on each release in the same way as the current Carthage framework.
The Rust code will be built as a static library, so that the linking process of the consuming application can pull in
just the subset of the Rust code that is needed for the components it consumes.</p>
<p>We will initially include only Nimbus and its dependencies in the <code>.xcframework</code> bundle,
but will eventually expand it to include all Rust components (including Glean, which will continue
to be included in the <code>application-services</code> repo as a git submodule)</p>
<p>We will create a new repository <code>rust-components-swift</code> to serve as the root of the new Swift Package distribution.
It will import the <code>application-services</code> repository as a git submodule. This will let us iterate quickly on the
Swift packaging setup without impacting existing consumers.</p>
<p>We will initially include only Nimbus and its dependencies in this new repository, and the Nimbus swift code
it will depend on Glean via the external <code>glean-swift</code> package. In the future we will publish all application-services
components that have a Swift interface through this repository, as well as Glean and any future Rust components.
(That’s why the repository is being given a deliberately generic name).</p>
<p>The <code>rust-components-swift</code> repo will contain a <code>Package.swift</code> file that defines:</p>
<ul>
<li>A single binary target that references the pre-built <code>.xcframework</code> bundle of Rust code.</li>
<li>One Swift target for each component, that references the Swift code from the git submodule
and depends on the pre-built Rust code.</li>
</ul>
<p>We will add automation to the <code>rust-components-swift</code> repo so that it automatically tracks
releases made in the <code>application-services</code> repo and creates a corresponding git tag for
the Swift package.</p>
<p>At some future date when all consumers have migrated to using Swift packages, we will remove
the Carthage build setup from the application-services repo.</p>
<p>At some future date, we will consider whether to move the <code>Package.swift</code> definition in to the <code>application-services</code> repo,
or whether it’s better to keep it separate. (Attempting to move it into the <code>application-services</code> will involve non-trivial
changes to the release process, because the checksum of the released <code>.xcframework</code> bundle needs to be included in
the release tagged version of the <code>Package.swift</code> file.)</p>
<h1 id="pros-and-cons-of-the-options-2"><a class="header" href="#pros-and-cons-of-the-options-2">Pros and Cons of the Options</a></h1>
<h3 id="a-do-nothing"><a class="header" href="#a-do-nothing"><strong>(A) Do Nothing</strong></a></h3>
<p>In this option, we would make no changes to our iOS build and publishing process.</p>
<ul>
<li>Good, because it’s the least amount of work.</li>
<li>Neutral, because it doesn’t change the maintainability of the system for appservices
developers.</li>
<li>Neutral, because it doesn’t change the amount of separation between Swift code
for our various components.</li>
<li>Neutral, because it doesn’t address the Swift version incompatibility issues around
binary artifacts.</li>
<li>Bad, because it will frustrate consumers who want to develop on M1 Apple Silicon.</li>
<li>Bad, because it may prevent consumers from migrating to a more modern build setup.</li>
<li>Bad, because it would prevent consumers from consuming Glean as a Swift package;
we would require them to use the Glean that is bundled in our build.</li>
</ul>
<p>This option isn’t really tractable for us, but it’s included for completeness.</p>
<h3 id="b-use-carthage-to-build-xcframework-bundles"><a class="header" href="#b-use-carthage-to-build-xcframework-bundles"><strong>(B) Use Carthage to build XCFramework bundles</strong></a></h3>
<p>In this option, we would try to change our iOS build and publishing process as little
as possible, but use Carthage’s recent support for <a href="https://github.com/Carthage/carthage#building-platform-independent-xcframeworks-Xcode-12-and-above">building platform-independent
XCFrameworks</a> in order
to support consumers running on M1 Apple Silicon.</p>
<ul>
<li>Good, because the size of the change is small.</li>
<li>Good, because we can support development on newer Apple machines.</li>
<li>Neutral, because it doesn’t change the maintainability of the system for appservices
developers.</li>
<li>Neutral, because it doesn’t change the amount of separation between Swift code
for our various components.</li>
<li>Neutral, because it doesn’t address the Swift version incompatibility issues around
binary artifacts.</li>
<li>Bad, because our iOS consumers have expressed a preference for moving away from Carthage.</li>
<li>Bad, because other iOS projects at Mozilla are moving to Swift Packages, making
us inconsistent with perceived best practice.</li>
<li>Bad, because it would prevent consumers from consuming Glean as a Swift package;
we would require them to use the Glean that is bundled in our build.</li>
<li>Bad, because consumers don’t get to choose which components they want to use (without
us building a whole new “megazord” with just the components they want).</li>
</ul>
<p>Overall, current circumstances feel like a good opportunity to invest a little more
time in order to set ourselves up for better long-term maintainability
and happier consumers. The main benefit of this option (it’s quicker!) is less attractive
under those circumstances.</p>
<h3 id="c-distribute-a-single-pre-compiled-swift-package"><a class="header" href="#c-distribute-a-single-pre-compiled-swift-package"><strong>(C) Distribute a single pre-compiled Swift Package</strong></a></h3>
<p>In this option, we would compile the Rust code and Swift code for all our components into
a single <code>.xcframework</code> bundle, and then distribute that as a
<a href="https://developer.apple.com/documentation/swift_packages/distributing_binary_frameworks_as_swift_packages">binary artifact</a> via Swift Package. This is similar to the approach
currently taken by Glean (ref <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1711447">Bug 1711447</a>)
except that they only have a single component.</p>
<ul>
<li>Good, because Swift Packages are the preferred distribution format for new iOS consumers.</li>
<li>Good, because we can support development on newer Apple machines.</li>
<li>Good, because it aligns with what other iOS component developers are doing at Mozilla.</li>
<li>Neutral, because it doesn’t change the maintainability of the system for appservices
developers.
<ul>
<li>(We’d need to keep the current Xcode project broadly intact).</li>
</ul>
</li>
<li>Neutral, because it doesn’t change the amount of separation between Swift code
for our various components.</li>
<li>Neutral, because it doesn’t address the Swift version incompatibility issues around
binary artifacts.</li>
<li>Neutral, because it would prevent consumers from consuming Glean as a separate Swift package;
they’d have to get it as part of <em>our</em> all-in-one Swift package.</li>
<li>Bad, because it’s a larger change and we have to learn about a new package manager.</li>
<li>Bad, because consumers don’t get to choose which components they want to use (without
building a whole new “megazord” with just the components they want).</li>
</ul>
<p>Overall, this option would be a marked improvement on the status quo, but leaves out some potential
improvements. For not that much more work, we can make some of the “Neutral” and “Bad” points
here into “Good” points.</p>
<h3 id="d-distribute-multiple-source-based-swift-packages-with-pre-compiled-rust-code"><a class="header" href="#d-distribute-multiple-source-based-swift-packages-with-pre-compiled-rust-code"><strong>(D) Distribute multiple source-based Swift Packages, with pre-compiled Rust code</strong></a></h3>
<p>In this option, we would compile <em>just the Rust code</em> for all our components into a single
<code>.xcframework</code> bundle and distribute that as a <a href="https://developer.apple.com/documentation/swift_packages/distributing_binary_frameworks_as_swift_packages">binary artifact</a> via Swift Package.
We would then declare a separate Swift <em>source</em> target for the Swift wrapper of each component,
each depending on the compiled Rust code but appearing as a separate item in the Swift package
definition.</p>
<ul>
<li>Good, because Swift Packages are the preferred distribution format for new iOS consumers.</li>
<li>Good, because we can support development on newer Apple machines.</li>
<li>Good, because it aligns with what other iOS component developers are doing at Mozilla.</li>
<li>Good, because it can potentially simplify the maintenance of the system for appservices
developers, by removing Xcode in favour of some command-line scripts.</li>
<li>Good, because it introduces strict separation between the Swift code for each component,
instead of compiling them all together in a single shared namespace.</li>
<li>Good, because the Nimbus Swift package could cleanly depend on the Glean Swift package.</li>
<li>Good, because consumers can choose which components they want to include.</li>
<li>Good, because it avoids issues with Swift version incompatibility in binary artifacts.</li>
<li>Bad, because it’s a larger change and we have to learn about a new package manager.</li>
</ul>
<p>The only downside to this option appears to be the amount of work involved, but an initial
prototype has given us some confidence that the change is tractable and that it may lead
to a system that is easier to maintain over time. It is thus our preferred option.</p>
<h1 id="appendix"><a class="header" href="#appendix">Appendix</a></h1>
<h2 id="further-reading"><a class="header" href="#further-reading">Further Reading</a></h2>
<ul>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1711447">Bug 1711447</a> has good historical context on the work to move Glean to using a Swift Package.</li>
<li>Some material on swift packages:
<ul>
<li><a href="https://www.swiftbysundell.com/articles/managing-dependencies-using-the-swift-package-manager/">Managing dependencies using the Swift Package Manager</a> was a useful overview.</li>
<li><a href="https://www.timc.dev/posts/understanding-swift-packages/">Understanding Swift Packages and Dependency Declarations</a> gives a bit of a deeper dive into having multiple targets
with different names in a single package.</li>
</ul>
</li>
<li>Outputs of initial prototype:
<ul>
<li>A prototype of Option (C): <a href="https://github.com/mozilla/application-services/pull/4216">Nimbus + Glean as a pre-built XCFramework Swift Package</a></li>
<li>A prototype of Option (D): <a href="https://github.com/mozilla/application-services/pull/4225">Rust code as XCFRamework</a> plus a <a href="https://github.com/rfk/rust-components-swift">Multi-product Swift Package</a> that depends on it.
<ul>
<li>A <a href="https://drive.google.com/file/d/12xsOMoFkxHZAEZ8tL5gBaiTYTYoQN1OO/view">video demo</a> of the resulting consumer experience.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="problems-with-the-current-setup"><a class="header" href="#problems-with-the-current-setup">Problems with the current setup</a></h2>
<p>It doesn’t build for M1 Apple Silicon machines, because it’s not possible to support
both arm64 device builds and arm64 simulator builds in a single binary <code>.framework</code>.</p>
<p>Carthage is dispreferred by our current iOS consumers.</p>
<p>We don’t have much experience with the setup on the current Application Services team,
and many of its details are under-documented. Changing the build setup requires Xcode
and some baseline knowledge of how to use it.</p>
<p>All components are built as a single Swift module, meaning they can see each other’s
internal symbols and may accidentally conflict when naming things. For example we can’t
currently have two components that define a structure of the same name.</p>
<p>Consumers can only use the pre-built binary artifacts if they are using the same
version of Xcode as was used during the application-services build. We are not able
to use Swift’s <code>BUILD_LIBRARY_FOR_DISTRIBUTION</code> flag to overcome this, because some
of our dependencies do not support this flag (specifically, the Swift protobuf lib).</p>
<footer id="open-on-gh-23">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/adr/0003-swift-packaging.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="running-experiments-on-first-run-early-startup"><a class="header" href="#running-experiments-on-first-run-early-startup">Running experiments on first run early startup</a></h1>
<ul>
<li>Status: rejected</li>
<li>Deciders: teshaq, travis, k88hudson, jhugman, jaredlockhart</li>
<li>Date: 2021-08-16</li>
</ul>
<p>Technical Story: https://mozilla-hub.atlassian.net/browse/SDK-323</p>
<h2 id="context-and-problem-statement-4"><a class="header" href="#context-and-problem-statement-4">Context and Problem Statement</a></h2>
<p>As an experimenter, I would like to run experiments early on a user’s first run of the application. However, the experiment data is only available on the second run. We would like to have that experiment data available before the user’s first run.
For more information: https://docs.google.com/document/d/1Qw36_7G6XyHvJZdM-Hxh4nqYZyCsYajG0L5mO33Yd5M/edit</p>
<h2 id="decision-drivers-3"><a class="header" href="#decision-drivers-3">Decision Drivers</a></h2>
<ul>
<li>Availability of experiments early on the first run</li>
<li>No impact on experimentation data analysis</li>
<li>Flexibility in creating experiments</li>
<li>Ability to quickly disable experiments</li>
<li>Simplicity of releases</li>
<li>Mobile’s expectations of Nimbus (The SDK should be idempotent)</li>
</ul>
<h2 id="considered-options-4"><a class="header" href="#considered-options-4">Considered Options</a></h2>
<ul>
<li><strong>(A) Do Nothing</strong>
<ul>
<li>Keep everything the way it is, preventing us from experimenting on users early on their first run</li>
</ul>
</li>
<li><strong>(B) Bundle Experiment data with app on release</strong>
<ul>
<li>On release, have an <code>initial_experiments.json</code> that defines the experiments that will be applied early on the first run</li>
<li>Later on the first run, the client would retrieve the actual experiment data from remote-settings and overwrite the bundled data</li>
</ul>
</li>
<li><strong>(C) Retrieve Experiment data on first run, and deal with delay</strong>
<ul>
<li>We can retrieve the experiment data on the first run, experiment data however will not be available until after a short delay (network I/O + some disk I/O)</li>
</ul>
</li>
</ul>
<h2 id="decision-outcome-4"><a class="header" href="#decision-outcome-4">Decision Outcome</a></h2>
<p>None of the options were feasible, so for now we are sticking with option <strong>(A) Do Nothing</strong> until there are experiments planned that are expected to run on early startup on the first run, then we will revaluate our options.</p>
<p>The <strong>(B) Bundle Experiment data with app on release</strong> option was rejected mainly due to difficulty in disabling experiments and pausing enrollments. This can create a negative user experience as it prevents us from disabling any problematic experiments. Additionally, it ties experiment creation with application release cycles.</p>
<p>The <strong>(C) Retrieve Experiment data on first run, and deal with delay</strong> option was rejected due to the fact it changes the Nimbus SDK will no longer be idempotent,and the possibility of introducing undesirable UI.</p>
<h2 id="pros-and-cons-of-the-options-3"><a class="header" href="#pros-and-cons-of-the-options-3">Pros and Cons of the Options</a></h2>
<h3 id="do-nothing"><a class="header" href="#do-nothing">Do nothing</a></h3>
<ul>
<li>Good, because it keeps the flexibility in experiment creation</li>
<li>Good, because disabling experiments can still done remotely for all experiments</li>
<li>Good, because it keeps the Nimbus SDK idempotent.</li>
<li>Bad, because it doesn’t address the main problem of exposing experiments to user on their first run</li>
</ul>
<h3 id="bundle-experiment-data-with-app-on-release"><a class="header" href="#bundle-experiment-data-with-app-on-release">Bundle Experiment data with app on release</a></h3>
<ul>
<li>Good, because it allows us to run experiments early on a user’s first run</li>
<li>Good, because it prevents us from having to wait for experiments, especially if a user has a slow network connection</li>
<li>Bad, because it ties experiment creation with release cycles</li>
<li>Bad, because it prevents us from disabling problematic first-run experiments without a dot release</li>
<li>Bad, because it prevents us from pausing enrollment on first-run experiments without a dot release</li>
<li>Bad, because it requires investment from the console team, and can modify existing flows.</li>
</ul>
<h3 id="retrieve-experiment-data-on-first-run-and-deal-with-delay"><a class="header" href="#retrieve-experiment-data-on-first-run-and-deal-with-delay">Retrieve Experiment data on first run, and deal with delay</a></h3>
<ul>
<li>Good, because it enables us to retrieve experiments for users on their first run</li>
<li>Good, because it keeps the flexibility in experiment creation</li>
<li>Good, because disabling experiments can still done remotely for all experiments</li>
<li>Bad, because experiments may not be ready early on the user’s experience</li>
<li>Bad, because it forces the customer application to deal with either the delay, or changing the configuration shortly after startup. e.g. a loading spinner or a pre-onboarding screen not under experimental control; delaying initialization of onboarding screens until after experiments have been loaded.</li>
<li>Bad, because it changes the programming model from Nimbus being an idempotent configuration store to configuration changing non-deterministically.</li>
<li>Bad, because the experimentation platform could force the app to add unchangeable user interface for the entire population. This itself may have an effect on key metrics.</li>
</ul>
<h2 id="links-1"><a class="header" href="#links-1">Links</a></h2>
<ul>
<li><a href="https://docs.google.com/document/d/1Qw36_7G6XyHvJZdM-Hxh4nqYZyCsYajG0L5mO33Yd5M/edit#heading=h.b1n8hquqkety">RFC for bundling into iOS and Fenix</a></li>
<li>Document presented to product managers about <strong>(C) Retrieve Experiment data on first run, and deal with delay</strong>: https://docs.google.com/document/d/1X1hC3t5zC7-Rp0OPIoiUr_ueLOAI0ez_jqslaNzOHjY/edit</li>
<li>Demo presenting option <strong>(C) Retrieve Experiment data on first run, and deal with delay</strong>: https://drive.google.com/file/d/19HwnlwrabmSNsB7tjW2l4kZD3PWABi4u/view?usp=sharing</li>
</ul>
<footer id="open-on-gh-24">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/adr/0004-early-startup-experiments.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="a-remote-settings-client-for-our-mobile-browsers"><a class="header" href="#a-remote-settings-client-for-our-mobile-browsers">A remote-settings client for our mobile browsers.</a></h1>
<ul>
<li>
<p>Status: proposed</p>
</li>
<li>
<p>Discussion: https://github.com/mozilla/application-services/pull/5302</p>
</li>
<li>
<p>Deciders:</p>
<ul>
<li>csadilek for the mobile teams ✔️</li>
<li>leplatrem for the remote-settings team ✔️</li>
<li>mhammond for the application-services team ✔️</li>
</ul>
</li>
<li>
<p>Date: 2022-12-16</p>
</li>
</ul>
<h2 id="context-and-problem-statement-5"><a class="header" href="#context-and-problem-statement-5">Context and Problem Statement</a></h2>
<p>Mozilla’s mobile browsers have a requirement to access the remote settings service, but currently lack any libraries or tools which are suitable without some work.
A concrete use case is the management of search engine configurations, which are stored in Remote Settings for Firefox Desktop, but shipped as individual files on our mobile browsers, requiring application releases for all changes.</p>
<p>A constraint on any proposed solutions is that this work will be performed by Mozilla’s mobile team, who have limited experience with Rust, and that it is required to be completed in Q1 2023.</p>
<p>This document identifies the requirements, then identifies tools which already exist and are close to being suitable, then identifies all available options we can take, and outlines our decision.</p>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<p>The requirements are for a library which is able to access Mozilla’s Remote Settings service and return the results to our mobile browsers.
This list of requirements is not exhaustive, but instead focuses on the requirements which will drive our decision making process.
As such, it identifies the non-requirements first.</p>
<h3 id="non-requirements"><a class="header" href="#non-requirements">Non-requirements</a></h3>
<p>The following items all may have some degree of desirability, but they are not hard requirements for the initial version</p>
<ul>
<li>While the https connection to the server must be validated, there is no requirement to verify the content received by the server - ie, there’s no requirement to check the signature of the body itself.</li>
<li>There’s no requirement to validate the result of the server conforms to a pre-defined schema - we trust the server data.</li>
<li>There’s no requirement to return strongly-typed data to the applications - returning a JSON string/object is suitable.</li>
<li>There’s no requirement to cache server responses to the file-system - if the app requests content, it’s fine for the library to always hit the server.</li>
<li>There’s no requirement for any kind of scheduling or awareness of network state - when we are requested for content, we do it immediately and return an appropriate error if it can not be fetched.</li>
<li>There’s no requirement to support publishing records, requesting reviews or providing approvals via this new library.</li>
<li>There’s no requirement that push be used to communicate changes to the application (eg, to enable rapid-enrolment type features)</li>
<li>There’s no requirement to manage buckets, groups and collections via this new library.</li>
</ul>
<h3 id="initial-requirements"><a class="header" href="#initial-requirements">Initial Requirements</a></h3>
<p>The requirements we do have for the initial version are:</p>
<ul>
<li>The library should allow fetching records from Mozilla’s Remote Settings servers. This includes support for attachments, and fetching <a href="https://docs.kinto-storage.org/en/latest/api/1.x/filtering.html#polling-for-changes">incremental changes</a>.</li>
<li>The library should not create threads or run any event loops - the mobile apps themselves are responsible for all threading requirements. While this might change in the future, considering this kind of change to our mobile applications is out of scope for this project.</li>
<li>We must use Necko for all networking on Android, must enforce all connections are via valid https hosts (although some test-only exceptions might be helpful for QA, such as allowing localhost connections to be http)</li>
<li>The library should be the only remote-settings library used in the browser. Specifically, this means that Nimbus must also be capable of using the library, and the work to move Nimbus to the library must be considered as part of the project.</li>
</ul>
<h2 id="existing-libraries"><a class="header" href="#existing-libraries">Existing Libraries</a></h2>
<p>We have identified the following libraries which may be suitable for this project.</p>
<h3 id="remote-settings-on-desktop"><a class="header" href="#remote-settings-on-desktop">Remote-settings on desktop</a></h3>
<p>There is a version of the <a href="https://searchfox.org/mozilla-central/source/services/settings/RemoteSettingsClient.jsm">remote settings client in desktop</a>, written in Javascript.
It has been used and been relatively stable since at least 2018, so can be considered very capable, but the roadblock to it being suitable for use by our mobile browsers is that it is written in Javascript, so while it might be possible to expose it to Android via geckoview, there’s no reasonable path to have it made available to iOS.</p>
<h3 id="rust-remote-settings-client"><a class="header" href="#rust-remote-settings-client">Rust Remote Settings Client</a></h3>
<p>There is an existing <a href="https://github.com/mozilla-services/remote-settings-client">remote settings client on github</a>.
This client is written in Rust and has evolved over a number of years.
The most recent changes were made to support being used in <a href="https://github.com/mozilla-services/merino">Merino</a>, which was re-written in Python, so there are no known consumers of this library left.</p>
<p>The main attributes of this library relevant to this discussion are:</p>
<ul>
<li>It’s written in Rust, but has no FFI - ie, it’s currently only consumable by other Rust code.</li>
<li>It has recently been updated to use async rust, so requires an internal event loop.</li>
<li>It includes the capability to verify the signatures of the content.</li>
</ul>
<h3 id="the-nimbus-sdk-client"><a class="header" href="#the-nimbus-sdk-client">The Nimbus-sdk Client</a></h3>
<p>The <a href="https://github.com/mozilla/application-services/tree/main/components/nimbus">nimbus-sdk is a component in the application-services repository</a> written in Rust. It has client code which talks to the remote-settings server and while this has only actually been used with the “Nimbus” collection there’s no reason to believe it can’t be used in the more general case.
The main attributes of this library relevant to this discussion are:</p>
<ul>
<li>It’s consumed by a component which is already consumed by our mobile browsers via UniFFI.</li>
<li>It does not verify the signatures of the content - while this could be done, there hasn’t been sufficient justification made for this (ie, there are no realistic threat models which would be solved by this capability.)</li>
<li>The client itself does not persist a local cache of remote resources, but instead delegates this responsibility to the consuming application (in this case, nimbus itself, which does persist them via the <a href="https://github.com/mozilla/rkv">rkv library</a>)</li>
<li>It does not use async Rust, but instead everything is blocking and run on threads exclusively created by the app itself.</li>
<li>It has good test support, which run against a docker image.</li>
</ul>
<h2 id="considered-options-5"><a class="header" href="#considered-options-5">Considered Options</a></h2>
<h3 id="option-1-writing-a-new-library"><a class="header" href="#option-1-writing-a-new-library">Option 1: Writing a new library</a></h3>
<p>The requirements of this client are such that writing new libraries in Kotlin and Swift is currently a realistic option.
However, we are rejecting this option because we don’t want to duplicate the effort required to write and maintain two libraries - inevitably, the features and capabilities will diverge.
Future requirements such as supporting content signature verification would lead to significant duplication.</p>
<p>Writing a new library from scratch in Rust and exposing it via UniFFI so it can be used by both platforms is also a possibility.
However, we are rejecting this option because existing Rust libraries already exist, so we would be better served by modifying or forking one of the existing libraries.</p>
<h3 id="option-2-use-the-existing-remote-settings-client"><a class="header" href="#option-2-use-the-existing-remote-settings-client">Option 2: Use the existing remote settings client</a></h3>
<p>Modifying or forking the existing client is an attractive option.
It would require a number of changes - the async capabilities would probably need to be removed (using a Rust event loop in our mobile browsers is something we are trying to avoid until we better understand the implications given these browsers already have an event loop and their own threading model).</p>
<p>The persistence model used by this library is something that is not a requirement for the new library, which isn’t itself a problem, but it probably would preclude being able to use this library by Nimbus - so the end result is that we would effectively have two remote-settings clients written in Rust and used by our browsers.</p>
<p>Some API changes would probably be required to make it suitable for use by UniFFI would also be necessary, but these would be tractable.</p>
<p>We would need to update nimbus to use this client, which would almost certainly require moving this client into the application-services repository to avoid the following issues:</p>
<ul>
<li>Marrying the persistence model of this client with the existing rkv-based persistence used by nimbus would be required.</li>
<li>Ensuring the upstream version changes continued to work for us.</li>
<li>Managing the circular dependency which exists due to this library needing to use viaduct.</li>
<li>Complication of our build process because the library needs to end up in our “megazord”.
These are the exact reasons why Nimbus itself is in the application-services repo.</li>
</ul>
<h3 id="option-3-use-the-existing-nimbus-client"><a class="header" href="#option-3-use-the-existing-nimbus-client">Option 3: Use the existing nimbus client</a></h3>
<p>Splitting the <a href="https://github.com/mozilla/application-services/blob/6069bd26d742f9597ab7e62d8df23ad634c7bd98/components/nimbus/src/client/http_client.rs#L9">existing client</a> out from Nimbus in a way that allows Nimbus to continue to use it, while also making it available for stand-alone use is also an attractive option.</p>
<p>In particular, the feature set of that client overlaps with the requirements of the new library - no local persistence is necessary and no signature verification is required. It is already used by a component which is exposed via UniFFI.</p>
<p>Note that this option does not preclude both Nimbus and this new crate from moving to the existing remote settings client at some point in the future.
A key benefit of this decision is that it keeps nimbus and the new crate using the same client, so updating both to use a different client in the future will always remain an option.</p>
<h2 id="chosen-option"><a class="header" href="#chosen-option">Chosen Option</a></h2>
<p>We have chosen Option 3 because it allows us to reuse the new client in Nimbus, as well as on iOS and on Android with minimal initial development effort.
If the new library ends up growing requirements that are already in the existing remote settings client, we remain able to copy that functionality from that library into this.</p>
<h2 id="specific-plans"><a class="header" href="#specific-plans">Specific Plans</a></h2>
<p>This section is non-normative - ie, is not strictly part of the ADR, but exists
for context.</p>
<p>This is a very high-level view of the tasks required here.</p>
<ul>
<li>
<p>Create a new top-level component in the application-services repository, identify the exact API we wish to expose for this new library, describe this API using UniFFI, then implement the API with “stubs” (eg, using rust <code>todo!()</code>or similar). This is depicted as <code>RemoteSettings</code> in the diagram.</p>
</li>
<li>
<p>Identify which parts of Nimbus should be factored out into a shared component (depicted as <code>rs-client</code> in the diagram below) and move that functionality to the new shared component. Of note:</p>
<ul>
<li>This component probably will not have a UniFFI .udl file, but is just for consumption by the new component above and the existing nimbus component.</li>
<li>There is still some uncertainty here - if it is a requirement that nimbus and the new component share some configuration or initialization code, we might need to do something more complex here. This seems unlikely, but possible, so is included here for completeness.</li>
</ul>
</li>
<li>
<p>Identify which of the nimbus tests should move to the new client and move them.</p>
</li>
<li>
<p>Update Nimbus to take a dependency on the new component and use it, including tests.</p>
</li>
<li>
<p>Flesh out the API of the new top-level component using the new shared component (ie, replace the <code>todo!()</code> macros with real code.)</p>
</li>
<li>
<p>Identify any impact on the Nimbus android/swift code - in particular, any shared configuration and initialization code identified above in the application-services repo.</p>
</li>
<li>
<p>Implement the Android and iOS code in the application-services repo desired to make this an ergonomic library for the mobile platforms.</p>
</li>
<li>
<p>Update the mobile code for the UniFFI changes made to Nimbus, if any.</p>
</li>
<li>
<p>Implement the mobile code which consumes the new library, including tests.</p>
</li>
<li>
<p>Profit?</p>
</li>
</ul>
<p>This diagram attempts to depict this final layout. Note:</p>
<ul>
<li><code>rs-client</code> and <code>RemoteSettings</code> are both new components, everything else already exists. <strong>Please do not consider these names as suggestions!</strong> Names are hard, I’m sure we can do better.</li>
<li>Dashed lines are normal Rust dependencies (ie, dependencies listed in <code>Cargo.toml</code>)</li>
<li>Solid lines are where the component uses UniFFI</li>
<li>Viaduct is a little odd in that it is consumed by the mobile applications indirectly (eg, via Glean), hence it’s not in <code>support</code>, but please ignore that anomaly.</li>
</ul>
<pre class="mermaid">flowchart RL
    subgraph app-services-support[Shared components in application-services/components/support]
    rs-client
    other-support-components
    end
    subgraph app-services-components[Top-level application-services components, in application-services/components]
    Nimbus
    RemoteSettings
    Viaduct
    end
    subgraph mobile [Code in the mobile repositories]
        Fenix
        Firefox-iOS
    end

    Nimbus -- nimbus.udl --&gt; mobile
    RemoteSettings -- remote_settings.udl --&gt; mobile

    rs-client -.-&gt; Nimbus
    other-support-components -.-&gt; Nimbus
    rs-client -.-&gt; RemoteSettings
    other-support-components -.-&gt; RemoteSettings
    Viaduct -.-&gt; rs-client
    other-support-components -.-&gt; rs-client
</pre>

<h2 id="content-signatures"><a class="header" href="#content-signatures">Content Signatures</a></h2>
<p>This section is non-normative - ie, is not strictly part of the ADR, but exists
for context.</p>
<p>Content Signatures have been explicitly called out as a non-requirement. Because this capability was a sticking point in the desktop version of the remote settings client, and because significant effort was spent on it, it’s worth expanding on this here.</p>
<p>Because https will be enforced for all network requests, the consumers of this library can have a high degree of confidence that:</p>
<ul>
<li>The servers hit by this client are the servers we expect to hit (ie, no man-in-the-middle attacks will be able to redirect to a different server).</li>
<li>The response from the server is exactly what was sent by the Mozilla controlled server (ie, no man-in-the-middle attacks will be able to change the content in-flight)</li>
<li>Therefore, the content received must be exactly as sent by the Mozilla controlled servers.</li>
</ul>
<p>Content signatures offer an additional capability of checking the <em>content</em> of a remote settings response matches the signature generated with a secret key owned by Mozilla, independenty of the https certificates used for the request itself.</p>
<p>This capability was added to the desktop version primarily to protect the integrity of the data at rest.
Because the Desktop client cached the responses on disk, there was a risk that this data could be tampered with - so it was effectively impossible to guarantee that the data finally presented to the application is what was initially sent.</p>
<p>The main threat-model that required this capability was 3rd party applications installed on the same system where Firefox was installed.
Because of the security model enforced by Desktop operating systems (most notably Windows), there was evidence that these 3rd-party applications  would locate and modify the cache of remote-settings responses and modify them in a way that benefited them and caused revenue harm to Mozilla - the most obvious example is changing the search provider settings.</p>
<p>The reason we are declaring this capability a non-requirement in the initial version is two-fold:</p>
<ul>
<li>
<p>We have also declared caching of responses a non-requirement, meaning there’s no data at rest managed by this library which is vulnerable to this kind of attack.</p>
</li>
<li>
<p>The mobile operating systems have far stronger application isolation - in the general case, a 3rd party mobile application is prevented from touching any of the files used by other applications.</p>
</li>
</ul>
<p>Obviously though, things may change in the future - for example, we might add response caching, so we must be sure to reevaluate this requirement as other requirements change.</p>
<footer id="open-on-gh-25">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/adr/0005-remote-settings-client.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="limit-visits-migrated-to-places-history-in-firefox-ios"><a class="header" href="#limit-visits-migrated-to-places-history-in-firefox-ios">Limit Visits Migrated to Places History in Firefox iOS</a></h1>
<ul>
<li>Status: accepted</li>
<li>Deciders: teshaq, mhammond, lougeniaC64, dnarcese</li>
<li>Date: 2023-01-06</li>
</ul>
<h2 id="context-and-problem-statement-6"><a class="header" href="#context-and-problem-statement-6">Context and Problem Statement</a></h2>
<p><a href="https://mozilla-hub.atlassian.net/browse/SYNC-3086">The Application-Services team removed a legacy implementation of history in Firefox-ios and replaced it with a maintained implementation that was powering Firefox Android.</a></p>
<p>A significant part of the project is migrating users’ history from the old database to a new one. To measure risk, we ran a dry-run migration. A dry-run migration runs a background thread in the user’s application and attempts to migrate to a fake database. The dry-run was implemented purely to collect telemetry on the migration to evaluate risk. The results can be found in the <a href="https://mozilla.cloud.looker.com/dashboards/917?Submission+Date=28+day+ago+for+28+day&amp;Channel=mozdata.firefox%5E_ios.metrics&amp;Places+History+Migration+Migration+Error+Rate+Numerator=NOT+NULL">following Looker dashboard</a>. Below is a list of observations.</p>
<h3 id="observations-from-dry-run-experiment"><a class="header" href="#observations-from-dry-run-experiment">Observations from Dry-Run Experiment</a></h3>
<p>The following is a list of observations from the experiment:</p>
<ul>
<li>5-6% of migrations do not end. This means for 5-6% of users, the application was terminated before migration ended. For a real migration, this would mean those users lose all of their history unless we attempt the migration multiple times.</li>
<li>Out of the migrations that failed (the 5-6% mentioned above) 97% of those users had over 10,000 history visits.</li>
<li>Out of migrations that do end, over 99% of migrations are successful.
<ul>
<li>This means that we are not experiencing many errors with the migration beyond the time it takes.</li>
</ul>
</li>
<li>The average for visits migrated is around 25,000 - 45,000 visits.</li>
<li>The median for visits migrated is around 5,000-15,000 visits.
<ul>
<li>The difference between the average and the median suggests that we have many users with a large number of visits</li>
</ul>
</li>
<li>For migrations that did end, the following are the percentiles for how long it took (in milliseconds). We would like to emphasize that <strong>the following only includes migrations that did end</strong>
<ul>
<li>10th percentile: 37 ms</li>
<li>25th percentile: 80 ms</li>
<li>50th percentile: 400 ms</li>
<li>75th percentile: 2,500 ms (2.5 seconds)</li>
<li>90th percentile: 6,400 ms (6.4 seconds)</li>
<li>95th percentile: 11,000 ms (11 seconds)</li>
<li>99th percentile: 25,000 ms (25 seconds)</li>
<li>99.9th  percentile: 50,000 ms (50 seconds)</li>
</ul>
</li>
</ul>
<h3 id="problem-statement"><a class="header" href="#problem-statement">Problem Statement</a></h3>
<p>Given the observations from the dry-run experiment, the rest of the document examines an approach to answer the question: <strong>How can we increase the rate of which migrations end, and simultaneously keep the user’s database size at a reasonable size?</strong></p>
<p>The user implication of keeping the rate of ended migrations high is that users keep their history, and can interact normally with the URL bar to search history, searching history in the history panel and navigating to sites they visited in the past.</p>
<p>The user implication of keeping a reasonable database size is that the database is less likely to lock on long queries. Meaning we reduce performance issues when users use the search bar, the history panel and when navigating to sites.</p>
<p>Finally, it’s important to note that power users and daily active users will be more likely to have large histories and thus:</p>
<ul>
<li>Power users are more likely to fail their migration.</li>
<li>Power users are more likely to have performance issues with history and the search bar.
<ul>
<li>We saw a version of this with Favicons in an earlier incident, where users were coming across a significant number of database locks, crashing the app. This isn’t to say that the incident is directly related to this, however, large histories could contribute to the state we saw in the incident as it would take longer to run the queries.</li>
</ul>
</li>
</ul>
<h2 id="decision-drivers-4"><a class="header" href="#decision-drivers-4">Decision Drivers <!-- optional --></a></h2>
<ul>
<li>
<p>We must not lose users’ recent history.</p>
<ul>
<li>What is considered “recent” is not concretely defined. There is prior art, however:
<ul>
<li><a href="https://github.com/mozilla/application-services/blob/c34de065f5773b529a0def773cffb29b45676bce/components/places/src/history_sync/mod.rs#L16">Firefox Sync in Android syncs 5000 visits.</a></li>
<li><a href="https://github.com/mozilla-mobile/firefox-android/blob/8077db4b55c1a8976ec130462767e3075b9cbeab/android-components/components/browser/storage-sync/src/main/java/mozilla/components/browser/storage/sync/PlacesHistoryStorageWorker.kt#L38">Firefox Desktop and Android impose limits on the size of the database, 75 MiB in Android</a></li>
<li><a href="https://searchfox.org/mozilla-central/rev/f40d29a11f2eb4685256b59934e637012ea6fb78/browser/app/profile/firefox.js#2134">When importing history from chrome to Firefox, we only migrate the latest 2000 visits</a></li>
<li><a href="https://support.google.com/chrome/answer/95589">Chrome only keeps a user’s history for 90 days</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p>User’s experience with History must not regress, and ideally should improve.</p>
<ul>
<li>User experience is tightly coupled with the size of the database. The larger the database, the longer queries take. The longer queries take, the longer it would take for a user to observe their searched history and the history panel.</li>
</ul>
</li>
</ul>
<h2 id="considered-options-6"><a class="header" href="#considered-options-6">Considered Options</a></h2>
<ul>
<li>Keep the migration as-is.
<ul>
<li>This option means that we have no limit. We will attempt to migrate all history for our users.</li>
</ul>
</li>
<li>Introduce a date-based limit on visits for the migration
<ul>
<li>This option means that we only migrate visits that occurred in the past X days/weeks/months etc</li>
</ul>
</li>
<li>Introduce a visit number-based limit for the migration
<ul>
<li>This option means we only migrate the latest X visits</li>
</ul>
</li>
</ul>
<h2 id="decision-outcome-5"><a class="header" href="#decision-outcome-5">Decision Outcome</a></h2>
<p>Chosen option: <strong>Introduce a visit number-based limit for the migration</strong>. This option was chosen because given our decision drivers:</p>
<ol>
<li>We must not lose users’ recent history:</li>
</ol>
<ul>
<li>We have established in the results of the dry-run, that the majority of failed migrations were for users with a large number of visits.</li>
<li>By setting a reasonable limit, we can increase the likelihood the migration succeeds. We can set the limit to encompass “recent history” while choosing a limit that has an over 99% success rate.</li>
</ul>
<ol start="2">
<li>User’s experience with History must not regress, and ideally should improve.</li>
</ol>
<ul>
<li>We have established in our decision driver that the user’s experience with history is coupled with the database size.</li>
<li>By setting a reasonable limit, we can keep the size of the history database controlled.</li>
<li>It’s also worth noting that with the switch to the new implementation of history, we are also introducing a target size for the database. This means that we have maintenance logic that would compact the database and prune it if it grows beyond the target size.</li>
</ul>
<h3 id="positive-consequences-1"><a class="header" href="#positive-consequences-1">Positive Consequences</a></h3>
<ul>
<li>The migration runs in a shorter time.
<ul>
<li>This means a higher chance of the migration succeeding, thus keeping the user’s recent history without loss.</li>
</ul>
</li>
<li>Users who have less than the selected limit, will still get all their history. More on this in the Suggested Limit section.</li>
<li>We keep the size of the history database low.
<ul>
<li>This way users with more than the limit, will only keep their recent history.</li>
<li>Additionally, when we delete users’ history from the old database, the size of the data the app keeps will decrease dramatically.</li>
<li>Keeping the database size low means we lower the chance a user has performance issues with the database.</li>
</ul>
</li>
</ul>
<h3 id="negative-consequences-1"><a class="header" href="#negative-consequences-1">Negative Consequences</a></h3>
<p>The biggest negative consequence is that <strong>Users with more visits than the limit, will lose visits</strong>.</p>
<ul>
<li>Since we would only keep the latest X visits for a user, if a user has Y visits, they would lose all of the Y-X visits (assuming Y is greater than X)</li>
<li>The effect here is mitigated by the observation that recent history is more important to users than older history. Unfortunately, we do not have any telemetry to demonstrate this claim, but it’s an assumption based on the existing limits on history imposed in Android and Desktop mentioned in the decision drivers section.</li>
</ul>
<h2 id="pros-and-cons-of-the-other-options"><a class="header" href="#pros-and-cons-of-the-other-options">Pros and Cons of the Other Options</a></h2>
<h3 id="keep-the-migration-as-is"><a class="header" href="#keep-the-migration-as-is">Keep the migration as-is</a></h3>
<ul>
<li>Good because if the migration succeeds, users keep all their history.</li>
<li>Bad, because it’s less likely for migrations to succeed.</li>
<li>Bad, because even if the migration succeeds it causes the size of the database to be large if a user has a lot of history.
<ul>
<li>Large databases can cause a regression in performance.</li>
<li>Users with a lot of history will now have two large databases (the old and new ones) since we won’t delete the data in the old database right away to support downgrades.</li>
</ul>
</li>
<li>Bad, because it can take a long time for the migration to finish.</li>
<li>Bad because until the migration is over users will experience the app without history.</li>
</ul>
<h3 id="introduce-a-date-based-limit-on-visits"><a class="header" href="#introduce-a-date-based-limit-on-visits">Introduce a date-based limit on visits</a></h3>
<ul>
<li>Good, because we match users’ usage of the app.
<ul>
<li>Users that use the app more, will keep more of their history.</li>
</ul>
</li>
<li>Good, because it’s more likely that the migration ends because we set a limit</li>
<li>Bad because it’s hard to predict how large user’s databases will be.
<ul>
<li>This is particularly important for Sync users. As Firefox-iOS syncs all your history, meaning if a user has many visits before the limit across multiple platforms, a large number of visits will be migrated.</li>
</ul>
</li>
<li>Bad, because users who haven’t used the app since the limit, will lose all their history
<ul>
<li>For example, if the limit is 3 months, a user who last used the app 3 months ago will suddenly lose all their history</li>
</ul>
</li>
</ul>
<h2 id="suggested-limit"><a class="header" href="#suggested-limit">Suggested Limit</a></h2>
<p>This section describes a suggested limit for the visits. Although it’s backed up with telemetry, the specific number is up for discussion. <strong>It’s also important to note that statistical significance was not a part of the analysis. Migration has run for over 16,000 users and although that may not be a statistically significant representation of our population, it’s good enough input to make an educated suggestion.</strong></p>
<ul>
<li>First, we start by observing the distribution of visit counts. This will tell us how many of our users have between 0-10000 visits, 10000-20000, etc. We will identify that most of our users have less than 10,000 visits.</li>
<li>Then, we will observe the dry-run migration ended rate based on the above buckets. We will observe that users with under 10,000 visits have a high chance of migration success.</li>
<li>Finally, based on the analysis and prior art we’ll suggest 10,000 visits.</li>
</ul>
<h3 id="user-history-distribution"><a class="header" href="#user-history-distribution">User History Distribution</a></h3>
<p>We will look at <a href="https://mozilla.cloud.looker.com/looks/1078">https://mozilla.cloud.looker.com/looks/1078</a> which demonstrates a distribution of our users based on the number of history visits. Note that the chart is based on our release population.</p>
<h4 id="observations"><a class="header" href="#observations">Observations</a></h4>
<ul>
<li>67% of firefox-ios users have less than 10,000 visits</li>
<li>There is a very long tail to the distribution, with 6% of users having over 100,000 visits.</li>
</ul>
<h3 id="dry-run-ending-rate-by-visits"><a class="header" href="#dry-run-ending-rate-by-visits">Dry-run Ending Rate by Visits</a></h3>
<p>We will look at <a href="https://mozilla.cloud.looker.com/looks/1081">https://mozilla.cloud.looker.com/looks/1081</a>. The chart demonstrates the rate at which migrations end by the number of visits. We bucket users in buckets of 10,000 visits.</p>
<h4 id="observations-1"><a class="header" href="#observations-1">Observations</a></h4>
<ul>
<li>We observe that for users that have visits under 10,000, the success rate is over 99.6%.</li>
<li>We observe that for users with over 100,000 visits, the success rate drops to 75~80%.</li>
<li>Users in between, have success rates in between. For example, users with visits between 10,000 and 20,000 have a 98-99% success rate.</li>
<li>All success rates for buckets beyond 20,000 visits drop under 96%.</li>
</ul>
<h3 id="suggestion"><a class="header" href="#suggestion">Suggestion</a></h3>
<p>Based on the above, we’re suggesting a limit of 10,000 visits because</p>
<ul>
<li>10,000 visits encompass the full history of 67% of our users.</li>
<li>Migrations with under 10,000 visits have a success rate of over 99%.</li>
<li>For users with over 10,000 visits, they still keep the latest 10,000 visits. The choice is reasonable considering:
<ul>
<li><a href="https://github.com/mozilla/application-services/blob/c34de065f5773b529a0def773cffb29b45676bce/components/places/src/history_sync/mod.rs#L16">Sync only retrieves the latest 5000 visits in Android</a></li>
<li><a href="https://searchfox.org/mozilla-central/rev/f40d29a11f2eb4685256b59934e637012ea6fb78/browser/app/profile/firefox.js#2134">Migrating from Chrome to Firefox only migrates 2000 visits in Desktop</a></li>
</ul>
</li>
</ul>
<h2 id="links-2"><a class="header" href="#links-2">Links <!-- optional --></a></h2>
<ul>
<li><a href="https://mozilla-hub.atlassian.net/browse/SYNC-3086">Epic for moving iOS’s history implementation to application-services places</a></li>
<li><a href="https://experimenter.services.mozilla.com/nimbus/running-a-dry-run-migration-to-the-application-services-history-in-firefox-ios">Dry-run migration experiment</a></li>
<li><a href="https://mozilla.cloud.looker.com/dashboards/917?Submission+Date=28+day+ago+for+28+day&amp;Channel=mozdata.firefox%5E_ios.metrics&amp;Places+History+Migration+Migration+Error+Rate+Numerator=NOT+NULL">Overall dry-run migration looker dashboard</a></li>
<li><a href="https://mozilla.cloud.looker.com/looks/1078">Firefox iOS User distribution by history</a></li>
<li><a href="https://mozilla.cloud.looker.com/looks/1081">Migration Ended rate by User History</a></li>
<li><a href="https://github.com/mozilla/application-services/blob/c34de065f5773b529a0def773cffb29b45676bce/components/places/src/history_sync/mod.rs#L16">Firefox Sync on Android only Syncs 5000 sites</a></li>
<li><a href="https://searchfox.org/mozilla-central/rev/f40d29a11f2eb4685256b59934e637012ea6fb78/browser/app/profile/firefox.js#2134">Firefox Desktop Limits import from Chrome to 2000 visits</a></li>
<li><a href="https://github.com/mozilla-mobile/firefox-android/blob/8077db4b55c1a8976ec130462767e3075b9cbeab/android-components/components/browser/storage-sync/src/main/java/mozilla/components/browser/storage/sync/PlacesHistoryStorageWorker.kt#L38">Firefox Android limits the size of its <code>places.db</code> to 75MiB</a></li>
<li><a href="https://support.google.com/chrome/answer/95589">Chrome only keeps 90 days of history</a></li>
<li><a href="https://docs.google.com/document/d/1brA7BQIObLOOsdf_9lJW3VAPh68AzCu1xrgcpGDnPak/edit">Performance incident in Firefox iOS</a></li>
</ul>
<footer id="open-on-gh-26">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/adr/0007-limit-visits-migration-to-10000.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="design-documents"><a class="header" href="#design-documents">Design Documents</a></h1>
<ul>
<li><a href="#megazording">Megazords</a> - Megazords and how we ship code</li>
<li><a href="#sync-manager">Sync Manager</a> - Our Sync Manager and how Sync works in using it</li>
<li><a href="#high-level-design-for-shipping-rust-components-as-swift-packages">Shipping Rust Components as Swift Packages</a> - High level design of how use the Swift Package Manager to distribute our Rust components to iOS</li>
<li><a href="#sync-overview">Sync overview</a> - High level overview of how Firefox sync works</li>
<li><a href="#rust-components-strategy">Rust Component’s Strategy</a> - High level description of our Rust components strategy</li>
<li><a href="#metrics---glean-telemetry">Metrics - (Glean Telemetry)</a></li>
<li><a href="#rust-versions">Rust Version Policy</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="megazording"><a class="header" href="#megazording">Megazording</a></h1>
<p>Each Rust component published by Application Services is conceptually a stand-alone library, but for
distribution we compile all the rust code for all components together into a single <code>.so</code> file. This
has a number of advantages:</p>
<ul>
<li>Easy and direct interoperability between different components at the Rust level</li>
<li>Cross-component optimization of generated code</li>
<li>Reduced code size thanks to distributing a single copy of the rust stdlib, low-level dependencies, etc.</li>
</ul>
<p>This process is affectionately known as “megazording” and the resulting artifact as a <em><strong>megazord library</strong></em>.</p>
<p>On Android, the situation is quite complex due to the way packages and dependencies are managed.
We need to distribute each component as a separate Android ARchive (AAR) that can be managed as a dependency
via gradle, we need to provide a way for the application to avoid shipping rust code for components that it
isn’t using, and we need to do it in a way that maintanins the advantages listed above.</p>
<p>This document describes our current approach to meeting all those requirements on Android. Other platforms
such as iOS are not considered.</p>
<h2 id="aar-dependency-graph"><a class="header" href="#aar-dependency-graph">AAR Dependency Graph</a></h2>
<p>We publish a separate AAR for each component (e.g. fxaclient, places, logins) which contains
<em>just</em> the Kotlin wrappers that expose the relevant functionality to Android. Each of these AARs depends on a separate
shared “megazord” AAR in which all the rust code has been compiled together into a single <code>.so</code> file.
The application’s dependency graph thus looks like this:</p>
<p><a href="https://docs.google.com/drawings/d/1owo4wo2F1ePlCq2NS0LmAOG4jRoT_eVBahGNeWHuhJY/"><img src="https://docs.google.com/drawings/d/e/2PACX-1vTA6wL3ibJRNjKXsmescTfKTx0w_fpr5NcDIF_4T5AsnZfCi8UEEcav8vibocSyKpHOQOk5ysiDBm-D/pub?w=727&amp;h=546" alt="megazord dependency diagram"></a></p>
<p>This generates a kind of strange inversion of dependencies in our build pipeline:</p>
<ul>
<li>Each individual component defines both a rust crate and an Android AAR.</li>
<li>There is a special “full-megazord” component that also defines a rust crate and an Android AAR.</li>
<li>The full-megazord rust crate depends on the rust crates for each individual component.</li>
<li>But the Android AAR for each component depends on the Android AAR of the full-megazord!</li>
</ul>
<p>It’s a little odd, but it has the benefit that we can use gradle’s dependency-replacement features to easily
manage the rust code that is shipping in each application.</p>
<h2 id="custom-megazords"><a class="header" href="#custom-megazords">Custom Megazords</a></h2>
<p>By default, an application that uses <em>any</em> appservices component will include the compiled rust code
for <em>all</em> appservices components.</p>
<p>To reduce its overall code size, the application can use gradle’s <a href="https://docs.gradle.org/current/userguide/customizing_dependency_resolution_behavior.html#sec:module_replacement">module replacement
rules</a>
to replace the “full-megazord” AAR with a custom-built megazord AAR containing only the components it requires.
Such an AAR can be built in the same way as the “full-megazord”, and simply avoid depending on the rust
crates for components that are not required.</p>
<p>To help ensure this replacement is done safely at runtime, the <code>mozilla.appservices.support.native</code> package
provides helper functions for loading the correct megazord <code>.so</code> file.  The Kotlin wrapper for each component
should load its shared library by calling <code>mozilla.appservices.support.native.loadIndirect</code>, specifying both
the name of the component and the expected version number of the shared library.</p>
<h2 id="unit-tests"><a class="header" href="#unit-tests">Unit Tests</a></h2>
<p>The full-megazord AAR contains compiled Rust code that targets various Android platforms, and is not
suitable for running on a Desktop development machine. In order to support integration with unittest
suites such as robolectric, each Megazord has a corresponding Java ARchive (JAR) distribution named
e.g. <code>full-megazord-libsForTests.jar</code>. This contains the compiled Megazord code as well as
libjnidispatch, targetted at various Desktop architectures. Consumers can add it to their classpath
when running tests on a Desktop machine.</p>
<h2 id="gotchas-and-rough-edges"><a class="header" href="#gotchas-and-rough-edges">Gotchas and Rough Edges</a></h2>
<p>This setup mostly works, but has a handful of rough edges.</p>
<p>The <code>build.gradle</code> for each component needs to declare an explicit dependency on <code>project(":full-megazord")</code>,
otherwise the resulting AAR will not be able to locate the compiled rust code at runtime. It also needs to
declare a dependency between its build task and that of the full-megazord, for reasons. Typically this looks something
like:</p>
<pre><code>tasks["generate${productFlavor}${buildType}Assets"].dependsOn(project(':full-megazord').tasks["cargoBuild"])
</code></pre>
<p>In order for unit tests to work correctly, the <code>build.gradle</code> for each component needs to add the <code>rustJniLibs</code>
directory of the full-megazord project to its <code>srcDirs</code>, otherwise the unittests will not be able to find and load
the compiled rust code. Typically this looks something like:</p>
<pre><code>test.resources.srcDirs += "${project(':full-megazord').buildDir}/rustJniLibs/desktop"
</code></pre>
<p>The above also means that unittests will not work correctly when doing local composite builds,
because it’s unreasonable to expect the main project (e.g. Fenix) to include the above in its build scripts.</p>
<footer id="open-on-gh-27">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/megazords.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="sync-manager"><a class="header" href="#sync-manager">Sync manager</a></h1>
<p>We’ve identified the need for a “sync manager” (although are yet to identify a
good name for it!) This manager will be responsible for managing “global sync
state” and coordinating each engine.</p>
<p>At a very high level, the sync manager is responsible for all syncing. So far,
so obvious. However, given our architecture, it’s possible to identify a
key architectural split.</p>
<ul>
<li>
<p>The embedding application will be responsible for most high-level operations.
For example, the app itself will choose how often regular syncs should
happen, what environmental concerns apply (eg, should I only sync on WiFi?),
letting the user choose exactly what to sync, and so forth.</p>
</li>
<li>
<p>A lower-level component will be responsible for the direct interaction with
the engines and with the various servers needed to perform a sync. It will
also have the ultimate responsibility to not cause harm to the service (for
example, it will be likely to enforce some kind of rate limiting or ensuring
that service requests for backoff are enforced)</p>
</li>
</ul>
<p>Because all application-services engines are written in Rust, it’s tempting to
suggest that this lower-level component also be written in Rust and everything
“just works”, but there are a couple of complications here:</p>
<ul>
<li>
<p>For iOS, we hope to integrate with older engines which aren’t written in
Rust, even if iOS does move to the new Sync Manager.</p>
</li>
<li>
<p>For Desktop, we hope to start by reusing the existing “sync manager”
implemented by Desktop, and start moving individual engines across.</p>
</li>
<li>
<p>There may be some cross-crate issues even for the Rust implemented engines.
Or more specifically, we’d like to avoid assuming any particular linkage or
packaging of Rust implemented engines.</p>
</li>
</ul>
<p>Even with these complications, we expect there to be a number of high-level
components, each written in a platform specific language (eg, Kotlin or Swift)
and a single lower-level component to be implemented in Rust and delivered
as part of the application-services library - but that’s not a free-pass.</p>
<p>Why “a number of high-level components”? Because that is the thing which
understands the requirements of the embedding application. For example, Android
may end up with a single high-level component in the android-components repo
and shared between all Android components. Alternatively, the Android teams
may decide the sync manager isn’t generic enough to share, so each app will
have their own. iOS will probably end up with its own and you could imagine
a future where Desktop does too - but they should all be able to share the
low level component.</p>
<h1 id="the-responsibilities-of-the-sync-manager"><a class="header" href="#the-responsibilities-of-the-sync-manager">The responsibilities of the Sync Manager.</a></h1>
<p>The primary responsibilities of the “high level” portion of the sync manager are:</p>
<ul>
<li>
<p>Manage all FxA interaction. The low-level component will have a way to
communicate auth related problems, but it is the high-level component
which takes concrete FxA action.</p>
</li>
<li>
<p>Expose all UI for the user to choose what to sync and coordinate this with
the low-level component. Note that because these choices can be made on any
connected device, these choices must be communicated in both directions.</p>
</li>
<li>
<p>Implement timers or any other mechanism to fully implement the “sync
scheduler”, including any policy decisions such as only syncing on WiFi,
etc.</p>
</li>
<li>
<p>Implement a UI so the user can “sync now”.</p>
</li>
<li>
<p>Collect telemetry from the low-level component, probably augment it, then
submit it to the telemetry pipeline.</p>
</li>
</ul>
<p>The primary responsibilities of the “low level” portion of the sync manager are:</p>
<ul>
<li>
<p>Manage the <code>meta/global</code>, <code>crypto/keys</code> and <code>info/collections</code> resources,
and interact with each engine as necessary based on the content of these
resources.</p>
</li>
<li>
<p>Manage interaction with the token server.</p>
</li>
<li>
<p>Enforce constraints necessary to ensure the entire ecosystem is not
subject to undue load. For example, this component should ignore attempts to
sync continuously, or to sync when the services have requested backoff.</p>
</li>
<li>
<p>Manage the “clients” collection - we probably can’t ignore this any longer,
especially for bookmarks (as desktop will send a wipe command on bookmark
restore, and things will “be bad” if we don’t see that command).</p>
</li>
<li>
<p>Define a minimal “service state” so certain things can be coordinated with
the high-level component. Examples of these states are “everything seems ok”,
“the service requested we backoff for some period”, “an authentication error
occurred”, and possibly others.</p>
</li>
<li>
<p>Perform, or coordinate, the actual sync of the rust implemented engines -
from the containing app’s POV, there’s a single “sync now” entry-point (in
practice there might be a couple, but conceptually there’s a single way to
sync). Note that as below, how non-rust implemented engines are managed is
TBD.</p>
</li>
<li>
<p>Manage the collection of (but <em>not</em> the submission of) telemetry from the
various engines.</p>
</li>
<li>
<p>Expose APIs and otherwise coordinate with the high-level component.</p>
</li>
</ul>
<p>Stuff we aren’t quite sure where it fits include:</p>
<ul>
<li>Coordination with non-rust implemented engines. These engines are almost
certainly going to be implemented in the same language as the high-level
component, which will make integration simpler. However, the low-level
component will almost certainly need some information about these engines for
populating info/collections etc. For now, we are punting on this until things
become a bit clearer.</li>
</ul>
<h1 id="implementation-details"><a class="header" href="#implementation-details">Implementation Details.</a></h1>
<p>The above has been carefully written to try and avoid implementation details -
the intent is that it’s an overview of the architecture without any specific
implementation decisions.</p>
<p>These next sections start getting specific, so implementation choices need to
be made, and thus will possibly be more contentious.</p>
<p>In other words, get your spray-cans ready because there’s a bikeshed being built!</p>
<p>However, let’s start small and make some general observations.</p>
<h2 id="current-implementations-and-challenges-with-the-rust-components"><a class="header" href="#current-implementations-and-challenges-with-the-rust-components">Current implementations and challenges with the Rust components</a></h2>
<ul>
<li>
<p>Some apps only care about a subset of the engines - lockbox is one such app
and only cares about a single collection/engine. It might be the case that
lockbox uses a generic application-services library with many engines
available, even though it only wants logins. Thus, the embedding application
is the only thing which knows which engines should be considered to “exist”.
It may be that the app layer passes an engine to the sync manager, or the
sync manager knows via some magic how to obtain these handles.</p>
</li>
<li>
<p>Some apps will use a combination of Rust components and “legacy”
engines. For example, iOS is moving some of the engines to using Rust
components, while other engines will be ported after delivery of the
sync manager, if they are ported at all. We also plan
to introduce some rust engines into desktop without integrating the
“sync manager”</p>
</li>
<li>
<p>The rust components themselves are designed to be consumed as individual
components - the “logins” component doesn’t know anything about the
“bookmarks” component.</p>
</li>
</ul>
<p>There are a couple of gotchyas in the current implementations too - there’s an
issue when certain engines don’t yet appear in meta/global - see bug 1479929
for all the details.</p>
<p>The tl;dr of the above is that each rust component should be capable of
working with different sync managers. That said though, let’s not over-engineer
this and pretend we can design a single, canonical thing that will not need
changing as we consider desktop and iOS.</p>
<h2 id="state-state-and-more-state-and-then-some-state"><a class="header" href="#state-state-and-more-state-and-then-some-state">State, state and more state. And then some state.</a></h2>
<p>There’s loads of state here. The app itself has some state. The high-level
Sync Manager component will have state, the low-level component will have state,
and each engine has state. Some of this state will need to be persisted (either
on the device or on the storage servers) and some of this state can be considered
ephemeral and lives only as long as the app.</p>
<p>A key challenge will be defining this state in a coherent way with clear
boundaries between them, in an effort to allow decoupling of the various bits
so Desktop and iOS can fit into this world.</p>
<p>This state management should also provide the correct degree of isolation for
the various components. For example, each engine should only know about state
which directly impacts how it works. For example, the keys used to encrypt
a collection should only be exposed to that specific engine, and there’s no
need for one engine to know what info/collections returns for other engines,
nor whether the device is currently connected to WiFi.</p>
<p>A thorn here is for persisted state - it would be ideal if the low-level
component could avoid needing to persist any state, so it can avoid any
kind of storage abstraction. We have a couple of ways of managing this:</p>
<ul>
<li>
<p>The state which needs to be persisted is quite small, so we could delegate
state storage to the high-level component in an opaque way, as this
high-level component almost certainly already has storage requirements, such
as storing the “choose what to sync” preferences.</p>
</li>
<li>
<p>The low-level component could add its own storage abstraction. This would
isolate the high-level component from this storage requirement, but would
add complexity to the sync manager - for example, it would need to be passed
a directory where it should create a file or database.</p>
</li>
</ul>
<p>We’ll probably go with the former.</p>
<h1 id="implementation-plan-for-the-low-level-component"><a class="header" href="#implementation-plan-for-the-low-level-component">Implementation plan for the low-level component.</a></h1>
<p>Let’s try and move into actionable decisions for the implementation. We expect
the implementation of the low-level component to happen first, followed very
closely by the implementation of the high-level component for Android. So we
focus first on these.</p>
<h2 id="clients-engine"><a class="header" href="#clients-engine">Clients Engine</a></h2>
<p>The clients engine includes some meta-data about each client. We’ve decided
we can’t replace the clients engine with the FxA device record and we can’t
simply drop this engine entirely.</p>
<p>Of particular interest is “commands” - these involve communicating with the
engine regarding commands targeting it, and accepting commands to be send to
other devices. Note that outgoing commands are likely to not originate from a sync,
but instead from other actions, such as “restore bookmarks”.</p>
<p>However, because the only current requirement for commands is to wipe the
store, and because you could anticipate “wipe” also being used when remotely
disconnecting a device (eg, when a device is lost or stolen), our lives would
probably be made much simpler by initially supporting only per-engine wipe
commands.</p>
<p>Note that there has been some discussion about not implementing the client
engine and replacing “commands” with some other mechanism. However, we have
decided to not do that because the implementation isn’t considered too
difficult, and because desktop will probably require a number of changes to
remove it (eg, “synced tabs” will not work correctly without a client record
with the same guid as the clients engine.)</p>
<p>Note however that unlike desktop, we will use the FxA device ID as the client
ID. Because FxA device IDs are more ephemeral than sync IDs, it will be
necessary for engines using this ID to track the most-recent ID they synced
with so the old record can be deleted when a change is detected.</p>
<h2 id="collections-vs-engines-vs-stores-vs-preferences-vs-apis"><a class="header" href="#collections-vs-engines-vs-stores-vs-preferences-vs-apis">Collections vs engines vs stores vs preferences vs Apis</a></h2>
<p>For the purposes of the sync manager, we define:</p>
<ul>
<li>
<p>An <em>engine</em> is the unit exposed to the user - an “engine” can be enabled
or disabled. There is a single set of canonical “engines” used across the
entire sync ecosystem - ie, desktop and mobile devices all need to agree
about what engines exist and what the identifier for an engine is.</p>
</li>
<li>
<p>An <em>Api</em> is the unit exposed to the application layer for general application
functionality. Application services has ‘places’ and ‘logins’ Apis and is
the API used by the application to store and fetch items. Each ‘Api’ may
have one or more ‘stores’ (although the application layer will generally not
interact directly with a store)</p>
</li>
<li>
<p>A <em>store</em> is the code which actually syncs. This is largely an implementation
detail. There may be multiple stores per engine (eg, the “history” engine
may have “history” and “forms” stores) and a single ‘Api’ may expose multiple
stores (eg, the “places Api” will expose history and bookmarks stores)</p>
</li>
<li>
<p>A <em>collection</em> is a unit of storage on a server. It’s even more of an
implementation detail than a store. For example, you might imagine a future
where the “history” store uses multiple “collections” to help with containers.</p>
</li>
</ul>
<p>In practice, this means that the high-level component should only need to care
about an <em>engine</em> (for exposing a choice of what to sync to the user) and an
<em>api</em> (for interacting with the data managed by that api). The low-level
component will manage the mapping of engines to stores.</p>
<h2 id="the-declined-list"><a class="header" href="#the-declined-list">The declined list</a></h2>
<p>This document isn’t going to outline the history of how “declined” is used, nor
talk about how this might change in the future. For the purposes of the sync
manager, we have the following hard requirements:</p>
<ul>
<li>
<p>The low-level component needs to know what the currently declined set of
engines is for the purposes of re-populating <code>meta/global</code>.</p>
</li>
<li>
<p>The low-level component needs to know when the declined set needs to change
based on user input (ie, when the user opts in to or out of a particular
engine on this device)</p>
</li>
<li>
<p>The high-level component needs to be aware that the set of declined engines
may change on every sync (ie, when the user opts in to or out of a particular
engine on another device)</p>
</li>
</ul>
<p>A complication is that due to networks being unreliable, there’s an inherent
conflict between “what is the current state?” and “what state changes are
requested?”. For example, if the user changes the state of an engine while
there’s no network, then exits the app, how do we ensure the user’s new state
is updated next time the app starts? What if the user has since made a
different state request on a different device? Is the state as last-known on
this device considered canonical?</p>
<p>To clarify, consider:</p>
<ul>
<li>
<p>User on this device declines logins. This device now believes logins is
disabled but history is enabled, but is unable to write this to the server
due to no network.</p>
</li>
<li>
<p>The user declines history on a different device, but doesn’t change logins.
This device does manage to write the new list to the server.</p>
</li>
<li>
<p>This device restarts and the network is up. It believes history is enabled
but logins is not - however, the state on the server is the exact opposite.</p>
</li>
</ul>
<p>How does this device react?</p>
<p>(On the plus side, this is an extreme edge-case which none of our existing
implementations handle “correctly” - which is easy to say, because there’s
no real definition for “correctly”)</p>
<p>Regardless, the low-level component will not pretend to hide this complexity
(ie, it will ignore it!). The low-level component will allow the app to ask
for state changes as part of a sync, and will return what’s on the server at
the end of every sync. The app is then free to build whatever experience
it desires around this.</p>
<h2 id="disconnecting-from-sync"><a class="header" href="#disconnecting-from-sync">Disconnecting from Sync</a></h2>
<p>The low-level component needs to have the ability to disconnect all engines
from Sync. Engines which are declined should also be reset.</p>
<p>Because we will need wipe() functionality to implement the clients engine,
and because Lockbox wants to wipe on disconnect, we will provide disconnect
and wipe functionality.</p>
<h1 id="specific-deliverables-for-the-low-level-component"><a class="header" href="#specific-deliverables-for-the-low-level-component">Specific deliverables for the low-level component.</a></h1>
<p>Breaking the above down into actionable tasks which can be some somewhat
concurrently, we will deliver:</p>
<h2 id="the-api"><a class="header" href="#the-api">The API</a></h2>
<p>A straw-man for the API we will expose to the high-level components. This
probably isn’t too big, but we should do this as thoroughly as we can. In
particular, ensure we have covered:</p>
<ul>
<li>
<p>Declined management - how the app changes the declined list and how it learns
of changes from other devices.</p>
</li>
<li>
<p>How telemetry gets handed from the low-level to the high-level.</p>
</li>
<li>
<p>The “state” - in particular, how the high-level component understands the
auth state is wrong, and whether the service is in a degraded mode (eg,
server requested backoff)</p>
</li>
<li>
<p>How the high-level component might specify “special” syncs, such as “just
one engine” or “this is a pre-sleep, quick-as-possible sync”, etc</p>
</li>
</ul>
<p>There’s a straw-man proposal for this at the end of the document.</p>
<h2 id="a-command-line-and-possibly-android-utility"><a class="header" href="#a-command-line-and-possibly-android-utility">A command-line (and possibly Android) utility.</a></h2>
<p>We should build a utility (or 2) which can stand in for the high-level
component, for testing and demonstration purposes.</p>
<p>This is something like places-utils.rs and the little utility Grisha has
been using. This utility should act like a real client (ie, it should have
an FxA device record, etc) and it should use the low-level component in
exactly the same we we expect real products to use it.</p>
<p>Because it is just a consumer of the low-level component, it will force us to
confront some key issues, such as how to get references to engines stored in
multiple crates, how to present a unified “state” for things like auth errors,
etc.</p>
<h2 id="the-clients-engine"><a class="header" href="#the-clients-engine">The “clients” engine</a></h2>
<p>The initial work for the clients engine can probably be done without too
much regard for how things are tied together - for example, much work could
be done without caring how we get a reference to engines across crates.</p>
<h2 id="state-work"><a class="header" href="#state-work">State work</a></h2>
<p>Implementing things needed to we can expose the correct state to the high-level
manager for things like auth errors, backoff semantics, etc</p>
<h2 id="tie-it-together-and-other-misc-things"><a class="header" href="#tie-it-together-and-other-misc-things">Tie it together and other misc things.</a></h2>
<p>There will be lots of loose ends to clean up - things like telemetry, etc.</p>
<h1 id="followup-with-non-rust-engines"><a class="header" href="#followup-with-non-rust-engines">Followup with non-rust engines.</a></h1>
<p>We have identified that iOS will, at least in the short term, want the
sync manager to be implemented in Swift. This will be responsible for
syncing both the Swift and Rust implemented engines.</p>
<p>At some point in the future, Desktop may do the same - we will have both
Rust and JS implemented engines which need to be coordinated. We ignore this
requirement for now.</p>
<p>This approach still has a fairly easy time coordinating with the Rust
implemented engines - the FFI will need to expose the relevant sync
entry-points to be called by Swift, but the Swift code can hard-code the
Rust engines it has and make explicit calls to these entry-points.</p>
<p>This Swift code will need to create the structures identified below, but this
shouldn’t be too much of a burden as it already has the information necessary
to do so (ie, it already has info/collections etc)</p>
<p>TODO: dig into the Swift code and make sure this is sane.</p>
<h1 id="details"><a class="header" href="#details">Details</a></h1>
<p>While we use rust struct definitions here, it’s important to keep in mind that
as mentioned above, we’ll need to support the manager being written in
something other than rust, and to support engines written in other than rust.</p>
<p>The structures below are a straw-man, but hopefully capture all the information
that needs to be passed around.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>
// We want to define a list of "engine IDs" - ie, canonical strings which
// refer to what the user perceives as an "enigine" - but as above, these
// *do not* correspond 1:1 with either "stores" or "collections" (eg, "history"
// refers to 2 stores, and in a future world, might involve 3 collections).
enum Engine {
  History, // The "History" and "Forms" stores.
  Bookmarks, // The "Bookmark" store.
  Passwords,
}

impl Engine {
  fn as_str(&amp;self) -&gt; &amp;'static str {
    match self {
      History =&gt; "history",
      // etc
  }
}

// A struct which reflects engine declined states.
struct EngineState {
  engine: Engine,
  enabled: bool,
}

// A straw-man for the reasons why a sync is happening.
enum SyncReason {
  Scheduled,
  User,
  PreSleep,
  Startup,
}

// A straw man for the general status.
enum ServiceStatus {
  Ok,
  // Some general network issue.
  NetworkError,
  // Some apparent issue with the servers.
  ServiceError,
  // Some external FxA action needs to be taken.
  AuthenticationError,
  // We declined to do anything for backoff or rate-limiting reasons.
  BackedOff,
  // Something else - you need to check the logs for more details.
  OtherError,
}

// Info we need from FxA to sync. This is roughly our Sync15StorageClientInit
// structure with the FxA device ID.
struct AccountInfo {
  key_id: String,
  access_token: String,
  tokenserver_url: Url,
  device_id: String,
}

// Instead of massive param and result lists, we use structures.
// This structure is passed to each and every sync.
struct SyncParams {
  // The engines to Sync. None means "sync all"
  engines: Option&lt;Vec&lt;Engine&gt;&gt;,
  // Why this sync is being done.
  reason: SyncReason,

  // Any state changes which should be done as part of this sync.
  engine_state_changes: Vec&lt;EngineState&gt;,

  // An opaque state "blob". This should be persisted by the app so it is
  // reused next sync.
  persisted_state: Option&lt;String&gt;,
}

struct SyncResult {
  // The general health.
  service_status: ServiceStatus,

  // The result for each engine.
  engine_results: HashMap&lt;Engine, Result&lt;()&gt;&gt;,

  // The list of declined engines, or None if we failed to get that far.
  declined_engines: Option&lt;Vec&lt;Engine&gt;&gt;,

  // When we are allowed to sync again. If &gt; now() then there's some kind
  // of back-off. Note that it's not strictly necessary for the app to
  // enforce this (ie, it can keep asking us to sync, but we might decline).
  // But we might not too - eg, we might try a user-initiated sync.
  next_sync_allowed_at: Timestamp,

  // New opaque state which should be persisted by the embedding app and supplied
  // the next time Sync is called.
  persisted_state: String,

  // Telemetry. Nailing this down is tbd.
  telemetry: Option&lt;JSONValue&gt;,
}

struct SyncManager {}

impl SyncManager {
  // Initialize the sync manager with the set of Engines known by this
  // application without regard to the enabled/declined states.
  // XXX - still TBD is how we will pass "stores" around - it may be that
  // this function ends up taking an `impl Store`
  fn init(&amp;self, engines: Vec&lt;&amp;str&gt;) -&gt; Result&lt;()&gt;;

  fn sync(&amp;self, params: SyncParams) -&gt; Result&lt;SyncResult&gt;;

  // Interrupt any current syncs. Note that this can be called from a different
  // thread.
  fn interrupt() -&gt; Result&lt;()&gt;;

  // Disconnect this device from sync. This may "reset" the stores, but will
  // not wipe local data.
  fn disconnect(&amp;self) -&gt; Result&lt;()&gt;;

  // Wipe all local data for all local stores. This can be done after
  // disconnecting.
  // There's no exposed way to wipe the remote store - while it's possible
  // stores will want to do this, there's no need to expose this to the user.
  fn wipe(&amp;self) -&gt; Result&lt;()&gt;;
}
<span class="boring">}</span></code></pre>
<footer id="open-on-gh-28">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/sync-manager.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="sync-overview"><a class="header" href="#sync-overview">Sync Overview</a></h1>
<p>This document provides a high-level overview of how syncing works.  <strong>Note</strong>: each component has its own quirks and will handle sync slightly differently than the general process described here.</p>
<h2 id="general-flow-and-architecture"><a class="header" href="#general-flow-and-architecture">General flow and architecture</a></h2>
<ul>
<li><strong>Crates involved</strong>:
<ul>
<li>The <code>sync15</code> and <code>support/sync15-traits</code> handle the general syncing logic and define the <code>SyncEngine</code> trait</li>
<li>Individual component crates (<code>logins</code>, <code>places</code>, <code>autofill</code>, etc).  These implement <code>SyncEngine</code>.</li>
<li><code>sync_manager</code> manages the overall syncing process.</li>
</ul>
</li>
<li><strong>High level sync flow</strong>:
<ul>
<li>Sync is initiated by the application that embeds application-services.</li>
<li>The application calls <code>SyncManager.sync()</code> to start the sync process.</li>
<li><code>SyncManager</code> creates <code>SyncEngine</code> instances to sync the individual components.  Each <code>SyncEngine</code> corresponds to a <code>collection</code> on the sync server.</li>
</ul>
</li>
</ul>
<h3 id="sync-manager-1"><a class="header" href="#sync-manager-1">Sync manager</a></h3>
<p><a href="https://github.com/mozilla/application-services/blob/main/components/sync_manager/src/manager.rs"><code>SyncManager</code></a> is responsible for performing the high-level parts of the sync process:</p>
<ul>
<li>The consumer code calls it’s <code>sync()</code> function to start the sync, passing
in a <a href="https://mozilla.github.io/application-services/rust-docs/sync_manager/msg_types/struct.SyncParams.html"><code>SyncParams</code></a> object in, which describes what should be synced.</li>
<li><code>SyncManager</code> performs all network operations on behalf of the individual engines. It’s also responsible for tracking the general authentication state (primarily by inspecting the responses from these network requests) and fetching tokens from the token server.</li>
<li><code>SyncManager</code> checks if we are currently in a backoff period and should wait before contacting the server again.</li>
<li>Before syncing any engines, the sync manager checks the state of the meta/global collection and compares it with the enabled engines specified in the SyncParams.  This handles the cases when the user has requested an engine be enabled or disabled on this device, or when it was requested on a different device. (Note that engines enabled and disabled states are state on the account itself and not a per-device setting).  Part of this process is comparing the collection’s GUID on the server with the GUID known locally - if they are different, it implies some other device has “reset” the collection, so the engine drops all metadata and attempts to reconcile with every record on the server (ie, acts as though this is the very first sync this engine has ever done).</li>
<li><code>SyncManager</code> instantiates a <code>SyncEngine</code> for each enabled component.  We currently use 2 different methods for this:
<ul>
<li>The older method is for the <code>SyncManager</code> to hold a weakref to a <code>Store</code> use that to create the <code>SyncEngine</code> (tabs and places).  The <code>SyncEngine</code> uses the <code>Store</code> for database access, see the <a href="https://mozilla.github.io/application-services/rust-docs/tabs/struct.TabsStore.html"><code>TabsStore</code></a> for an example.</li>
<li>The newer method is for the components to provide a function to create the <code>SyncEngine</code>, hiding the details of how that engine gets created (autofill/logins).  These components also define a <code>Store</code> instance for the <code>SyncEngine</code> to use, but it’s all transparent to the <code>SyncManager</code>.  (See <a href="https://mozilla.github.io/application-services/rust-docs/autofill/db/store/fn.get_registered_sync_engine.html"><code>autofill::get_registered_sync_engine()</code></a> and <a href="https://mozilla.github.io/application-services/rust-docs/autofill/db/store/struct.Store.html"><code>autofill::db::store::Store</code></a>)</li>
</ul>
</li>
<li>For components that use local encryption, <code>SyncManager</code> passes the local encryption key to their <code>SyncEngine</code></li>
<li>Finally, calls <code>sync_multiple()</code> function from the <code>sync15</code> crate, sending it the <code>SyncEngine</code> instances.  <code>sync_multiple()</code> then calls the <code>sync()</code> function for each individual <code>SyncEngine</code></li>
</ul>
<h3 id="sync-engines"><a class="header" href="#sync-engines">Sync engines</a></h3>
<ul>
<li><a href="https://github.com/mozilla/application-services/blob/main/components/support/sync15-traits/src/engine.rs"><code>SyncEngine</code></a> is defined in the <code>support/sync15-traits</code> crate and defines the interface for syncing a component.</li>
<li>A new <code>SyncEngine</code> instance is created for each sync</li>
<li><code>SyncEngine.apply_incoming()</code> does the main work.  It is responsible for processing incoming records from the server in order to update the local records and calculating which local records should be synced back.</li>
</ul>
<h2 id="the-apply_incoming-pattern"><a class="header" href="#the-apply_incoming-pattern">The <code>apply_incoming</code> pattern</a></h2>
<p><code>SyncEngine</code> instances are free to implement <code>apply_incoming()</code> any way they want, but the most components follow a general pattern.</p>
<h3 id="database-tables"><a class="header" href="#database-tables">Database Tables</a></h3>
<ul>
<li>The local table stores records for the local application</li>
<li>The mirror table stores the last known record from the server</li>
<li>The staging temporary table stores the incoming records that we’re currently processing</li>
<li>The local/mirror/staging tables contains a <code>guid</code> as its primary key.  A record will share the same <code>guid</code> for the local/mirror/staging table.</li>
<li>The metadata table stores the GUID for the collection as a whole and the the last-known server timestamp of the collection.</li>
</ul>
<h3 id="apply_incoming-stages"><a class="header" href="#apply_incoming-stages"><code>apply_incoming</code> stages</a></h3>
<ul>
<li><strong>stage incoming</strong>: write out each incoming server record to the staging table</li>
<li><strong>fetch states</strong>: take the rows from all 3 tables and combine them into a single struct containing <code>Option</code>s for the local/mirror/staging records.</li>
<li><strong>iterate states</strong>: loop through each state, decide how to do change the local records, then execute that plan.
<ul>
<li><strong>reconcile/plan</strong>: For each state we create an action plan for it.  The action plan is a low-level description of what to change (add this record, delete this one, modify this field, etc).  Here are some common situations:
<ul>
<li><strong>A record only appears in the staging table</strong>.  It’s a new record from the server and should be added to the local DB</li>
<li><strong>A record only appears in the local table</strong>.  It’s a new record on the local instance and should be synced back to the serve</li>
<li><strong>Identical records appear in the local/mirror tables and a changed record is in the staging table</strong>.  The record was updated remotely and the changes should be propagated to the local DB.</li>
<li><strong>A record appears in the mirror table and changed records appear in both the local and staging tables</strong>.  The record was updated both locally and remotely and we should perform a 3-way merge.</li>
</ul>
</li>
<li><strong>apply plan</strong>: After we create the action plan, then we execute it.</li>
</ul>
</li>
<li><strong>fetch outgoing</strong>:
<ul>
<li>Calculate which records need to be sent back to the server</li>
<li>Update the mirror table</li>
<li>Return those records back to the <code>sync15</code> code so that it can upload them to the server.</li>
<li>The sync15 code returns the timestamp reported by the server in the POST response and hands it back to the engine. The engine persists this timestamp in the metadata table - the next sync will then use this timestamp to only fetch records that have since been changed by other devices</li>
</ul>
</li>
</ul>
<h3 id="syncchangecounter"><a class="header" href="#syncchangecounter">syncChangeCounter</a></h3>
<p>The local table has an integer column syncChangeCounter which is incremented every time the embedding app makes a change to a local record (eg, updating a field). Thus, any local record with a non-zero change counter will need to be updated on the server (with either the local record being used, or after it being merged if the record also changed remotely). At the start of the sync, when we are determining what action to take, we take a copy of the change counter, typically in a temp staging table. After we have uploaded the record to the server, we decrement the counter by whatever it was when the sync started. This means that if a record is changed in between staging the record and uploading it, the change counter will not drop to zero, and so it will correctly be seen as locally modified on the next sync</p>
<footer id="open-on-gh-29">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/sync-overview.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="high-level-design-for-shipping-rust-components-as-swift-packages"><a class="header" href="#high-level-design-for-shipping-rust-components-as-swift-packages">High level design for shipping Rust Components as Swift Packages</a></h1>
<blockquote>
<p>This is a high level description of the decision highlighted in the <a href="#distributing-swift-packages">ADR that introduced Swift Packages as a strategy to ship our Rust components</a>. That document includes that tradeoffs and why we chose this approach.</p>
</blockquote>
<!--
  N.B. you can edit this image in Google Docs and changes will be reflected automatically:

    https://docs.google.com/drawings/d/1tX05I-e6hNBQxch7PescDH7k4G7ddAJwXDPoIqp1RYk/edit
-->
<img src="https://docs.google.com/drawings/d/e/2PACX-1vRnyxy7VjdD3bYTso8V3AL5FpIQ4_S54dOCDI6fxfZEbG3_CVBwZZP1uLYbUVE9M54GSXUkNgewzOQm/pub?w=720&amp;h=540" width="720" height="540" alt="A box diagram describing how the rust-components-swift repo, applicaiton-services repo, and MozillaRustComponents XCFramework interact">
<p>The strategy includes two main parts:</p>
<ul>
<li>The <a href="https://developer.apple.com/documentation/swift_packages/distributing_binary_frameworks_as_swift_packages">xcframework</a> that is built from a <a href="#megazording">megazord</a>. The xcframework contains the following, built for all our target iOS platforms.
<ul>
<li>The compiled Rust code for all the crates listed in <code>Cargo.toml</code> as a static library</li>
<li>The C header files and <a href="https://clang.llvm.org/docs/Modules.html">Swift module maps</a> for the components</li>
</ul>
</li>
<li>The firefox-ios repo uses a local <a href="https://github.com/mozilla-mobile/firefox-ios/blob/main/MozillaRustComponents/Package.swift">swift package</a> and an example of how they consume the xcframework <a href="https://github.com/mozilla/application-services/pull/6898">here</a>.</li>
</ul>
<h2 id="the-xcframework-and-application-services"><a class="header" href="#the-xcframework-and-application-services">The xcframework and <code>application-services</code></a></h2>
<p>In <code>application-services</code>, in the <a href="https://github.com/mozilla/application-services/tree/main/megazords/ios-rust"><code>megazords/ios-rust</code></a> directory, we have the following:</p>
<ul>
<li>A Rust crate that serves as the <a href="#megazording">megazord</a> for our iOS distributions. The megazord depends on all the Rust Component crates and re-exports their public APIs.</li>
<li>Some skeleton files for building an xcframework:
1. <a href="https://clang.llvm.org/docs/Modules.html"><code>module.modulemap</code></a>: The module map tells the Swift compiler how to use C APIs.
1. <code>MozillaRustComponents.h</code>: The header is used by the module map as a shortcut to specify all the available header files
1. <code>Info.plist</code>: The <code>plist</code> file specifies metadata about the resulting xcframework. For example, architectures and subdirectories.</li>
<li>The <code>build-xcframework.sh</code> script that stitches things together into a full xcframework bundle:
<ul>
<li>The <code>xcframework</code> format is not well documented; briefly:
<ul>
<li>The xcframework is a directory containing the resources compiled for multiple target architectures. The xcframework is distributed as a <code>.zip</code> file.</li>
<li>The top-level directory contains a subdirectory per architecture and an <code>Info.plist</code>. The <code>Info.plist</code> describes what lives in which directory.</li>
<li>Each subdirectory represents an architecture. And contains a <code>.framework</code> directory for that architecture.</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>It’s a little unusual that we’re building the xcframework by hand, rather than defining it as the build output of an Xcode project. It turns out to be simpler for our purposes, but does risk diverging from the expected format if Apple changes the details of xcframeworks in future Xcode releases.</p>
</blockquote>
<h2 id="consuming-application-services-in-a-swift-package-firefox-ios"><a class="header" href="#consuming-application-services-in-a-swift-package-firefox-ios">Consuming Application Services in a Swift package (Firefox iOS)</a></h2>
<p>Firefox iOS consumes the XCFramework via a local swift package: <a href="https://github.com/mozilla-mobile/firefox-ios/blob/main/MozillaRustComponents/Package.swift">MozillaRustComponents/Package.swift</a>.</p>
<p>Core requirements:</p>
<ul>
<li>A <code>binaryTarget</code> for <code>MozillaRustComponents</code> (URL+checksum for published zips, or a local <code>path:</code> for testing).</li>
<li>A location for UniFFI-generated Swift bindings in your package targets.</li>
<li>A target app that supports swift packages to consume the above binary + files.</li>
</ul>
<p>Example (URL-based):</p>
<pre><code class="language-swift">.binaryTarget(
  name: "MozillaRustComponents",
  url: "&lt;artifact-url&gt;/MozillaRustComponents.xcframework.zip",
  checksum: "&lt;sha256&gt;"
)

.target(
    name: "MozillaAppServices",
    dependencies: ["MozillaRustComponents"],
    path: "Sources/MozillaRustComponentsWrapper"
),
</code></pre>
<h2 id="the-rust-components-swift-repository"><a class="header" href="#the-rust-components-swift-repository">The <code>rust-components-swift</code> repository</a></h2>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>rust-components-swift has been deprecated and is only around until there are no more potential uplifts to already-landed versions of firefox-ios. firefox-ios now consumes application-services via <a href="https://github.com/mozilla-mobile/firefox-ios/tree/main/MozillaRustComponents">local swift package</a></p>
</blockquote>
<p>The repository is a Swift Package for distributing releases of Mozilla’s various Rust-based application components. It provides the Swift source code packaged in a format understood by the Swift package manager, and depends on a pre-compiled binary release of the underlying Rust code published from <code>application-services</code></p>
<p>The <code>rust-components-swift</code> repo mainly includes the following:</p>
<ul>
<li><code>Package.swift</code>: Defines all the <a href="https://developer.apple.com/documentation/swift_packages/target"><code>targets</code></a> and <a href="https://developer.apple.com/documentation/swift_packages/product"><code>products</code></a> the package exposes.
<ul>
<li><code>Package.swift</code> also includes where the package gets the <code>xcframework</code> that <code>application-services</code> builds</li>
</ul>
</li>
<li><code>make_tag.sh</code>: A script that does the following:
<ul>
<li>Generates any dynamically generated Swift code, mainly:
<ul>
<li>The <a href="https://github.com/mozilla/uniffi-rs/">uniffi</a> generated Swift bindings</li>
<li><a href="https://mozilla.github.io/glean/book/user/adding-glean-to-your-project/swift.html#setting-up-metrics-and-pings-code-generation">The Glean metrics</a></li>
</ul>
</li>
<li>Creates and commits a git tag that can be pushed to cut a release</li>
</ul>
</li>
</ul>
<blockquote>
<p>Consumers would then import the <code>rust-components-swift</code> swift package, by indicating the url of the package on github (i.e <a href="https://github.com/mozilla/rust-components-swift">https://github.com/mozilla/rust-components-swift</a>) and selecting a version using the git tag.</p>
</blockquote>
<footer id="open-on-gh-30">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/swift-package-manager.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="rust-components-strategy"><a href="#rust-components-strategy" class="header">Rust Component's Strategy</a></h1>
<h2 id="high-level-firefox-sync-interactions"><a class="header" href="#high-level-firefox-sync-interactions">High level firefox sync interactions</a></h2>
<p>On a high level, Firefox Sync has three main components:</p>
<ul>
<li>The Firefox Account Server: Which uses oauth to authenticate and provide users with scoped access. The FxA Server also stores input that will
be used by the <strong>clients</strong> to generate the sync keys.</li>
<li>Firefox: This is the firefox app itself, which implements the client logic to communicate with the firefox account servers, generate sync keys,
use them to encrypt data and send/receive encrypted data to/from the sync
storage servers</li>
<li>Sync Storage Server: The server that stores <strong>encrypted</strong> sync data. The clients would retrieve the encrypted data and decrypt
it <strong>client side</strong></li>
</ul>
<p>Additionally, the token server assists in providing metadata to Firefox, so that it knows which sync server to communicate with.
<img src="diagrams/high-level-sync-ecosystem.png" alt="Diagram showing on a high level, how Firefox sync interacts with Firefox Accounts and Sync Services"></p>
<h2 id="multi-platform-sync-diagram"><a class="header" href="#multi-platform-sync-diagram">Multi-platform sync diagram</a></h2>
<p>Since we have multiple Firefox apps (Desktop, iOS, Android, Focus, etc) Firefox sync can sync across platforms. Allowing users
to access their up-to-date data across apps and devices.
<img src="diagrams/multi-platform-sync-diagram.png" alt="Diagram showing how firefox sync is a multi-platform feature"></p>
<h3 id="before-how-sync-was"><a class="header" href="#before-how-sync-was">Before: How sync was</a></h3>
<p>Before our Rust Components came to life, each application had its own implementation of the sync and FxA client protocols.
This lead to duplicate logic across platforms. This was problematic since any modification to the sync or FxA client business logic
would need to be modified in all implementations and the likelihood of errors was high.
<img src="diagrams/before-cross-components.png" alt="Diagram showing how firefox sync used to be, with each platform having its own implementation"></p>
<h3 id="now-sync-is-starting-to-streamline-its-components"><a class="header" href="#now-sync-is-starting-to-streamline-its-components">Now: Sync is starting to streamline its components</a></h3>
<p>We have updated much of our sync implementation to use our Rust Components strategy on mobile. Additionally, Firefox Desktop also uses
two Rust components (Tabs and Web Extension Storage).</p>
<p>The Rust components not only unify the different implementations of sync, they also provide a convenient local storage for the apps.
In other words, the apps can use the components for storage, with or without syncing to the server.
<img src="diagrams/now-cross-components.png" alt="Diagram showing how firefox sync is now, with iOS and Fenix platform sharing some implementations"></p>
<h4 id="current-status"><a class="header" href="#current-status">Current Status</a></h4>
<p>The following table has the status of each of our sync Rust Components</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Application\Component</th><th>Bookmarks</th><th>History</th><th>Tabs</th><th>Passwords</th><th>Autofill</th><th>Web Extension Storage</th><th>FxA Client</th></tr>
</thead>
<tbody>
<tr><td>Fenix</td><td>✔️</td><td>✔️</td><td>✔️</td><td>✔️</td><td>✔️</td><td></td><td>✔️</td></tr>
<tr><td>Firefox iOS</td><td>✔️</td><td>✔️</td><td>✔️</td><td>✔️</td><td>✔️</td><td></td><td>✔️</td></tr>
<tr><td>Firefox Desktop</td><td></td><td></td><td>✔️</td><td></td><td></td><td>✔️</td><td></td></tr>
<tr><td>Focus</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
</tbody>
</table>
</div>
<h3 id="future-only-one-implementation-for-each-sync-engine"><a class="header" href="#future-only-one-implementation-for-each-sync-engine">Future: Only one implementation for each sync engine</a></h3>
<p>In an aspirational future, all the applications would use the same implementation for Sync.
However, it’s unlikely that we would migrate everything to use the Rust components since some implementations
may not be prioritized, this is especially true for desktop which already has stable implementations.
That said, we can get close to this future and minimize duplicate logic and the likelihood of errors.
<img src="diagrams/future-cross-components.png" alt="Diagram showing how firefox sync should be, with all platforms using one implementation"></p>
<p>You can edit the diagrams in the following lucid chart (Note: Currently only Mozilla Employees can edit those diagrams): https://lucid.app/lucidchart/invitations/accept/inv_ab72e218-3ad9-4604-a7cd-7e0b0c259aa2</p>
<p>Once they are edited, you can re-import them here by replacing the old diagrams in the <code>docs/diagrams</code> directory on GitHub. As long as the
names are the same, you shouldn’t need to edit those docs!</p>
<footer id="open-on-gh-31">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/components-strategy.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="metrics---glean-telemetry"><a href="#metrics---glean-telemetry" class="header">Metrics - (Glean Telemetry)</a></h1>
<h2 id="metrics-collected-by-application-services-components"><a class="header" href="#metrics-collected-by-application-services-components">Metrics collected by Application Services components</a></h2>
<p>Some application-services components collect telemetry using the <a href="https://mozilla.github.io/glean/">Glean SDK</a>.</p>
<p>Products that send telemetry via Glean <em>must request</em> a data-review following
<a href="https://wiki.mozilla.org/Firefox/Data_Collection">the Firefox Data Collection process</a>
before integrating any of the components listed below.</p>
<footer id="open-on-gh-32">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/metrics.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="rust-versions"><a class="header" href="#rust-versions">Rust Versions</a></h1>
<p>Like almost all Rust projects, the entire point of the application-services
components is that they be used by external projects. If these components
use Rust features available in only the very latest Rust version, this will
cause problems for projects which aren’t always able to be on that latest
version.</p>
<p>Given application-services is currently developed and maintained by Mozilla
staff, it should be no surprise that an important consideration is
mozilla-central (aka, the main Firefox repository).</p>
<h2 id="mozilla-central-rust-policies"><a class="header" href="#mozilla-central-rust-policies">Mozilla-central Rust policies.</a></h2>
<p>It should also come as no surprise that the Rust policy for mozilla-central
is somewhat flexible. There is an official <a href="https://firefox-source-docs.mozilla.org/writing-rust-code/update-policy.html">Rust Update Policy Document
</a>
but everything in the future is documented as “estimated”.</p>
<p>Ultimately though, that page defines 2 Rust versions - “Uses” and “Requires”,
and our policy revolves around these.</p>
<p>To discover the current, actual “Uses” version, there is a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1504858">Meta bug on Bugzilla</a> that keeps
track of the latest versions as they are upgraded.</p>
<p>To discover the current, actual “Requires” version, <a href="https://searchfox.org/mozilla-central/search?q=MINIMUM_RUST_VERSION&amp;path=python/mozboot/mozboot/util.py">see searchfox</a></p>
<h1 id="application-services-rust-version-policy"><a class="header" href="#application-services-rust-version-policy">application-services Rust version policy</a></h1>
<p>Our official Rust version policy is:</p>
<ul>
<li>
<p>All components will ship using, have all tests passing, and have clippy emit
no warnings, with the same version mozilla-central currently “uses”.</p>
</li>
<li>
<p>All components  must be capable of building (although not necessarily with
all tests passing nor without clippy errors or other warnings) with the same
version mozilla-central currently “requires”.</p>
</li>
<li>
<p>This policy only applies to the “major” and “minor” versions - a different
patch level is still considered compliant with this policy.</p>
</li>
</ul>
<h2 id="implications-of-this"><a class="header" href="#implications-of-this">Implications of this</a></h2>
<p>All CI for this project will try and pin itself to this same version. At
time of writing, this means that <a href="https://github.com/mozilla/application-services/blob/main/.circleci/config.yml">our circle CI integration
</a> and
<a href="https://github.com/mozilla/application-services/blob/main/rust-toolchain.toml">rust-toolchain configuration</a>
will specify the versions (and where possible, the CI configuration file will
avoid duplicating the information in <code>rust-toolchain</code>)</p>
<p>We should maintain CI to ensure we still build with the “Requires” version.</p>
<p>As versions inside mozilla-central change, we will bump these versions
accordingly. While newer versions of Rust can be expected to work correctly
with our existing code, it’s likely that clippy will complain in various ways
with the new version. Thus, a PR to bump the minimum version is likely to also
require a PR to make changes which keep clippy happy.</p>
<p>In the interests of avoiding redundant information which will inevitably
become stale, the circleci and rust-toolchain configuration links above
should be considered the canonical source of truth for the currently supported
official Rust version.</p>
<footer id="open-on-gh-33">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/rust-versions.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="sqlite-database-pragma-usage"><a class="header" href="#sqlite-database-pragma-usage">Sqlite Database Pragma Usage</a></h1>
<p>The data below has been added as a tool for future pragma analysis work and is expected to be useful so long as our pragma usage remains stable or this doc is kept up-to-date. This should help us understand our current pragma usage and where we may be able to make improvements.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Pragma</th><th>Value</th><th>Component</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td><a href="https://www.sqlite.org/pragma.html#pragma_cache_size">cache_size</a></td><td>-6144</td><td>places</td><td></td></tr>
<tr><td><a href="https://www.sqlite.org/pragma.html#pragma_foreign_keys">foreign_keys</a></td><td>ON</td><td>autofill, places, tabs, webext-storage</td><td></td></tr>
<tr><td><a href="https://www.sqlite.org/pragma.html#pragma_journal_mode">journal_mode</a></td><td>WAL</td><td>autofill, places, tabs, webext-storage</td><td></td></tr>
<tr><td><a href="https://www.sqlite.org/pragma.html#pragma_page_size">page_size</a></td><td>32768</td><td>places</td><td></td></tr>
<tr><td><a href="https://www.sqlite.org/pragma.html#pragma_secure_delete">secure_delete</a></td><td>true</td><td>logins</td><td></td></tr>
<tr><td><a href="https://www.sqlite.org/pragma.html#pragma_temp_store">temp_store</a></td><td>2</td><td>autofill, logins, places, tabs, webext_storage</td><td>Setting <code>temp_store</code> to 2 (MEMORY) is necessary to avoid <a href="https://www.javadoc.io/doc/org.xerial/sqlite-jdbc/3.15.1/org/sqlite/SQLiteErrorCode.html#SQLITE_IOERR_GETTEMPPATH">SQLITE_IOERR_GETTEMPPATH</a> errors on Android (see <a href="https://github.com/mozilla/application-services/blob/62bef6a0d49f8ab17b969e8ce482ac12c53f0987/components/logins/src/db.rs#L79">here</a> for details)</td></tr>
<tr><td><a href="https://www.sqlite.org/pragma.html#pragma_wal_autocheckpoint">wal_autocheckpoint</a></td><td>62</td><td>places</td><td></td></tr>
<tr><td><a href="https://www.sqlite.org/pragma.html#pragma_wal_checkpoint">wal_checkpoint</a></td><td>PASSIVE</td><td>places</td><td>Used in the <code>sync finished</code> step in history and bookmarks syncing and in the places <code>run_maintenance</code> function</td></tr>
</tbody>
</table>
</div>
<ul>
<li>The <a href="https://www.sqlite.org/pragma.html#pragma_user_version">user_version</a> pragma is excluded because the value varies and sqlite does not do anything with the value.</li>
<li>The push component does not implement any of the commonly used pragmas noted above.</li>
<li><a href="https://www.zetetic.net/sqlcipher/sqlcipher-api/">The sqlcipher pragmas</a> that we set have been excluded from this list as we are trying to remove sqlcipher and do not want to encourage future use.</li>
</ul>
<footer id="open-on-gh-34">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/db-pragmas.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="application-services-release-process"><a class="header" href="#application-services-release-process">Application Services Release Process</a></h1>
<h2 id="nightly-builds"><a class="header" href="#nightly-builds">Nightly builds</a></h2>
<p>Nightly builds are automatically generated using a taskcluster cron task.</p>
<ul>
<li>The results of the latest successful nightly build is listed here:
https://firefox-ci-tc.services.mozilla.com/tasks/index/project.application-services.v2.nightly/latest</li>
<li>The latest nightly decision task should be listed here:
https://firefox-ci-tc.services.mozilla.com/tasks/index/project.application-services.v2.branch.main.latest.taskgraph/decision-nightly</li>
<li>If you don’t see a decision task from the day before, then contact releng.  It’s likely that the cron decision task is broken.</li>
</ul>
<h2 id="release-builds"><a class="header" href="#release-builds">Release builds</a></h2>
<p>Release builds are generated from the <code>release-vXXX</code> branches and triggered in Ship-it</p>
<ul>
<li>Whenever a commit is pushed to a release branch, we build candidate artifacts. These artifacts are
shippable – if we decide that the release is ready, they just need to be copied to the correct
location.</li>
<li>The <code>push</code> phase of <code>release-promotion</code> copies the candidate to a staging location where they can
be tested.</li>
<li>The <code>ship</code> phase of <code>release-promotion</code> copies the candidate to their final, published, location.</li>
</ul>
<h2 id="release-management-creating-a-new-release"><a class="header" href="#release-management-creating-a-new-release">[Release management] Creating a new release</a></h2>
<blockquote>
<p>This part is 100% covered by the Release Management team. The dev team should not perform these steps.</p>
</blockquote>
<p>This is documented under Release Management/Release Process Checklist Documentation, see application-services steps under <a href="https://wiki.mozilla.org/Release_Management/Release_Process_Checklist_Documentation#The_following_tasks_need_to_be_performed_on_Merge_Day_at_the_start_of_the_Beta_cycle">Beta Merge Day steps</a></p>
<h3 id="cutting-patch-releases-for-uplifted-changes-dot-release"><a class="header" href="#cutting-patch-releases-for-uplifted-changes-dot-release">Cutting patch releases for uplifted changes (dot-release)</a></h3>
<p>If you want to uplift changes into a previous release:</p>
<ul>
<li>Make sure the changes are present in <code>main</code> and have been thoroughly tested</li>
<li>Find the PR for the changes and add this comment: <code>@mergify backport release-vXXX</code></li>
<li>Find the Bugzilla bug with the changes and add an uplift request
<ul>
<li>Find the attacment corresponding to new PR created from the <code>@mergify</code> comment.</li>
<li>Click the “details” link</li>
<li>Set <code>approval-mozilla-beta</code> or <code>approval-mozilla-release</code> to <code>?</code></li>
<li>Save the form</li>
</ul>
</li>
<li>Release management will then:
<ul>
<li>Arrange for the backport to be merged</li>
<li>Create a new Application Services release in Ship-It for the release branch. Promote &amp; ship the release</li>
<li>Tag the release in the Application Services repo</li>
</ul>
</li>
<li>Notify the Application Services team in case there is a need to cut a new release of <a href="https://github.com/mozilla/rust-components-swift">rust-components-swift</a></li>
<li>Notify any affected consumer applications teams.</li>
</ul>
<h1 id="what-gets-built-in-a-release"><a class="header" href="#what-gets-built-in-a-release">What gets built in a release?</a></h1>
<p>We build several artifacts for both nightlies and releases:</p>
<ul>
<li><code>nightly.json</code> / <code>release.json</code>.  This is a JSON file containing metadata from successful
builds.  The metadata for the latest successful build can be found from a taskcluster index:
https://firefox-ci-tc.services.mozilla.com/api/index/v1/task/project.application-services.v2.release.latest/artifacts/public%2Fbuild%2Frelease.json
The JSON file contains:
<ul>
<li>The version number for the nightly/release</li>
<li>The git commit ID</li>
<li>The maven channel for Kotlin packages:
<ul>
<li><code>maven-production</code>: https://maven.mozilla.org/?prefix=maven2/org/mozilla/appservices/</li>
<li><code>maven-nightly-production</code>: https://maven.mozilla.org/?prefix=maven2/org/mozilla/appservices/nightly/</li>
<li><code>maven-staging</code>: https://maven-default.stage.mozaws.net/?prefix=maven2/org/mozilla/appservices/</li>
<li><code>maven-nightly-staging</code>: https://maven-default.stage.mozaws.net/?prefix=maven2/org/mozilla/appservices/nightly/</li>
</ul>
</li>
<li>Links to <code>nimbus-fml.*</code>: used to build Firefox/Focus on Android and iOS</li>
<li>Links to <code>*RustComponentsSwift.xcframework.zip</code>: XCFramework archives used to build Firefox/Focus on iOS</li>
<li>Link to <code>swift-components.tar.xz</code>: UniFFI-generated swift files which get extracted into the
<code>rust-components-swift</code> repository for each release.</li>
</ul>
</li>
</ul>
<h2 id="nightly-builds-1"><a class="header" href="#nightly-builds-1">Nightly builds</a></h2>
<p>For nightly builds, consumers get the artifacts directly from the taskcluster.</p>
<ul>
<li>For, <code>firefox-android</code>, the nightlies are handled by <a href="https://github.com/mozilla-mobile/relbot/">relbot</a></li>
<li>For, <code>firefox-ios</code>, the nightlies are consumed by a local swift package in firefox-ios https://github.com/mozilla-mobile/firefox-ios/tree/main/MozillaRustComponents</li>
</ul>
<h2 id="release-promotion"><a class="header" href="#release-promotion">Release promotion</a></h2>
<p>For real releases, we use the taskcluster release-promotion action.  Release promotion happens in two phases:</p>
<ul>
<li><code>promote</code> copies the artifacts from taskcluster and moves them to a staging area.  This
allows for testing the consumer apps with the artifacts.</li>
<li><code>ship</code> copies the artifacts from the staging area to archive.mozilla.org, which serves as
their permanent storage area.</li>
</ul>
<footer id="open-on-gh-35">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/releases.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="ci-publishing-tools-and-flow"><a href="#ci-publishing-tools-and-flow" class="header">CI Publishing tools and flow</a></h1>
<h2 id="application-services-build-and-publish-pipeline"><a class="header" href="#application-services-build-and-publish-pipeline">Application Services Build and Publish Pipeline</a></h2>
<p>This document provides an overview of the build-and-publish pipeline used to make our work
in this repo available to consuming applications. It’s intended both to document the pipeline
for development and maintenance purposes, and to serve as a basic analysis of the integrity
protections that it offers (so you’ll notice there are notes and open questions in place where
we haven’t fully hashed out all those details).</p>
<p>The key points:</p>
<ul>
<li>We use “stable” <a href="https://www.rust-lang.org/">Rust</a>. CI is pinned to whatever version is currently used on mozilla-central
to help with vendoring into that repository. You should check what current values are
specified for <a href="../.circleci/config.yml">CircleCI</a> and for <a href="../taskcluster/scripts/toolchain/rustup-setup.sh">TaskCluster</a></li>
<li>We use <a href="https://github.com/rust-lang/cargo">Cargo</a> for building and testing the core Rust code in isolation,
<a href="https://gradle.org/">Gradle</a> with <a href="https://github.com/mozilla/rust-android-gradle">rust-android-gradle</a>
for combining Rust and Kotlin code into Android components and running tests against them,
and <a href="https://developer.apple.com/documentation/swift_packages/distributing_binary_frameworks_as_swift_packages">XCframeworks</a> driving <a href="../xconfig">XCode</a>
for combining Rust and Swift code into iOS components.</li>
<li><a href="../automation/taskcluster/README.html">TaskCluster</a> runs on every pull-request, release,
and push to main, to ensure Android artifacts build correctly and to execute their
tests via gradle.</li>
<li><a href="../.circleci/config.yml">CircleCI</a> runs on every branch, pull-request (including forks), and release,
to execute lint checks and automated tests at the Rust and Swift level.</li>
<li>Releases align with the Firefox Releases schedules, and nightly releases are automated to run daily see the <a href="#application-services-release-process">releases</a> for more information</li>
<li>Notifications about build failures are sent to a mailing list at
<a href="https://groups.google.com/a/mozilla.com/forum/#!forum/a-s-ci-failures">a-s-ci-failures@mozilla.com</a></li>
<li>Our Taskcluster implementation is almost entirely maintained by the Release Engineering team.
The proper way to contact them in case of emergency or for new developments is to ask on the <code>#releaseduty-mobile</code> Slack channel.
Our main point of contact is @mihai.</li>
</ul>
<p>For Android consumers these are the steps by which Application Services code becomes available,
and the integrity-protection mechanisms that apply at each step:</p>
<ol>
<li>Code is developed in branches and lands on <code>main</code> via pull request.
<ul>
<li>GitHub branch protection prevents code being pushed to <code>main</code> without review.</li>
<li>CircleCI and TaskCluster run automated tests against the code, but do not have
the ability to push modified code back to GitHub thanks to the above branch protection.
<ul>
<li>TaskCluster jobs do not run against PRs opened by the general public,
only for PRs from repo collaborators.</li>
</ul>
</li>
<li>Contra the <a href="https://wiki.mozilla.org/GitHub/Repository_Security">github org security guidelines</a>,
signing of individual commits is encouraged but is <strong>not required</strong>. Our experience in practice
has been that this adds friction for contributors without sufficient tangible benefit.</li>
</ul>
</li>
<li>Developers manually create a release from latest <code>main</code>.
<ul>
<li>The ability to create new releases is managed entirely via github’s permission model.</li>
<li>TODO: the <a href="https://wiki.mozilla.org/GitHub/Repository_Security">github org security guidelines</a>
recommend signing tags, and auditing all included commits as part of the release process.
We should consider some tooling to support this. I don’t think there’s any way to force
githib to only accept signed releases in the same way it can enforce signed commits.</li>
</ul>
</li>
<li>TaskCluster checks out the release tag, builds it for all target platforms, and runs automated tests.
<ul>
<li>These tasks run in a pre-built docker image, helping assure integrity of the build environment.</li>
<li>TODO: could this step check for signed tags as an additional integrity measure?</li>
</ul>
</li>
<li>TaskCluster uploads symbols to Socorro.
<ul>
<li>The access token for this is currently tied to @eoger’s LDAP account.</li>
</ul>
</li>
<li>TaskCluster uploads built artifacts to maven.mozilla.org
<ul>
<li>Secret key for uploading to maven is provisioned via TaskCluster,
guarded by a scope that’s only available to this task.</li>
<li>TODO: could a malicious dev dependency from step (3) influence the build environment here?</li>
<li>TODO: talk about how TC’s “chain of trust” might be useful here.</li>
</ul>
</li>
<li>Consumers fetch the published artifacts from maven.mozilla.org.</li>
</ol>
<p>For iOS consumers the corresponding steps are:</p>
<ol>
<li>Code is developed in branches and lands on <code>main</code> via pull request, as above.</li>
<li>Developers manually create a release from latest <code>main</code>, as above.</li>
<li>CircleCI checks out the release tag, builds it, and runs automated tests.
<ul>
<li>TODO: These tasks bootstrap their build environment by fetching software over https.
could we do more to ensure the integrity of the build environment?</li>
<li>TODO: could this step check for signed tags as an additional integrity measure?</li>
<li>TODO: can we prevent these steps from being able to see the tokens used
for publishing in subsequent steps?</li>
</ul>
</li>
<li>CircleCI builds a binary artifact:
<ul>
<li>An XCFramework containing just Rust code and header files, as a zipfile, for use by Swift Packages.</li>
<li>TODO: could a malicious dev dependency from step (3) influence the build environment here?</li>
</ul>
</li>
<li>CircleCI uses <a href="https://github.com/travis-ci/dpl">dpl</a> to publish to GitHub as a release artifact.
<ul>
<li>See <a href="#authentication-and-secrets">Authentication and secrets below</a></li>
</ul>
</li>
<li>Consumers can add the Application Services rust components as a dependency in their corresponding swift package by replicating the firefox-ios integration <a href="https://github.com/mozilla-mobile/firefox-ios/tree/main/MozillaRustComponents">here</a>.</li>
</ol>
<p>For consuming in mozilla-central, see <a href="#how-to-vendor-application-services-into-mozilla-central">how to vendor components into mozilla-central
</a></p>
<p>This is a diagram of the pipeline as it exists (and is planned) for the Nimbus SDK, one of the
libraries in Application Services:
(Source: https://miro.com/app/board/o9J_lWx3jhY=/)</p>
<p><img src="diagrams/Nimbus-SDK-Build-and-Publish-Pipeline.jpg" alt="Nimbus SDK Build and Publish Pipeline"></p>
<h2 id="authentication-and-secrets"><a class="header" href="#authentication-and-secrets">Authentication and secrets</a></h2>
<h3 id="appsvc-moz-account"><a class="header" href="#appsvc-moz-account">@appsvc-moz account</a></h3>
<p>There’s an appsvc-moz github account owned by one of the application-services team (currently markh, but we should consider rotating ownership).
Given only 1 2fa device can be connected to a github account, multiple owners doesn’t seem practical.
In most cases, whenever a github account needs to own a secret for any CI, it will be owned by this account.</p>
<h3 id="circleci"><a class="header" href="#circleci">CircleCI</a></h3>
<p>CircleCI config requires a github token (owned by @appsvc-moz). This is a “personal access token”
obtained via github’s Settings -&gt; Developer Settings -&gt; Personal Access Tokens -&gt; Classic Token. This token:</p>
<ul>
<li>Should be named something like “circleci”</li>
<li>Have “no expiration” (XXX - this seems wrong, should we adjust?)</li>
</ul>
<p>Once you have generated the token, it must be added to https://app.circleci.com/settings/project/github/mozilla/application-services/environment-variables as the environment variable <code>GITHUB_TOKEN</code></p>
<footer id="open-on-gh-36">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/build-and-publish-pipeline.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="guide-to-upgrading-nss"><a class="header" href="#guide-to-upgrading-nss">Guide to upgrading NSS</a></h1>
<p>Our components rely on cryptographic primitives provided by <a href="https://firefox-source-docs.mozilla.org/security/nss/index.html">NSS</a>.
Every month or so, a new version of NSS is <a href="https://firefox-source-docs.mozilla.org/security/nss/releases/index.html">published</a> and we should try to keep our version as up-to-date as possible.</p>
<p>Because it makes unit testing easier on Android, and helps startup performance on iOS, we compile NSS ourselves and link to it statically. Note that NSS is mainly used by Mozilla as a dynamic library and the NSS project is missing related CI jobs (iOS builds, windows cross-compile builds etc.) so you should expect breakage when updating the library (hence this guide).</p>
<hr>
<h2 id="updating-the-version"><a class="header" href="#updating-the-version">Updating the Version</a></h2>
<p>The build code is located in the <a href="https://github.com/mozilla/application-services/tree/main/libs"><code>libs/</code></a> folder.</p>
<p>The version string is located in the beginning of <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/libs/build-all.sh#L8-L11"><code>build-all.sh</code></a>.</p>
<p>For most NSS upgrades, you’ll need to bump the version number in this file and update the downloaded archive checksum. Then follow the steps for <a href="#updating-the-cross-compiled-nss-artifacts">Updating the cross-compiled NSS Artifacts</a> below. The actual build invocations are located in platform-specific script files (e.g. <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/libs/build-nss-ios.sh"><code>build-nss-ios.sh</code></a>) but usually don’t require any changes.</p>
<p>To test out updating NSS version:</p>
<ul>
<li>Ensure you’ve bumped the NSS in <code>build-all.sh</code></li>
<li>Clear any old NSS build artifacts: <code>rm -rf ./libs/desktop &amp;&amp; cargo clean</code></li>
<li>Install the updates version: <code>./libs/verify-desktop-environment.sh</code></li>
<li>Try it out: <code>cargo test</code></li>
</ul>
<hr>
<h3 id="updating-the-cross-compiled-nss-artifacts"><a class="header" href="#updating-the-cross-compiled-nss-artifacts">Updating the Cross-Compiled NSS Artifacts</a></h3>
<p>We use a Linux TC worker for cross-compiling NSS for iOS, Android and Linux desktop machines. However, due to the complexity of the NSS build process, there is no easy way for cross-compiling MacOS and Windows – so we currently use pre-built artifacts for MacOS desktop machines (ref <a href="https://github.com/mozilla/application-services/issues/5210">#5210</a>).</p>
<ol>
<li>Look for the tagged version from the <a href="https://treeherder.mozilla.org/jobs?repo=nss">NSS CI</a>
<blockquote>
<p>usually a description with something like <em><code>Added tag NSS_3_90_RTM</code></em></p>
</blockquote>
</li>
<li>Select the build for the following system(s) (first task with the title “B”):
<ul>
<li>For Intel MacOS: <code>mac opt-static</code></li>
</ul>
</li>
<li>Update <a href="https://github.com/mozilla/application-services/blob/main/taskcluster/kinds/fetch/kind.yml">taskcluster/kinds/fetch/kind.yml</a>, specifically <code>nss-artifact</code> task to the appropriate <code>url</code> and <code>checksum</code> and <code>size</code>
<blockquote>
<p>Note: <em>To get the checksum, you can run <code>shasum -a 256 {path-to-artifact}</code> or you can make a PR and see the output of the failed log.</em></p>
</blockquote>
</li>
<li>Update the SHA256 value for darwin cross-compile in <a href="https://github.com/mozilla/application-services/blob/main/libs/build-nss-desktop.sh">libs/build-nss-desktop.sh</a> to the same checksum as above.</li>
<li>Once the pull request lands, <code>build-nss-desktop.sh</code> should be updated once more using the L3 cache <a href="https://firefox-ci-tc.services.mozilla.com/tasks/index/app-services.cache.level-3.content.v1.nss-artifact/latest">Taskcluster artifact</a>.</li>
</ol>
<hr>
<h2 id="exposing-new-functions"><a class="header" href="#exposing-new-functions">Exposing new functions</a></h2>
<p>If the new version of NSS comes with new functions that you want to expose, you will need to:</p>
<ul>
<li>Add low-level bindings for those functions in the <a href="../components/support/rc_crypto/nss/nss_sys"><code>nss_sys</code> crate</a>; follow the instructions in
README for that crate.</li>
<li>Expose a safe wrapper API for the functions from the <a href="../components/support/rc_crypto/nss"><code>nss</code> crate</a>;</li>
<li>Expose a convenient high-level API for the functions from the <a href="../components/support/rc_crypto"><code>rc_crypto</code> crate</a>;</li>
</ul>
<h2 id="tips-for-fixing-bustage"><a class="header" href="#tips-for-fixing-bustage">Tips for Fixing Bustage</a></h2>
<p>On top of the primitives provided by NSS, we have built a safe Rust wrapper named <a href="https://github.com/mozilla/application-services/tree/main/components/support/rc_crypto">rc_crypto</a> that links to NSS and makes these cryptographic primitives available to our components.</p>
<p>The linkage is done by the <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/components/support/rc_crypto/nss/nss_build_common/src/lib.rs"><code>nss_build_common</code></a> crate. Note that it supports a <code>is_gecko</code> feature to link to NSS dynamically on Desktop.</p>
<p>Because the NSS static build process does not output a single <code>.a</code> file (it would be great if it did), this file must <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/components/support/rc_crypto/nss/nss_build_common/src/lib.rs#L85-L133">describe</a> for each architecture which modules should we link against. It is mostly a duplication of logic from the <a href="https://searchfox.org/nss/rev/d0ca572a63597a19889611c065273f131cc09b7a/lib/freebl/freebl.gyp#385-408">NSS gyp build files</a>. Note that this logic is also duplicated in our NSS lib build steps (e.g. <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/libs/build-nss-desktop.sh#L82-L114">build-nss-desktop.sh</a>).</p>
<p>One of the most common build failures we get when upgrading NSS comes from NSS adding new vectorized/asm versions of a crypto algorithm for a specific architecture in order to improve performance. This new optimized code gets implemented as a new gyp target/module that is emitted only for the supported architectures.
When we upgrade our copy of NSS we notice the linking step failing on CI jobs because of undefined symbols.</p>
<p><a href="https://github.com/mozilla/application-services/pull/2476">This PR</a> shows how we update <code>nss_common_build</code> and the build scripts to accommodate for these new modules. Checking the changelog for any suspect commit relating to hardware acceleration is rumored to help.</p>
<footer id="open-on-gh-37">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/upgrading-nss-guide.md">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="rustdocs-for-components"><a href="#rustdocs-for-components" class="header">Rustdocs for components</a></h1>
<p>&lt;meta http-equiv=refresh content=0;url=fxa_client&gt;</p>
<footer id="open-on-gh-38">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/index.html">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="as_ohttp_client"><a href="#as_ohttp_client" class="header">as_ohttp_client</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `as_ohttp_client` crate."><title>as_ohttp_client - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="as_ohttp_client" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate as_ohttp_client</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#as_ohttp_client">as_<wbr>ohttp_<wbr>client</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types" href="rust-docs/as_ohttp_client/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc">
<h3><a href="#structs">Crate Items</a></h3>
<ul class="block">
<li><a href="#structs" title="Structs">Structs</a></li>
<li><a href="#enums" title="Enums">Enums</a></li>
</ul>
</section>
<div id="rustdoc-modnav"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content" class="content">
<div class="main-heading">
<h1>Crate <span>as_<wbr>ohttp_<wbr>client</span> <button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/as_ohttp_client/lib.rs.html#5-306">Source</a> </span></div>
<h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/as_ohttp_client/struct.OhttpResponse.html" title="struct as_ohttp_client::OhttpResponse">Ohttp<wbr>Response</a></dt>
<dt><a class="struct" href="rust-docs/as_ohttp_client/struct.OhttpSession.html" title="struct as_ohttp_client::OhttpSession">Ohttp<wbr>Session</a></dt>
<dt><a class="struct" href="rust-docs/as_ohttp_client/struct.OhttpTestServer.html" title="struct as_ohttp_client::OhttpTestServer">Ohttp<wbr>Test<wbr>Server</a></dt>
<dt><a class="struct" href="rust-docs/as_ohttp_client/struct.TestServerRequest.html" title="struct as_ohttp_client::TestServerRequest">Test<wbr>Server<wbr>Request</a></dt>
</dl>
<h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/as_ohttp_client/enum.OhttpError.html" title="enum as_ohttp_client::OhttpError">Ohttp<wbr>Error</a></dt>
</dl>
</section></div>
</main></body></html>
<footer id="open-on-gh-39">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/as_ohttp_client/index.html">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="autofill"><a href="#autofill" class="header">autofill</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `autofill` crate."><title>autofill - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="autofill" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate autofill</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#autofill">autofill</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-1" href="rust-docs/autofill/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-1">
<h3><a href="#reexports">Crate Items</a></h3>
<ul class="block">
<li><a href="#reexports" title="Re-exports">Re-exports</a></li>
<li><a href="#modules" title="Modules">Modules</a></li>
<li><a href="#macros" title="Macros">Macros</a></li>
</ul>
</section>
<div id="rustdoc-modnav-1"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-1" class="content">
<div class="main-heading">
<h1>Crate <span>autofill</span> <button id="copy-path-1" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/autofill/lib.rs.html#6-25">Source</a> </span></div>
<h2 id="reexports" class="section-header">Re-exports<a href="#reexports" class="anchor">§</a></h2>
<dl class="item-table reexports">
<dt id="reexport.get_registered_sync_engine"><code>pub use crate::db::store::<a class="fn" href="rust-docs/autofill/db/store/fn.get_registered_sync_engine.html" title="fn autofill::db::store::get_registered_sync_engine">get_registered_sync_engine</a>;</code></dt>
<dt id="reexport.ApiResult"><code>pub use error::<a class="type" href="rust-docs/autofill/error/type.ApiResult.html" title="type autofill::error::ApiResult">ApiResult</a>;</code></dt>
<dt id="reexport.AutofillApiError"><code>pub use error::<a class="enum" href="rust-docs/autofill/error/enum.AutofillApiError.html" title="enum autofill::error::AutofillApiError">AutofillApiError</a>;</code></dt>
<dt id="reexport.Error"><code>pub use error::<a class="enum" href="rust-docs/autofill/error/enum.Error.html" title="enum autofill::error::Error">Error</a>;</code></dt>
<dt id="reexport.Result"><code>pub use error::<a class="type" href="rust-docs/autofill/error/type.Result.html" title="type autofill::error::Result">Result</a>;</code></dt>
</dl>
<h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/autofill/db/index.html" title="mod autofill::db">db</a></dt>
<dt><a class="mod" href="rust-docs/autofill/encryption/index.html" title="mod autofill::encryption">encryption</a></dt>
<dt><a class="mod" href="rust-docs/autofill/error/index.html" title="mod autofill::error">error</a></dt>
<dt><a class="mod" href="rust-docs/autofill/sync/index.html" title="mod autofill::sync">sync</a></dt>
</dl>
<h2 id="macros" class="section-header">Macros<a href="#macros" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="macro" href="rust-docs/autofill/macro.sync_merge_field_check.html" title="macro autofill::sync_merge_field_check">sync_<wbr>merge_<wbr>field_<wbr>check</a></dt>
</dl>
</section></div>
</main></body></html>
<footer id="open-on-gh-40">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/autofill/index.html">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="crashtest"><a href="#crashtest" class="header">crashtest</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Crash Test Helper APIs"><title>crashtest - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="crashtest" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate crashtest</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#crashtest">crashtest</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-2" href="rust-docs/crashtest/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-2">
<h3><a href="#">Sections</a></h3>
<ul class="block top-toc">
<li><a href="#crash-test-helper-apis" title="Crash Test Helper APIs">Crash Test Helper APIs</a></li>
</ul>
<h3><a href="#enums-1">Crate Items</a></h3>
<ul class="block">
<li><a href="#enums-1" title="Enums">Enums</a></li>
<li><a href="#functions" title="Functions">Functions</a></li>
</ul>
</section>
<div id="rustdoc-modnav-2"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-2" class="content">
<div class="main-heading">
<h1>Crate <span>crashtest</span> <button id="copy-path-2" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/crashtest/lib.rs.html#5-66">Source</a> </span></div>
<details class="toggle top-doc" open=""><summary class="hideme"><span>Expand description</span></summary>
<div class="docblock">
<h2 id="crash-test-helper-apis"><a class="doc-anchor" href="#crash-test-helper-apis">§</a>Crash Test Helper APIs</h2>

<p>The <code>crashtest</code> component offers a little helper API that lets you deliberately
crash the application. It’s intended to help developers test the crash-handling
and crash-reporting capabilities of their app.</p>

</div>
</details>
<h2 id="enums-1" class="section-header">Enums<a href="#enums-1" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/crashtest/enum.CrashTestError.html" title="enum crashtest::CrashTestError">Crash<wbr>Test<wbr>Error</a></dt>
<dd>An error that can be returned from Rust code.</dd>
</dl>
<h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="fn" href="rust-docs/crashtest/fn.trigger_rust_abort.html" title="fn crashtest::trigger_rust_abort">trigger_<wbr>rust_<wbr>abort</a></dt>
<dd>Trigger a hard abort inside the Rust code.</dd>
<dt><a class="fn" href="rust-docs/crashtest/fn.trigger_rust_error.html" title="fn crashtest::trigger_rust_error">trigger_<wbr>rust_<wbr>error</a></dt>
<dd>Trigger an error inside the Rust code.</dd>
<dt><a class="fn" href="rust-docs/crashtest/fn.trigger_rust_panic.html" title="fn crashtest::trigger_rust_panic">trigger_<wbr>rust_<wbr>panic</a></dt>
<dd>Trigger a panic inside the Rust code.</dd>
</dl>
</section></div>
</main></body></html>
<footer id="open-on-gh-41">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/crashtest/index.html">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="fxa_client"><a href="#fxa_client" class="header">fxa_client</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Firefox Accounts Client"><title>fxa_client - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="fxa_client" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate fxa_client</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#fxa_client">fxa_<wbr>client</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-3" href="rust-docs/fxa_client/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-3">
<h3><a href="#">Sections</a></h3>
<ul class="block top-toc">
<li><a href="#firefox-accounts-client" title="Firefox Accounts Client">Firefox Accounts Client</a></li>
</ul>
<h3><a href="#macros-1">Crate Items</a></h3>
<ul class="block">
<li><a href="#macros-1" title="Macros">Macros</a></li>
<li><a href="#structs-1" title="Structs">Structs</a></li>
<li><a href="#enums-2" title="Enums">Enums</a></li>
<li><a href="#types" title="Type Aliases">Type Aliases</a></li>
</ul>
</section>
<div id="rustdoc-modnav-3"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-3" class="content">
<div class="main-heading">
<h1>Crate <span>fxa_<wbr>client</span> <button id="copy-path-3" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/fxa_client/lib.rs.html#5-261">Source</a> </span></div>
<details class="toggle top-doc" open=""><summary class="hideme"><span>Expand description</span></summary>
<div class="docblock">
<h2 id="firefox-accounts-client"><a class="doc-anchor" href="#firefox-accounts-client">§</a>Firefox Accounts Client</h2>

<p>The fxa-client component lets applications integrate with the
<a href="https://mozilla.github.io/ecosystem-platform/docs/features/firefox-accounts/fxa-overview">Firefox Accounts</a>
identity service. The shape of a typical integration would look
something like:</p>

<ul>
<li>
<p>Out-of-band, register your application with the Firefox Accounts service,
providing an OAuth <code>redirect_uri</code> controlled by your application and
obtaining an OAuth <code>client_id</code>.</p>

</li>

<li>
<p>On application startup, create a <a href="rust-docs/fxa_client/struct.FirefoxAccount.html" title="struct fxa_client::FirefoxAccount"><code>FirefoxAccount</code></a> object to represent the
signed-in state of the application.</p>

<ul>
<li>On first startup, a new <a href="rust-docs/fxa_client/struct.FirefoxAccount.html" title="struct fxa_client::FirefoxAccount"><code>FirefoxAccount</code></a> can be created by calling
<a href="rust-docs/fxa_client/struct.FirefoxAccount.html#method.new" title="associated function fxa_client::FirefoxAccount::new"><code>FirefoxAccount::new</code></a> and passing the application’s <code>client_id</code>.</li>

<li>For subsequent startups the object can be persisted using the
<a href="rust-docs/fxa_client/struct.FirefoxAccount.html#method.to_json" title="method fxa_client::FirefoxAccount::to_json"><code>to_json</code></a> method and re-created by
calling <a href="rust-docs/fxa_client/struct.FirefoxAccount.html#method.from_json" title="associated function fxa_client::FirefoxAccount::from_json"><code>FirefoxAccount::from_json</code></a>.</li>

</ul>

</li>

<li>
<p>When the user wants to sign in to your application, direct them through
a web-based OAuth flow using <a href="rust-docs/fxa_client/struct.FirefoxAccount.html#method.begin_oauth_flow" title="method fxa_client::FirefoxAccount::begin_oauth_flow"><code>begin_oauth_flow</code></a>
or <a href="rust-docs/fxa_client/struct.FirefoxAccount.html#method.begin_pairing_flow" title="method fxa_client::FirefoxAccount::begin_pairing_flow"><code>begin_pairing_flow</code></a>; when they return
to your registered <code>redirect_uri</code>, pass the resulting authorization state back to
<a href="rust-docs/fxa_client/struct.FirefoxAccount.html#method.complete_oauth_flow" title="method fxa_client::FirefoxAccount::complete_oauth_flow"><code>complete_oauth_flow</code></a> to sign them in.</p>

</li>

<li>
<p>Display information about the signed-in user by using the data from
<a href="rust-docs/fxa_client/struct.FirefoxAccount.html#method.get_profile" title="method fxa_client::FirefoxAccount::get_profile"><code>get_profile</code></a>.</p>

</li>

<li>
<p>Access account-related services on behalf of the user by obtaining OAuth
access tokens via <a href="rust-docs/fxa_client/struct.FirefoxAccount.html#method.get_access_token" title="method fxa_client::FirefoxAccount::get_access_token"><code>get_access_token</code></a>.</p>

</li>

<li>
<p>If the user opts to sign out of the application, calling <a href="rust-docs/fxa_client/struct.FirefoxAccount.html#method.disconnect" title="method fxa_client::FirefoxAccount::disconnect"><code>disconnect</code></a>
and then discarding any persisted account data.</p>

</li>

</ul>

</div>
</details>
<h2 id="macros-1" class="section-header">Macros<a href="#macros-1" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="macro" href="rust-docs/fxa_client/macro.debug.html" title="macro fxa_client::debug">debug</a></dt>
<dt><a class="macro" href="rust-docs/fxa_client/macro.error.html" title="macro fxa_client::error">error</a></dt>
<dt><a class="macro" href="rust-docs/fxa_client/macro.info.html" title="macro fxa_client::info">info</a></dt>
<dt><a class="macro" href="rust-docs/fxa_client/macro.trace.html" title="macro fxa_client::trace">trace</a></dt>
<dt><a class="macro" href="rust-docs/fxa_client/macro.warn.html" title="macro fxa_client::warn">warn</a></dt>
</dl>
<h2 id="structs-1" class="section-header">Structs<a href="#structs-1" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/fxa_client/struct.AccessTokenInfo.html" title="struct fxa_client::AccessTokenInfo">Access<wbr>Token<wbr>Info</a></dt>
<dd>An OAuth access token, with its associated keys and metadata.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.AttachedClient.html" title="struct fxa_client::AttachedClient">Attached<wbr>Client</a></dt>
<dd>A client connected to the user’s account.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.AuthorizationInfo.html" title="struct fxa_client::AuthorizationInfo">Authorization<wbr>Info</a></dt>
<dd>Information about the authorization state of the application.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.AuthorizationParameters.html" title="struct fxa_client::AuthorizationParameters">Authorization<wbr>Parameters</a></dt>
<dd>Parameters provided in an incoming OAuth request.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.CloseTabsPayload.html" title="struct fxa_client::CloseTabsPayload">Close<wbr>Tabs<wbr>Payload</a></dt>
<dd>The payload sent when invoking a “close tabs” command.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.Device.html" title="struct fxa_client::Device">Device</a></dt>
<dd>A device connected to the user’s account.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.DeviceConfig.html" title="struct fxa_client::DeviceConfig">Device<wbr>Config</a></dt>
<dd>Device configuration</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.DevicePushSubscription.html" title="struct fxa_client::DevicePushSubscription">Device<wbr>Push<wbr>Subscription</a></dt>
<dd>Details of a web-push subscription endpoint.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.FirefoxAccount.html" title="struct fxa_client::FirefoxAccount">Firefox<wbr>Account</a></dt>
<dd>Object representing the signed-in state of an application.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.FxaConfig.html" title="struct fxa_client::FxaConfig">FxaConfig</a></dt>
<dt><a class="struct" href="rust-docs/fxa_client/struct.LocalDevice.html" title="struct fxa_client::LocalDevice">Local<wbr>Device</a></dt>
<dd>Local device that’s connecting to FxA</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.Profile.html" title="struct fxa_client::Profile">Profile</a></dt>
<dd>Information about the user that controls a Firefox Account.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.ScopedKey.html" title="struct fxa_client::ScopedKey">Scoped<wbr>Key</a></dt>
<dd>A cryptographic key associated with an OAuth scope.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.SendTabPayload.html" title="struct fxa_client::SendTabPayload">Send<wbr>TabPayload</a></dt>
<dd>The payload sent when invoking a “send tab” command.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.TabHistoryEntry.html" title="struct fxa_client::TabHistoryEntry">TabHistory<wbr>Entry</a></dt>
<dd>An individual entry in the navigation history of a sent tab.</dd>
<dt><a class="struct" href="rust-docs/fxa_client/struct.UserData.html" title="struct fxa_client::UserData">User<wbr>Data</a></dt>
<dd>User data provided by the web content, meant to be consumed by user agents</dd>
</dl>
<h2 id="enums-2" class="section-header">Enums<a href="#enums-2" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/fxa_client/enum.AccountEvent.html" title="enum fxa_client::AccountEvent">Account<wbr>Event</a></dt>
<dd>An event that happened on the user’s account.</dd>
<dt><a class="enum" href="rust-docs/fxa_client/enum.CloseTabsResult.html" title="enum fxa_client::CloseTabsResult">Close<wbr>Tabs<wbr>Result</a></dt>
<dt><a class="enum" href="rust-docs/fxa_client/enum.DeviceCapability.html" title="enum fxa_client::DeviceCapability">Device<wbr>Capability</a></dt>
<dd>A “capability” offered by a device.</dd>
<dt><a class="enum" href="rust-docs/fxa_client/enum.DeviceType.html" title="enum fxa_client::DeviceType">Device<wbr>Type</a></dt>
<dd>Enumeration for the different types of device.</dd>
<dt><a class="enum" href="rust-docs/fxa_client/enum.Error.html" title="enum fxa_client::Error">Error</a></dt>
<dd>FxA internal error type
These are used in the internal code. This error type is never returned to the consumer.</dd>
<dt><a class="enum" href="rust-docs/fxa_client/enum.FxaError.html" title="enum fxa_client::FxaError">FxaError</a></dt>
<dd>Public error type thrown by many [<code>FirefoxAccount</code>] operations.</dd>
<dt><a class="enum" href="rust-docs/fxa_client/enum.FxaEvent.html" title="enum fxa_client::FxaEvent">FxaEvent</a></dt>
<dd>Fxa event</dd>
<dt><a class="enum" href="rust-docs/fxa_client/enum.FxaRustAuthState.html" title="enum fxa_client::FxaRustAuthState">FxaRust<wbr>Auth<wbr>State</a></dt>
<dd>High-level view of the authorization state</dd>
<dt><a class="enum" href="rust-docs/fxa_client/enum.FxaServer.html" title="enum fxa_client::FxaServer">FxaServer</a></dt>
<dt><a class="enum" href="rust-docs/fxa_client/enum.FxaState.html" title="enum fxa_client::FxaState">FxaState</a></dt>
<dd>Fxa state</dd>
<dt><a class="enum" href="rust-docs/fxa_client/enum.IncomingDeviceCommand.html" title="enum fxa_client::IncomingDeviceCommand">Incoming<wbr>Device<wbr>Command</a></dt>
<dd>A command invoked by another device.</dd>
</dl>
<h2 id="types" class="section-header">Type Aliases<a href="#types" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="type" href="rust-docs/fxa_client/type.ApiResult.html" title="type fxa_client::ApiResult">ApiResult</a></dt>
<dd>Result returned by public-facing API functions</dd>
<dt><a class="type" href="rust-docs/fxa_client/type.Result.html" title="type fxa_client::Result">Result</a></dt>
<dd>Result returned by internal functions</dd>
</dl>
</section></div>
</main></body></html>
<footer id="open-on-gh-42">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/fxa_client/index.html">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="logins"><a href="#logins" class="header">logins</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `logins` crate."><title>logins - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="logins" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate logins</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#logins">logins</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-4" href="rust-docs/logins/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-4">
<h3><a href="#reexports-1">Crate Items</a></h3>
<ul class="block">
<li><a href="#reexports-1" title="Re-exports">Re-exports</a></li>
<li><a href="#modules-1" title="Modules">Modules</a></li>
<li><a href="#macros-2" title="Macros">Macros</a></li>
<li><a href="#structs-2" title="Structs">Structs</a></li>
<li><a href="#enums-3" title="Enums">Enums</a></li>
<li><a href="#traits" title="Traits">Traits</a></li>
<li><a href="#functions-1" title="Functions">Functions</a></li>
<li><a href="#types-1" title="Type Aliases">Type Aliases</a></li>
<li><a href="#attributes" title="Attribute Macros">Attribute Macros</a></li>
</ul>
</section>
<div id="rustdoc-modnav-4"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-4" class="content">
<div class="main-heading">
<h1>Crate <span>logins</span> <button id="copy-path-4" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/logins/lib.rs.html#5-75">Source</a> </span></div>
<h2 id="reexports-1" class="section-header">Re-exports<a href="#reexports-1" class="anchor">§</a></h2>
<dl class="item-table reexports">
<dt id="reexport.NSSKeyManager"><code>pub use crate::encryption::<a class="struct" href="rust-docs/logins/encryption/struct.NSSKeyManager.html" title="struct logins::encryption::NSSKeyManager">NSSKeyManager</a>;</code></dt>
<dt id="reexport.PrimaryPasswordAuthenticator"><code>pub use crate::encryption::<a class="trait" href="rust-docs/logins/encryption/trait.PrimaryPasswordAuthenticator.html" title="trait logins::encryption::PrimaryPasswordAuthenticator">PrimaryPasswordAuthenticator</a>;</code></dt>
</dl>
<h2 id="modules-1" class="section-header">Modules<a href="#modules-1" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/logins/encryption/index.html" title="mod logins::encryption">encryption</a></dt>
</dl>
<h2 id="macros-2" class="section-header">Macros<a href="#macros-2" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="macro" href="rust-docs/logins/macro.breadcrumb.html" title="macro logins::breadcrumb">breadcrumb</a></dt>
<dd>Tell the application to log a breadcrumb</dd>
<dt><a class="macro" href="rust-docs/logins/macro.debug.html" title="macro logins::debug">debug</a></dt>
<dt><a class="macro" href="rust-docs/logins/macro.error.html" title="macro logins::error">error</a></dt>
<dt><a class="macro" href="rust-docs/logins/macro.info.html" title="macro logins::info">info</a></dt>
<dt><a class="macro" href="rust-docs/logins/macro.report_error.html" title="macro logins::report_error">report_<wbr>error</a></dt>
<dd>Tell the application to report an error</dd>
<dt><a class="macro" href="rust-docs/logins/macro.trace.html" title="macro logins::trace">trace</a></dt>
<dt><a class="macro" href="rust-docs/logins/macro.warn.html" title="macro logins::warn">warn</a></dt>
</dl>
<h2 id="structs-2" class="section-header">Structs<a href="#structs-2" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/logins/struct.EncryptedLogin.html" title="struct logins::EncryptedLogin">Encrypted<wbr>Login</a></dt>
<dd>A login stored in the database</dd>
<dt><a class="struct" href="rust-docs/logins/struct.Login.html" title="struct logins::Login">Login</a></dt>
<dd>A login handed over from the store API, which has been persisted and contains persistence
<p>information such as id and time stamps
<dt><a class="struct" href="rust-docs/logins/struct.LoginDb.html" title="struct logins::LoginDb">LoginDb</a></dt>
<dt><a class="struct" href="rust-docs/logins/struct.LoginEntry.html" title="struct logins::LoginEntry">Login<wbr>Entry</a></dt>
<dd>A login handed over to the store API; ie a login not yet persisted</dd>
<dt><a class="struct" href="rust-docs/logins/struct.LoginEntryWithMeta.html" title="struct logins::LoginEntryWithMeta">Login<wbr>Entry<wbr>With<wbr>Meta</a></dt>
<dd>A login together with meta fields, handed over to the store API; ie a login persisted
elsewhere, useful for migrations</dd>
<dt><a class="struct" href="rust-docs/logins/struct.LoginFields.html" title="struct logins::LoginFields">Login<wbr>Fields</a></dt>
<dt><a class="struct" href="rust-docs/logins/struct.LoginMeta.html" title="struct logins::LoginMeta">Login<wbr>Meta</a></dt>
<dd>Login data specific to database records</dd>
<dt><a class="struct" href="rust-docs/logins/struct.LoginStore.html" title="struct logins::LoginStore">Login<wbr>Store</a></dt>
<dt><a class="struct" href="rust-docs/logins/struct.LoginsDeletionMetrics.html" title="struct logins::LoginsDeletionMetrics">Logins<wbr>Deletion<wbr>Metrics</a></dt>
<dt><a class="struct" href="rust-docs/logins/struct.LoginsSyncEngine.html" title="struct logins::LoginsSyncEngine">Logins<wbr>Sync<wbr>Engine</a></dt>
<dt><a class="struct" href="rust-docs/logins/struct.SecureLoginFields.html" title="struct logins::SecureLoginFields">Secure<wbr>Login<wbr>Fields</a></dt>
<dd>LoginEntry fields that are stored encrypted</dd>
<dt><a class="struct" href="rust-docs/logins/struct.UniFfiTraitVtableEncryptorDecryptor.html" title="struct logins::UniFfiTraitVtableEncryptorDecryptor">UniFfi<wbr>Trait<wbr>Vtable<wbr>Encryptor<wbr>Decryptor</a></dt>
<dt><a class="struct" href="rust-docs/logins/struct.UniFfiTraitVtableKeyManager.html" title="struct logins::UniFfiTraitVtableKeyManager">UniFfi<wbr>Trait<wbr>Vtable<wbr>KeyManager</a></dt>
<h2 id="enums-3" class="section-header">Enums<a href="#enums-3" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/logins/enum.BulkResultEntry.html" title="enum logins::BulkResultEntry">Bulk<wbr>Result<wbr>Entry</a></dt>
<dd>A bulk insert result entry, returned by <code>add_many</code> and <code>add_many_with_records</code>
Please note that although the success case is much larger than the error case, this is
negligible in real life, as we expect a very small success/error ratio.</dd>
<dt><a class="enum" href="rust-docs/logins/enum.Error.html" title="enum logins::Error">Error</a></dt>
<dd>Logins error type
These are “internal” errors used by the implementation. This error type
is never returned to the consumer.</dd>
<dt><a class="enum" href="rust-docs/logins/enum.InvalidLogin.html" title="enum logins::InvalidLogin">Invalid<wbr>Login</a></dt>
<dd>Error::InvalidLogin subtypes</dd>
<dt><a class="enum" href="rust-docs/logins/enum.LoginOrErrorMessage.html" title="enum logins::LoginOrErrorMessage">Login<wbr>OrError<wbr>Message</a></dt>
<dt><a class="enum" href="rust-docs/logins/enum.LoginsApiError.html" title="enum logins::LoginsApiError">Logins<wbr>ApiError</a></dt>
</dl>
<h2 id="traits" class="section-header">Traits<a href="#traits" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="trait" href="rust-docs/logins/trait.ValidateAndFixup.html" title="trait logins::ValidateAndFixup">Validate<wbr>AndFixup</a></dt>
</dl>
<h2 id="functions-1" class="section-header">Functions<a href="#functions-1" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="fn" href="rust-docs/logins/fn.create_login_store_with_nss_keymanager.html" title="fn logins::create_login_store_with_nss_keymanager">create_<wbr>login_<wbr>store_<wbr>with_<wbr>nss_<wbr>keymanager</a></dt>
<dt><a class="fn" href="rust-docs/logins/fn.create_login_store_with_static_key_manager.html" title="fn logins::create_login_store_with_static_key_manager">create_<wbr>login_<wbr>store_<wbr>with_<wbr>static_<wbr>key_<wbr>manager</a></dt>
<dt><a class="fn" href="rust-docs/logins/fn.create_managed_encdec.html" title="fn logins::create_managed_encdec">create_<wbr>managed_<wbr>encdec</a></dt>
<dt><a class="fn" href="rust-docs/logins/fn.create_static_key_manager.html" title="fn logins::create_static_key_manager">create_<wbr>static_<wbr>key_<wbr>manager</a></dt>
<dt><a class="fn" href="rust-docs/logins/fn.get_registered_sync_engine.html" title="fn logins::get_registered_sync_engine">get_<wbr>registered_<wbr>sync_<wbr>engine</a></dt>
<dd>Called by the sync manager to get a sync engine via the store previously
registered with the sync manager.</dd>
<dt><a class="fn" href="rust-docs/logins/fn.uniffi_logins_fn_init_callback_vtable_encryptordecryptor.html" title="fn logins::uniffi_logins_fn_init_callback_vtable_encryptordecryptor">uniffi_<wbr>logins_<wbr>fn_<wbr>init_<wbr>callback_<wbr>vtable_<wbr>encryptordecryptor</a></dt>
<dt><a class="fn" href="rust-docs/logins/fn.uniffi_logins_fn_init_callback_vtable_keymanager.html" title="fn logins::uniffi_logins_fn_init_callback_vtable_keymanager">uniffi_<wbr>logins_<wbr>fn_<wbr>init_<wbr>callback_<wbr>vtable_<wbr>keymanager</a></dt>
</dl>
<h2 id="types-1" class="section-header">Type Aliases<a href="#types-1" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="type" href="rust-docs/logins/type.ApiResult.html" title="type logins::ApiResult">ApiResult</a></dt>
<dt><a class="type" href="rust-docs/logins/type.Result.html" title="type logins::Result">Result</a></dt>
</dl>
<h2 id="attributes" class="section-header">Attribute Macros<a href="#attributes" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="attr" href="rust-docs/logins/attr.handle_error.html" title="attr logins::handle_error">handle_<wbr>error</a></dt>
<dd>A procedural macro that exposes internal errors to external errors the
consuming applications should handle. It requires that the internal error
implements [<code>error_support::ErrorHandling</code>].</dd>
</dl>
</p>
<footer id="open-on-gh-43">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/logins/index.html">Edit this page on GitHub.</a></footer></dd>
</dl>
</section></div>
</main></body></html><div style="break-before: page; page-break-before: always;"></div>
<h1 id="nimbus"><a href="#nimbus" class="header">nimbus</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `nimbus` crate."><title>nimbus - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="nimbus" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate nimbus</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#nimbus">nimbus</a><span class="version">0.10.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-5" href="rust-docs/nimbus/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-5">
<h3><a href="#reexports-2">Crate Items</a></h3>
<ul class="block">
<li><a href="#reexports-2" title="Re-exports">Re-exports</a></li>
<li><a href="#modules-2" title="Modules">Modules</a></li>
<li><a href="#structs-3" title="Structs">Structs</a></li>
<li><a href="#enums-4" title="Enums">Enums</a></li>
<li><a href="#functions-2" title="Functions">Functions</a></li>
</ul>
</section>
<div id="rustdoc-modnav-5"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-5" class="content">
<div class="main-heading">
<h1>Crate <span>nimbus</span> <button id="copy-path-5" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/nimbus/lib.rs.html#5-47">Source</a> </span></div>
<h2 id="reexports-2" class="section-header">Re-exports<a href="#reexports-2" class="anchor">§</a></h2>
<dl class="item-table reexports">
<dt id="reexport.NimbusError"><code>pub use crate::error::<a class="enum" href="rust-docs/nimbus/error/enum.NimbusError.html" title="enum nimbus::error::NimbusError">NimbusError</a>;</code></dt>
<dt id="reexport.Result-1"><code>pub use crate::error::<a class="type" href="rust-docs/nimbus/error/type.Result.html" title="type nimbus::error::Result">Result</a>;</code></dt>
<dt id="reexport.AppContext"><code>pub use crate::stateful::matcher::<a class="struct" href="rust-docs/nimbus/stateful/matcher/struct.AppContext.html" title="struct nimbus::stateful::matcher::AppContext">AppContext</a>;</code></dt>
<dt id="reexport.TargetingAttributes"><code>pub use evaluator::<a class="struct" href="rust-docs/nimbus/stateful/evaluator/struct.TargetingAttributes.html" title="struct nimbus::stateful::evaluator::TargetingAttributes">TargetingAttributes</a>;</code></dt>
<dt><code>pub use crate::<a class="mod" href="rust-docs/nimbus/schema/index.html" title="mod nimbus::schema">schema</a>::*;</code></dt>
<dt><code>pub use crate::stateful::<a class="mod" href="rust-docs/nimbus/stateful/nimbus_client/index.html" title="mod nimbus::stateful::nimbus_client">nimbus_client</a>::*;</code></dt>
</dl>
<h2 id="modules-2" class="section-header">Modules<a href="#modules-2" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/nimbus/error/index.html" title="mod nimbus::error">error</a></dt>
<dd>Not complete yet
<p>This is where the error definitions can go
TODO: Implement proper error handling, this would include defining the error enum,
impl std::error::Error using <code>thiserror</code> and ensuring all errors are handled appropriately
<dt><a class="mod" href="rust-docs/nimbus/metrics/index.html" title="mod nimbus::metrics">metrics</a></dt>
<dt><a class="mod" href="rust-docs/nimbus/schema/index.html" title="mod nimbus::schema">schema</a></dt>
<dt><a class="mod" href="rust-docs/nimbus/stateful/index.html" title="mod nimbus::stateful">stateful</a></dt>
<h2 id="structs-3" class="section-header">Structs<a href="#structs-3" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/nimbus/struct.EnrolledFeature.html" title="struct nimbus::EnrolledFeature">Enrolled<wbr>Feature</a></dt>
<dt><a class="struct" href="rust-docs/nimbus/struct.NimbusTargetingHelper.html" title="struct nimbus::NimbusTargetingHelper">Nimbus<wbr>Targeting<wbr>Helper</a></dt>
<dt><a class="struct" href="rust-docs/nimbus/struct.RemoteSettingsConfig.html" title="struct nimbus::RemoteSettingsConfig">Remote<wbr>Settings<wbr>Config</a></dt>
<dd>Custom configuration for the client.
Currently includes the following:</dd>
</dl>
<h2 id="enums-4" class="section-header">Enums<a href="#enums-4" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/nimbus/enum.EnrollmentStatus.html" title="enum nimbus::EnrollmentStatus">Enrollment<wbr>Status</a></dt>
<dt><a class="enum" href="rust-docs/nimbus/enum.RemoteSettingsServer.html" title="enum nimbus::RemoteSettingsServer">Remote<wbr>Settings<wbr>Server</a></dt>
<dd>The Remote Settings server that the client should use.</dd>
</dl>
<h2 id="functions-2" class="section-header">Functions<a href="#functions-2" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="fn" href="rust-docs/nimbus/fn.evaluate_enrollment.html" title="fn nimbus::evaluate_enrollment">evaluate_<wbr>enrollment</a></dt>
<dd>Determine the enrolment status for an experiment.</dd>
</dl>
</p>
<footer id="open-on-gh-44">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/nimbus/index.html">Edit this page on GitHub.</a></footer></dd>
</dl>
</section></div>
</main></body></html><div style="break-before: page; page-break-before: always;"></div>
<h1 id="places"><a href="#places" class="header">places</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `places` crate."><title>places - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="places" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate places</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#places">places</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-6" href="rust-docs/places/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-6">
<h3><a href="#reexports-3">Crate Items</a></h3>
<ul class="block">
<li><a href="#reexports-3" title="Re-exports">Re-exports</a></li>
<li><a href="#modules-3" title="Modules">Modules</a></li>
</ul>
</section>
<div id="rustdoc-modnav-6"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-6" class="content">
<div class="main-heading">
<h1>Crate <span>places</span> <button id="copy-path-6" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/places/lib.rs.html#5-41">Source</a> </span></div>
<h2 id="reexports-3" class="section-header">Re-exports<a href="#reexports-3" class="anchor">§</a></h2>
<dl class="item-table reexports">
<dt id="reexport.apply_observation"><code>pub use crate::api::<a class="fn" href="rust-docs/places/api/fn.apply_observation.html" title="fn places::api::apply_observation">apply_observation</a>;</code></dt>
<dt id="reexport.get_registered_sync_engine-1"><code>pub use crate::api::places_api::<a class="fn" href="rust-docs/places/api/places_api/fn.get_registered_sync_engine.html" title="fn places::api::places_api::get_registered_sync_engine">get_registered_sync_engine</a>;</code></dt>
<dt id="reexport.ConnectionType"><code>pub use crate::api::places_api::<a class="enum" href="rust-docs/places/api/places_api/enum.ConnectionType.html" title="enum places::api::places_api::ConnectionType">ConnectionType</a>;</code></dt>
<dt id="reexport.PlacesApi"><code>pub use crate::api::places_api::<a class="struct" href="rust-docs/places/api/places_api/struct.PlacesApi.html" title="struct places::api::places_api::PlacesApi">PlacesApi</a>;</code></dt>
<dt id="reexport.PlacesDb"><code>pub use crate::db::<a class="struct" href="rust-docs/places/db/db/struct.PlacesDb.html" title="struct places::db::db::PlacesDb">PlacesDb</a>;</code></dt>
<dt id="reexport.PageInfo"><code>pub use crate::storage::<a class="struct" href="rust-docs/places/storage/struct.PageInfo.html" title="struct places::storage::PageInfo">PageInfo</a>;</code></dt>
<dt id="reexport.RowId"><code>pub use crate::storage::<a class="struct" href="rust-docs/places/storage/struct.RowId.html" title="struct places::storage::RowId">RowId</a>;</code></dt>
<dt><code>pub use crate::<a class="mod" href="rust-docs/places/error/index.html" title="mod places::error">error</a>::*;</code></dt>
<dt><code>pub use crate::<a class="mod" href="rust-docs/places/observation/index.html" title="mod places::observation">observation</a>::*;</code></dt>
<dt><code>pub use crate::<a class="mod" href="rust-docs/places/types/index.html" title="mod places::types">types</a>::*;</code></dt>
<dt><code>pub use <a class="mod" href="rust-docs/places/ffi/index.html" title="mod places::ffi">ffi</a>::*;</code></dt>
</dl>
<h2 id="modules-3" class="section-header">Modules<a href="#modules-3" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/places/api/index.html" title="mod places::api">api</a></dt>
<dt><a class="mod" href="rust-docs/places/bookmark_sync/index.html" title="mod places::bookmark_sync">bookmark_<wbr>sync</a></dt>
<dt><a class="mod" href="rust-docs/places/db/index.html" title="mod places::db">db</a></dt>
<dt><a class="mod" href="rust-docs/places/error/index.html" title="mod places::error">error</a></dt>
<dt><a class="mod" href="rust-docs/places/ffi/index.html" title="mod places::ffi">ffi</a></dt>
<dt><a class="mod" href="rust-docs/places/frecency/index.html" title="mod places::frecency">frecency</a></dt>
<dt><a class="mod" href="rust-docs/places/hash/index.html" title="mod places::hash">hash</a></dt>
<dt><a class="mod" href="rust-docs/places/history_sync/index.html" title="mod places::history_sync">history_<wbr>sync</a></dt>
<dt><a class="mod" href="rust-docs/places/import/index.html" title="mod places::import">import</a></dt>
<dt><a class="mod" href="rust-docs/places/match_impl/index.html" title="mod places::match_impl">match_<wbr>impl</a></dt>
<dt><a class="mod" href="rust-docs/places/observation/index.html" title="mod places::observation">observation</a></dt>
<dt><a class="mod" href="rust-docs/places/storage/index.html" title="mod places::storage">storage</a></dt>
<dt><a class="mod" href="rust-docs/places/types/index.html" title="mod places::types">types</a></dt>
</dl>
</section></div>
</main></body></html>
<footer id="open-on-gh-45">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/places/index.html">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="push"><a href="#push" class="header">push</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Rust Push Component"><title>push - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="push" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate push</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#push">push</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-7" href="rust-docs/push/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-7">
<h3><a href="#">Sections</a></h3>
<ul class="block top-toc">
<li><a href="#rust-push-component" title="Rust Push Component">Rust Push Component</a>
<ul>
<li><a href="#background-concepts" title="Background Concepts">Background Concepts</a></li>
<li><a href="#api" title="API">API</a></li>
<li><a href="#initialization" title="Initialization">Initialization</a></li>
<li><a href="#new-subscription" title="New subscription">New subscription</a></li>
<li><a href="#end-a-subscription" title="End a subscription">End a subscription</a></li>
<li><a href="#decrypt-an-incoming-subscription-message" title="Decrypt an incoming subscription message">Decrypt an incoming subscription message</a></li>
</ul>
</li>
</ul>
<h3><a href="#macros-3">Crate Items</a></h3>
<ul class="block">
<li><a href="#macros-3" title="Macros">Macros</a></li>
<li><a href="#structs-4" title="Structs">Structs</a></li>
<li><a href="#enums-5" title="Enums">Enums</a></li>
<li><a href="#types-2" title="Type Aliases">Type Aliases</a></li>
</ul>
</section>
<div id="rustdoc-modnav-7"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-7" class="content">
<div class="main-heading">
<h1>Crate <span>push</span> <button id="copy-path-7" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/push/lib.rs.html#5-413">Source</a> </span></div>
<details class="toggle top-doc" open=""><summary class="hideme"><span>Expand description</span></summary>
<div class="docblock">
<h2 id="rust-push-component"><a class="doc-anchor" href="#rust-push-component">§</a>Rust Push Component</h2>

<p>This component helps an application to manage <a href="https://developer.mozilla.org/en-US/docs/Web/API/Push_API">WebPush</a> subscriptions,
acting as an intermediary between Mozilla’s <a href="https://autopush.readthedocs.io/en/latest/">autopush service</a>
and platform native push infrastructure such as <a href="https://firebase.google.com/docs/cloud-messaging">Firebase Cloud Messaging</a> or <a href="https://developer.amazon.com/docs/adm/overview.html">Amazon Device Messaging</a>.</p>

<h3 id="background-concepts"><a class="doc-anchor" href="#background-concepts">§</a>Background Concepts</h3>
<h4 id="webpush-subscriptions"><a class="doc-anchor" href="#webpush-subscriptions">§</a>WebPush Subscriptions</h4>

<p>A WebPush client manages a number of <em>subscriptions</em>, each of which is used to deliver push
notifications to a different part of the app. For example, a web browser might manage a separate
subscription for each website that has registered a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">service worker</a>, and an application that includes Firefox Accounts would manage
a dedicated subscription on which to receive account state updates.</p>

<p>Each subscription is identified by a unique <em>channel id</em>, which is a randomly-generated identifier.
It’s the responsibility of the application to know how to map a channel id to an appropriate function
in the app to receive push notifications. Subscriptions also have an associated <em>scope</em> which is something
to do which service workers that your humble author doesn’t really understand :-/.</p>

<p>When a subscription is created for a channel id, we allocate <em>subscription info</em> consisting of:</p>

<ul>
<li>An HTTP endpoint URL at which push messages can be submitted.</li>

<li>A cryptographic key and authentication secret with which push messages can be encrypted.</li>

</ul>

<p>This subscription info is distributed to other services that want to send push messages to
the application.</p>

<p>The HTTP endpoint is provided by Mozilla’s <a href="https://autopush.readthedocs.io/en/latest/">autopush service</a>,
and we use the <a href="https://github.com/mozilla/rust-ece">rust-ece</a> to manage encryption with the cryptographic keys.</p>

<p>Here’s a helpful diagram of how the <em>subscription</em> flow works at a high level across the moving parts:
<img src="https://mozilla.github.io/application-services/book/diagrams/Push-Component-Subscription-flow.png" alt="A Sequence diagram showing how the different parts of push interact" title="Sequence diagram" /></p>

<h4 id="autopush-bridging"><a class="doc-anchor" href="#autopush-bridging">§</a>AutoPush Bridging</h4>

<p>Our target consumer platforms each have their own proprietary push-notification infrastructure,
such as <a href="https://firebase.google.com/docs/cloud-messaging">Firebase Cloud Messaging</a> for Android
and the <a href="https://developer.apple.com/notifications/">Apple Push Notification Service</a> for iOS.
Mozilla’s <a href="https://autopush.readthedocs.io/en/latest/">autopush service</a> provides a bridge between
these different mechanisms and the WebPush standard so that they can be used with a consistent
interface.</p>

<p>This component acts a client of the <a href="https://autopush.readthedocs.io/en/latest/http.html#push-service-bridge-http-interface">Push Service Bridge HTTP Interface</a>.</p>

<p>We assume two things about the consuming application:</p>

<ul>
<li>It has registered with the autopush service and received a unique <code>app_id</code> identifying this registration.</li>

<li>It has registered with whatever platform-specific notification infrastructure is appropriate, and is
able to obtain a <code>token</code> corresponding to its native push notification state.</li>

</ul>

<p>On first use, this component will register itself as an <em>application instance</em> with the autopush service, providing the <code>app_id</code> and <code>token</code> and receiving a unique <code>uaid</code> (“user-agent id”) to identify its
connection to the server.</p>

<p>As the application adds or removes subscriptions using the API of this component, it will:</p>

<ul>
<li>Manage a local database of subscriptions and the corresponding cryptographic material.</li>

<li>Make corresponding HTTP API calls to update the state associated with its <code>uaid</code> on the autopush server.</li>

</ul>

<p>Periodically, the application should call a special <code>verify_connection</code> method to check whether
the state on the autopush server matches the local state and take any corrective action if it
differs.</p>

<p>For local development and debugging, it is possible to run a local instance of the autopush
bridge service; see <a href="https://docs.google.com/document/d/18L_g2hIj_1mncF978A_SHXN4udDQLut5P_ZHYZEwGP8">this google doc</a> for details.</p>

<h3 id="api"><a class="doc-anchor" href="#api">§</a>API</h3>
<h3 id="initialization"><a class="doc-anchor" href="#initialization">§</a>Initialization</h3>

<p>Calls are handled by the <code>PushManager</code>, which provides a handle for future calls.</p>

<p>example:</p>

<div class="example-wrap">
<pre class="language-kotlin"><code>
import mozilla.appservices.push.(PushManager, BridgeTypes)
<p>// The following are mock calls for fetching application level configuration options.
// "SenderID" is the native OS push message application identifier. See Native
// messaging documentation for details.
val sender_id = SystemConfigurationOptions.get("SenderID")</p>
<p>// The "bridge type" is the identifier for the native OS push message system.
// (e.g. FCM for Google Firebase Cloud Messaging, ADM for Amazon Direct Messaging,
// etc.)
val bridge_type = BridgeTypes.FCM</p>
<p>// The "registration_id" is the native OS push message user registration number.
// Native push message registration usually happens at application start, and returns
// an opaque user identifier string. See Native messaging documentation for details.
val registration_id = NativeMessagingSystem.register(sender_id)</p>
<p>val push_manager = PushManager(
sender_id,
bridge_type,
registration_id
)</p>
<p>// It is strongly encouraged that the connection is verified at least once a day.
// This will ensure that the server and UA have matching information regarding
// subscriptions. This call usually returns quickly, but may take longer if the
// UA has a large number of subscriptions and things have fallen out of sync.</p>
<p>for change in push_manager.verify_connection() {
// fetch the subscriber from storage using the change[0] and
// notify them with a <code>pushsubscriptionchange</code> message containing the new
// endpoint change[1]
}
<h3 id="new-subscription"><a class="doc-anchor" href="#new-subscription">§</a>New subscription</h3>
</p>
<p>Before messages can be delivered, a new subscription must be requested. The subscription info block contains all the information a remote subscription provider service will need to encrypt and transmit a message to this user agent.</p>

<p>example:</p>

<div class="example-wrap">
<pre class="language-kotlin"><code>
// Each new request must have a unique "channel" identifier. This channel helps
// later identify recipients and aid in routing. A ChannelID is a UUID4 value.
// the "scope" is the ServiceWorkerRegistration scope. This will be used
// later for push notification management.
val channelID = GUID.randomUUID()
<p>val subscription_info = push_manager.subscribe(channelID, endpoint_scope)</p>
<p>// the published subscription info has the following JSON format:
// {"endpoint": subscription_info.endpoint,
//  "keys": {
//      "auth": subscription_info.keys.auth,
//      "p256dh": subscription_info.keys.p256dh
//  }}
<h3 id="end-a-subscription"><a class="doc-anchor" href="#end-a-subscription">§</a>End a subscription</h3>
</p>
<p>A user may decide to no longer receive a given subscription. To remove a given subscription, pass the associated channelID</p>

<div class="example-wrap">
<pre class="language-kotlin"><code>push_manager.unsubscribe(channelID)  // Terminate a single subscription</code></pre>
</div>

<p>If the user wishes to terminate all subscriptions, send and empty string for channelID</p>

<div class="example-wrap">
<pre class="language-kotlin"><code>push_manager.unsubscribe("")        // Terminate all subscriptions for a user</code></pre>
</div>

<p>If this function returns <code>false</code> the subsequent <code>verify_connection</code> may result in new channel endpoints.</p>

<h3 id="decrypt-an-incoming-subscription-message"><a class="doc-anchor" href="#decrypt-an-incoming-subscription-message">§</a>Decrypt an incoming subscription message</h3>

<p>An incoming subscription body will contain a number of metadata elements along with the body of the message. Due to platform differences, how that metadata is provided may //! vary, however the most common form is that the messages “payload” looks like.</p>

<div class="example-wrap">
<pre class="language-javascript"><code>{"chid": "...",         // ChannelID
 "con": "...",          // Encoding form
 "enc": "...",          // Optional encryption header
 "crypto-key": "...",   // Optional crypto key header
 "body": "...",         // Encrypted message body
}</code></pre>
</div>

<p>These fields may be included as a sub-hash, or may be intermingled with other data fields. If you have doubts or concerns, please contact the Application Services team guidance</p>

<p>Based on the above payload, an example call might look like:</p>

<div class="example-wrap">
<pre class="language-kotlin"><code>    val result = manager.decrypt(
        channelID = payload["chid"].toString(),
        body = payload["body"].toString(),
        encoding = payload["con"].toString(),
        salt = payload.getOrElse("enc", "").toString(),
        dh = payload.getOrElse("dh", "").toString()
    )
    // result returns a byte array. You may need to convert to a string
    return result.toString(Charset.forName("UTF-8"))</code></pre>
</div>
<h2 id="macros-3" class="section-header">Macros<a href="#macros-3" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="macro" href="rust-docs/push/macro.debug.html" title="macro push::debug">debug</a></dt>
</dl>
<h2 id="structs-4" class="section-header">Structs<a href="#structs-4" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/push/struct.KeyInfo.html" title="struct push::KeyInfo">KeyInfo</a></dt>
<dd>Key Information that can be used to encrypt payloads. These are encoded as base64
so will need to be decoded before they can actually be used as keys.</dd>
<dt><a class="struct" href="rust-docs/push/struct.PushConfiguration.html" title="struct push::PushConfiguration">Push<wbr>Configuration</a></dt>
<dt><a class="struct" href="rust-docs/push/struct.PushManager.html" title="struct push::PushManager">Push<wbr>Manager</a></dt>
<dd>Object representing the PushManager used to manage subscriptions</dd>
<dt><a class="struct" href="rust-docs/push/struct.PushSubscriptionChanged.html" title="struct push::PushSubscriptionChanged">Push<wbr>Subscription<wbr>Changed</a></dt>
<dd>An dictionary describing the push subscription that changed, the caller
will receive a list of <a href="rust-docs/push/struct.PushSubscriptionChanged.html" title="struct push::PushSubscriptionChanged"><code>PushSubscriptionChanged</code></a> when calling
<a href="rust-docs/push/struct.PushManager.html#method.verify_connection" title="method push::PushManager::verify_connection"><code>PushManager::verify_connection</code></a>, one entry for each channel that the
caller should resubscribe to</dd>
<dt><a class="struct" href="rust-docs/push/struct.SubscriptionInfo.html" title="struct push::SubscriptionInfo">Subscription<wbr>Info</a></dt>
<dd>Subscription Information, the endpoint to send push messages to and
the key information that can be used to encrypt payloads</dd>
<dt><a class="struct" href="rust-docs/push/struct.SubscriptionResponse.html" title="struct push::SubscriptionResponse">Subscription<wbr>Response</a></dt>
<dd>The subscription response object returned from <a href="rust-docs/push/struct.PushManager.html#method.subscribe" title="method push::PushManager::subscribe"><code>PushManager::subscribe</code></a></dd>
</dl>
<h2 id="enums-5" class="section-header">Enums<a href="#enums-5" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/push/enum.BridgeType.html" title="enum push::BridgeType">Bridge<wbr>Type</a></dt>
<dd>The types of supported native bridges.</dd>
<dt><a class="enum" href="rust-docs/push/enum.PushApiError.html" title="enum push::PushApiError">Push<wbr>ApiError</a></dt>
<dt><a class="enum" href="rust-docs/push/enum.PushError.html" title="enum push::PushError">Push<wbr>Error</a></dt>
<dt><a class="enum" href="rust-docs/push/enum.PushHttpProtocol.html" title="enum push::PushHttpProtocol">Push<wbr>Http<wbr>Protocol</a></dt>
</dl>
<h2 id="types-2" class="section-header">Type Aliases<a href="#types-2" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="type" href="rust-docs/push/type.ApiResult.html" title="type push::ApiResult">ApiResult</a></dt>
</dl>

<footer id="open-on-gh-46">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/push/index.html">Edit this page on GitHub.</a></footer></code></pre>
</div>
</code></pre>
</div>
</div>
</details></section></div>
</main></body></html><div style="break-before: page; page-break-before: always;"></div>
<h1 id="remote_settings"><a href="#remote_settings" class="header">remote_settings</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `remote_settings` crate."><title>remote_settings - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="remote_settings" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate remote_settings</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#remote_settings">remote_<wbr>settings</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-8" href="rust-docs/remote_settings/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-8">
<h3><a href="#reexports-4">Crate Items</a></h3>
<ul class="block">
<li><a href="#reexports-4" title="Re-exports">Re-exports</a></li>
<li><a href="#modules-4" title="Modules">Modules</a></li>
<li><a href="#macros-4" title="Macros">Macros</a></li>
<li><a href="#structs-5" title="Structs">Structs</a></li>
</ul>
</section>
<div id="rustdoc-modnav-8"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-8" class="content">
<div class="main-heading">
<h1>Crate <span>remote_<wbr>settings</span> <button id="copy-path-8" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/remote_settings/lib.rs.html#5-426">Source</a> </span></div>
<h2 id="reexports-4" class="section-header">Re-exports<a href="#reexports-4" class="anchor">§</a></h2>
<dl class="item-table reexports">
<dt id="reexport.Attachment"><code>pub use client::<a class="struct" href="rust-docs/remote_settings/client/struct.Attachment.html" title="struct remote_settings::client::Attachment">Attachment</a>;</code></dt>
<dt id="reexport.RemoteSettingsRecord"><code>pub use client::<a class="struct" href="rust-docs/remote_settings/client/struct.RemoteSettingsRecord.html" title="struct remote_settings::client::RemoteSettingsRecord">RemoteSettingsRecord</a>;</code></dt>
<dt id="reexport.RemoteSettingsResponse"><code>pub use client::<a class="struct" href="rust-docs/remote_settings/client/struct.RemoteSettingsResponse.html" title="struct remote_settings::client::RemoteSettingsResponse">RemoteSettingsResponse</a>;</code></dt>
<dt id="reexport.RsJsonObject"><code>pub use client::<a class="type" href="rust-docs/remote_settings/client/type.RsJsonObject.html" title="type remote_settings::client::RsJsonObject">RsJsonObject</a>;</code></dt>
<dt id="reexport.BaseUrl"><code>pub use config::<a class="struct" href="rust-docs/remote_settings/config/struct.BaseUrl.html" title="struct remote_settings::config::BaseUrl">BaseUrl</a>;</code></dt>
<dt id="reexport.RemoteSettingsConfig"><code>pub use config::<a class="struct" href="rust-docs/remote_settings/config/struct.RemoteSettingsConfig.html" title="struct remote_settings::config::RemoteSettingsConfig">RemoteSettingsConfig</a>;</code></dt>
<dt id="reexport.RemoteSettingsConfig2"><code>pub use config::<a class="struct" href="rust-docs/remote_settings/config/struct.RemoteSettingsConfig2.html" title="struct remote_settings::config::RemoteSettingsConfig2">RemoteSettingsConfig2</a>;</code></dt>
<dt id="reexport.RemoteSettingsServer"><code>pub use config::<a class="enum" href="rust-docs/remote_settings/config/enum.RemoteSettingsServer.html" title="enum remote_settings::config::RemoteSettingsServer">RemoteSettingsServer</a>;</code></dt>
<dt id="reexport.RemoteSettingsContext"><code>pub use context::<a class="struct" href="rust-docs/remote_settings/context/struct.RemoteSettingsContext.html" title="struct remote_settings::context::RemoteSettingsContext">RemoteSettingsContext</a>;</code></dt>
<dt id="reexport.ApiResult-1"><code>pub use error::<a class="type" href="rust-docs/remote_settings/error/type.ApiResult.html" title="type remote_settings::error::ApiResult">ApiResult</a>;</code></dt>
<dt id="reexport.RemoteSettingsError"><code>pub use error::<a class="enum" href="rust-docs/remote_settings/error/enum.RemoteSettingsError.html" title="enum remote_settings::error::RemoteSettingsError">RemoteSettingsError</a>;</code></dt>
<dt id="reexport.Result-2"><code>pub use error::<a class="type" href="rust-docs/remote_settings/error/type.Result.html" title="type remote_settings::error::Result">Result</a>;</code></dt>
</dl>
<h2 id="modules-4" class="section-header">Modules<a href="#modules-4" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/remote_settings/cache/index.html" title="mod remote_settings::cache">cache</a></dt>
<dt><a class="mod" href="rust-docs/remote_settings/client/index.html" title="mod remote_settings::client">client</a></dt>
<dt><a class="mod" href="rust-docs/remote_settings/config/index.html" title="mod remote_settings::config">config</a></dt>
<dd>This module defines the custom configurations that consumers can set.
<p>Those configurations override default values and can be used to set a custom server,
collection name, and bucket name.
The purpose of the configuration parameters are to allow consumers an easy debugging option,
and the ability to be explicit about the server.
<dt><a class="mod" href="rust-docs/remote_settings/context/index.html" title="mod remote_settings::context">context</a></dt>
<dt><a class="mod" href="rust-docs/remote_settings/error/index.html" title="mod remote_settings::error">error</a></dt>
<dt><a class="mod" href="rust-docs/remote_settings/schema/index.html" title="mod remote_settings::schema">schema</a></dt>
<dt><a class="mod" href="rust-docs/remote_settings/service/index.html" title="mod remote_settings::service">service</a></dt>
<dt><a class="mod" href="rust-docs/remote_settings/storage/index.html" title="mod remote_settings::storage">storage</a></dt>
<h2 id="macros-4" class="section-header">Macros<a href="#macros-4" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="macro" href="rust-docs/remote_settings/macro.packaged_attachments.html" title="macro remote_settings::packaged_attachments">packaged_<wbr>attachments</a></dt>
<dt><a class="macro" href="rust-docs/remote_settings/macro.packaged_collections.html" title="macro remote_settings::packaged_collections">packaged_<wbr>collections</a></dt>
<dt><a class="macro" href="rust-docs/remote_settings/macro.trace.html" title="macro remote_settings::trace">trace</a></dt>
</dl>
<h2 id="structs-5" class="section-header">Structs<a href="#structs-5" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/remote_settings/struct.RemoteSettings.html" title="struct remote_settings::RemoteSettings">Remote<wbr>Settings</a></dt>
<dt><a class="struct" href="rust-docs/remote_settings/struct.RemoteSettingsClient.html" title="struct remote_settings::RemoteSettingsClient">Remote<wbr>Settings<wbr>Client</a></dt>
<dd>Client for a single Remote Settings collection</dd>
<dt><a class="struct" href="rust-docs/remote_settings/struct.RemoteSettingsService.html" title="struct remote_settings::RemoteSettingsService">Remote<wbr>Settings<wbr>Service</a></dt>
<dd>Application-level Remote Settings manager.</dd>
</dl>
</p>
<footer id="open-on-gh-47">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/remote_settings/index.html">Edit this page on GitHub.</a></footer></dd>
</dl>
</section></div>
</main></body></html><div style="break-before: page; page-break-before: always;"></div>
<h1 id="relevancy"><a href="#relevancy" class="header">relevancy</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Proposed API for the relevancy component (validation phase)"><title>relevancy - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="relevancy" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate relevancy</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#relevancy">relevancy</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-9" href="rust-docs/relevancy/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-9">
<h3><a href="#modules-5">Crate Items</a></h3>
<ul class="block">
<li><a href="#modules-5" title="Modules">Modules</a></li>
<li><a href="#macros-5" title="Macros">Macros</a></li>
<li><a href="#structs-6" title="Structs">Structs</a></li>
<li><a href="#enums-6" title="Enums">Enums</a></li>
<li><a href="#functions-3" title="Functions">Functions</a></li>
<li><a href="#types-3" title="Type Aliases">Type Aliases</a></li>
</ul>
</section>
<div id="rustdoc-modnav-9"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-9" class="content">
<div class="main-heading">
<h1>Crate <span>relevancy</span> <button id="copy-path-9" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/relevancy/lib.rs.html#5-546">Source</a> </span></div>
<details class="toggle top-doc" open=""><summary class="hideme"><span>Expand description</span></summary>
<div class="docblock">
<p>Proposed API for the relevancy component (validation phase)</p>

<p>The goal here is to allow us to validate that we can reliably detect user interests from
history data, without spending too much time building the API out.  There’s some hand-waving
towards how we would use this data to rank search results, but we don’t need to come to a final
decision on that yet.</p>

</div>
</details>
<h2 id="modules-5" class="section-header">Modules<a href="#modules-5" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/relevancy/url_hash/index.html" title="mod relevancy::url_hash">url_<wbr>hash</a></dt>
</dl>
<h2 id="macros-5" class="section-header">Macros<a href="#macros-5" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="macro" href="rust-docs/relevancy/macro.debug.html" title="macro relevancy::debug">debug</a></dt>
<dt><a class="macro" href="rust-docs/relevancy/macro.error.html" title="macro relevancy::error">error</a></dt>
<dt><a class="macro" href="rust-docs/relevancy/macro.info.html" title="macro relevancy::info">info</a></dt>
<dt><a class="macro" href="rust-docs/relevancy/macro.trace.html" title="macro relevancy::trace">trace</a></dt>
<dt><a class="macro" href="rust-docs/relevancy/macro.warn.html" title="macro relevancy::warn">warn</a></dt>
</dl>
<h2 id="structs-6" class="section-header">Structs<a href="#structs-6" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/relevancy/struct.BanditCache.html" title="struct relevancy::BanditCache">Bandit<wbr>Cache</a></dt>
<dt><a class="struct" href="rust-docs/relevancy/struct.InterestMetrics.html" title="struct relevancy::InterestMetrics">Interest<wbr>Metrics</a></dt>
<dd>Interest metrics that we want to send to Glean as part of the validation process.  These contain
the cosine similarity when comparing the user’s interest against various interest vectors that
consumers may use.</dd>
<dt><a class="struct" href="rust-docs/relevancy/struct.InterestVector.html" title="struct relevancy::InterestVector">Interest<wbr>Vector</a></dt>
<dd>Vector storing a count value for each interest</dd>
<dt><a class="struct" href="rust-docs/relevancy/struct.RelevancyDb.html" title="struct relevancy::RelevancyDb">Relevancy<wbr>Db</a></dt>
<dd>A thread-safe wrapper around an SQLite connection to the Relevancy database</dd>
<dt><a class="struct" href="rust-docs/relevancy/struct.RelevancyStore.html" title="struct relevancy::RelevancyStore">Relevancy<wbr>Store</a></dt>
</dl>
<h2 id="enums-6" class="section-header">Enums<a href="#enums-6" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/relevancy/enum.Error.html" title="enum relevancy::Error">Error</a></dt>
<dd>Errors we use internally</dd>
<dt><a class="enum" href="rust-docs/relevancy/enum.Interest.html" title="enum relevancy::Interest">Interest</a></dt>
<dd>List of possible interests for a domain.  Domains can have be associated with one or multiple
interests.  <code>Inconclusive</code> is used for domains in the user’s top sites that we can’t classify
because there’s no corresponding entry in the interest database.</dd>
<dt><a class="enum" href="rust-docs/relevancy/enum.RelevancyApiError.html" title="enum relevancy::RelevancyApiError">Relevancy<wbr>ApiError</a></dt>
<dd>Errors we return via the public interface.</dd>
</dl>
<h2 id="functions-3" class="section-header">Functions<a href="#functions-3" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="fn" href="rust-docs/relevancy/fn.score.html" title="fn relevancy::score">score</a></dt>
<dd>Calculate score for a piece of categorized content based on a user interest vector.</dd>
</dl>
<h2 id="types-3" class="section-header">Type Aliases<a href="#types-3" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="type" href="rust-docs/relevancy/type.ApiResult.html" title="type relevancy::ApiResult">ApiResult</a></dt>
<dd>Result enum for the public API</dd>
<dt><a class="type" href="rust-docs/relevancy/type.Result.html" title="type relevancy::Result">Result</a></dt>
<dd>Result enum for internal functions</dd>
</dl>
</section></div>
</main></body></html>
<footer id="open-on-gh-48">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/relevancy/index.html">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="search"><a href="#search" class="header">search</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `search` crate."><title>search - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="search" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate search</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#search">search</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-10" href="rust-docs/search/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-10">
<h3><a href="#reexports-5">Crate Items</a></h3>
<ul class="block">
<li><a href="#reexports-5" title="Re-exports">Re-exports</a></li>
<li><a href="#modules-6" title="Modules">Modules</a></li>
<li><a href="#enums-7" title="Enums">Enums</a></li>
<li><a href="#types-4" title="Type Aliases">Type Aliases</a></li>
</ul>
</section>
<div id="rustdoc-modnav-10"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-10" class="content">
<div class="main-heading">
<h1>Crate <span>search</span> <button id="copy-path-10" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/search/lib.rs.html#5-24">Source</a> </span></div>
<h2 id="reexports-5" class="section-header">Re-exports<a href="#reexports-5" class="anchor">§</a></h2>
<dl class="item-table reexports">
<dt id="reexport.SearchEngineSelector"><code>pub use selector::<a class="struct" href="rust-docs/search/selector/struct.SearchEngineSelector.html" title="struct search::selector::SearchEngineSelector">SearchEngineSelector</a>;</code></dt>
<dt><code>pub use crate::<a class="mod" href="rust-docs/search/types/index.html" title="mod search::types">types</a>::*;</code></dt>
</dl>
<h2 id="modules-6" class="section-header">Modules<a href="#modules-6" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/search/selector/index.html" title="mod search::selector">selector</a></dt>
<dd>This module defines the main <code>SearchEngineSelector</code>.</dd>
<dt><a class="mod" href="rust-docs/search/types/index.html" title="mod search::types">types</a></dt>
<dd>This module defines the types that we export across the UNIFFI interface.</dd>
</dl>
<h2 id="enums-7" class="section-header">Enums<a href="#enums-7" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/search/enum.SearchApiError.html" title="enum search::SearchApiError">Search<wbr>ApiError</a></dt>
</dl>
<h2 id="types-4" class="section-header">Type Aliases<a href="#types-4" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="type" href="rust-docs/search/type.SearchApiResult.html" title="type search::SearchApiResult">Search<wbr>ApiResult</a></dt>
</dl>
</section></div>
</main></body></html>
<footer id="open-on-gh-49">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/search/index.html">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="suggest"><a href="#suggest" class="header">suggest</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `suggest` crate."><title>suggest - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="suggest" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate suggest</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#suggest">suggest</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-11" href="rust-docs/suggest/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-11">
<h3><a href="#modules-7">Crate Items</a></h3>
<ul class="block">
<li><a href="#modules-7" title="Modules">Modules</a></li>
<li><a href="#structs-7" title="Structs">Structs</a></li>
<li><a href="#enums-8" title="Enums">Enums</a></li>
<li><a href="#functions-4" title="Functions">Functions</a></li>
<li><a href="#types-5" title="Type Aliases">Type Aliases</a></li>
</ul>
</section>
<div id="rustdoc-modnav-11"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-11" class="content">
<div class="main-heading">
<h1>Crate <span>suggest</span> <button id="copy-path-11" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/suggest/lib.rs.html#6-46">Source</a> </span></div>
<h2 id="modules-7" class="section-header">Modules<a href="#modules-7" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/suggest/benchmarks/index.html" title="mod suggest::benchmarks">benchmarks</a></dt>
<dd>Benchmarking support</dd>
<dt><a class="mod" href="rust-docs/suggest/util/index.html" title="mod suggest::util">util</a></dt>
</dl>
<h2 id="structs-7" class="section-header">Structs<a href="#structs-7" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/suggest/struct.Geoname.html" title="struct suggest::Geoname">Geoname</a></dt>
<dd>A single geographic place.</dd>
<dt><a class="struct" href="rust-docs/suggest/struct.GeonameMatch.html" title="struct suggest::GeonameMatch">Geoname<wbr>Match</a></dt>
<dd>A fetched geoname with info on how it was matched.</dd>
<dt><a class="struct" href="rust-docs/suggest/struct.LabeledTimingSample.html" title="struct suggest::LabeledTimingSample">Labeled<wbr>Timing<wbr>Sample</a></dt>
<dd>Single sample for a Glean labeled_timing_distribution</dd>
<dt><a class="struct" href="rust-docs/suggest/struct.QueryWithMetricsResult.html" title="struct suggest::QueryWithMetricsResult">Query<wbr>With<wbr>Metrics<wbr>Result</a></dt>
<dt><a class="struct" href="rust-docs/suggest/struct.SuggestGlobalConfig.html" title="struct suggest::SuggestGlobalConfig">Suggest<wbr>Global<wbr>Config</a></dt>
<dd>Global Suggest configuration data.</dd>
<dt><a class="struct" href="rust-docs/suggest/struct.SuggestIngestionConstraints.html" title="struct suggest::SuggestIngestionConstraints">Suggest<wbr>Ingestion<wbr>Constraints</a></dt>
<dd>Constraints limit which suggestions to ingest from Remote Settings.</dd>
<dt><a class="struct" href="rust-docs/suggest/struct.SuggestIngestionMetrics.html" title="struct suggest::SuggestIngestionMetrics">Suggest<wbr>Ingestion<wbr>Metrics</a></dt>
<dd>Ingestion metrics</dd>
<dt><a class="struct" href="rust-docs/suggest/struct.SuggestStore.html" title="struct suggest::SuggestStore">Suggest<wbr>Store</a></dt>
<dd>The store is the entry point to the Suggest component. It incrementally
<p>downloads suggestions from the Remote Settings service, stores them in a
local database, and returns them in response to user queries.
<dt><a class="struct" href="rust-docs/suggest/struct.SuggestStoreBuilder.html" title="struct suggest::SuggestStoreBuilder">Suggest<wbr>Store<wbr>Builder</a></dt>
<dd>Builder for <a href="rust-docs/suggest/struct.SuggestStore.html" title="struct suggest::SuggestStore">SuggestStore</a></dd>
<dt><a class="struct" href="rust-docs/suggest/struct.SuggestionProviderConstraints.html" title="struct suggest::SuggestionProviderConstraints">Suggestion<wbr>Provider<wbr>Constraints</a></dt>
<dd>Some providers manage multiple suggestion subtypes. Queries, ingests, and
other operations on those providers must be constrained to a desired subtype.</dd>
<dt><a class="struct" href="rust-docs/suggest/struct.SuggestionQuery.html" title="struct suggest::SuggestionQuery">Suggestion<wbr>Query</a></dt>
<dd>A query for suggestions to show in the address bar.</dd>
<h2 id="enums-8" class="section-header">Enums<a href="#enums-8" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/suggest/enum.AmpMatchingStrategy.html" title="enum suggest::AmpMatchingStrategy">AmpMatching<wbr>Strategy</a></dt>
<dt><a class="enum" href="rust-docs/suggest/enum.Error.html" title="enum suggest::Error">Error</a></dt>
<dd>A list of errors that are internal to the component. This is the error
type for private and crate-internal methods, and is never returned to the
application.</dd>
<dt><a class="enum" href="rust-docs/suggest/enum.InterruptKind.html" title="enum suggest::InterruptKind">Interrupt<wbr>Kind</a></dt>
<dd>What should be interrupted when <a href="rust-docs/suggest/struct.SuggestStore.html#method.interrupt" title="method suggest::SuggestStore::interrupt">SuggestStore::interrupt</a> is called?</dd>
<dt><a class="enum" href="rust-docs/suggest/enum.SuggestApiError.html" title="enum suggest::SuggestApiError">Suggest<wbr>ApiError</a></dt>
<dd>The error type for all Suggest component operations. These errors are
exposed to your application, which should handle them as needed.</dd>
<dt><a class="enum" href="rust-docs/suggest/enum.SuggestProviderConfig.html" title="enum suggest::SuggestProviderConfig">Suggest<wbr>Provider<wbr>Config</a></dt>
<dd>Per-provider configuration data.</dd>
<dt><a class="enum" href="rust-docs/suggest/enum.Suggestion.html" title="enum suggest::Suggestion">Suggestion</a></dt>
<dd>A suggestion from the database to show in the address bar.</dd>
<dt><a class="enum" href="rust-docs/suggest/enum.SuggestionProvider.html" title="enum suggest::SuggestionProvider">Suggestion<wbr>Provider</a></dt>
<dd>A provider is a source of search suggestions.
Please preserve the integer values after removing or adding providers.
Provider configs are associated with integer keys stored in the database.</dd>
</dl>
<h2 id="functions-4" class="section-header">Functions<a href="#functions-4" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="fn" href="rust-docs/suggest/fn.raw_suggestion_url_matches.html" title="fn suggest::raw_suggestion_url_matches">raw_<wbr>suggestion_<wbr>url_<wbr>matches</a></dt>
<dd>Determines whether a “raw” sponsored suggestion URL is equivalent to a
“cooked” URL. The two URLs are equivalent if they are identical except for
their replaced template parameters, which can be different.</dd>
</dl>
<h2 id="types-5" class="section-header">Type Aliases<a href="#types-5" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="type" href="rust-docs/suggest/type.SuggestApiResult.html" title="type suggest::SuggestApiResult">Suggest<wbr>ApiResult</a></dt>
</dl>
</p>
<footer id="open-on-gh-50">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/suggest/index.html">Edit this page on GitHub.</a></footer></dd>
</dl>
</section></div>
</main></body></html><div style="break-before: page; page-break-before: always;"></div>
<h1 id="sync15"><a href="#sync15" class="header">sync15</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `sync15` crate."><title>sync15 - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="sync15" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate sync15</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#sync15">sync15</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-12" href="rust-docs/sync15/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-12">
<h3><a href="#modules-8">Crate Items</a></h3>
<ul class="block">
<li><a href="#modules-8" title="Modules">Modules</a></li>
<li><a href="#structs-8" title="Structs">Structs</a></li>
<li><a href="#enums-9" title="Enums">Enums</a></li>
<li><a href="#types-6" title="Type Aliases">Type Aliases</a></li>
</ul>
</section>
<div id="rustdoc-modnav-12"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-12" class="content">
<div class="main-heading">
<h1>Crate <span>sync15</span> <button id="copy-path-12" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/sync15/lib.rs.html#5-51">Source</a> </span></div>
<h2 id="modules-8" class="section-header">Modules<a href="#modules-8" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/sync15/bso/index.html" title="mod sync15::bso">bso</a></dt>
<dt><a class="mod" href="rust-docs/sync15/client/index.html" title="mod sync15::client">client</a></dt>
<dd>A module for everything needed to be a “sync client” - ie, a device which
<p>can perform a full sync of any number of collections, including managing
the server state.
<dt><a class="mod" href="rust-docs/sync15/clients_engine/index.html" title="mod sync15::clients_engine">clients_<wbr>engine</a></dt>
<dd>The client engine is a <a href="rust-docs/sync15/engine/index.html" title="mod sync15::engine">crate::engine</a>(Sync Engine) used to manage the
“clients” collection. The clients engine manages the client record for
“this device, and also manages “commands”.
In short, commands target one or more engines and instruct them to
perform various operations - such as wiping all local data.
These commands are used very rarely - currently the only command used
in practice is for bookmarks to wipe all their data, which is sent when
a desktop device restores all bookmarks from a backup. In this scenario,
desktop will delete all local bookmarks then replace them with the backed
up set, which without a “wipe” command would almost certainly cause other
connected devices to “resurrect” the deleted bookmarks.</dd>
<dt><a class="mod" href="rust-docs/sync15/engine/index.html" title="mod sync15::engine">engine</a></dt>
<dd>This module is used by crates which need to implement a “sync engine”.
At a high-level, a “sync engine” is code which knows how to take records
from a sync server, apply and reconcile them with the local data, then
provide records which should be uploaded to the server.</dd>
<dt><a class="mod" href="rust-docs/sync15/telemetry/index.html" title="mod sync15::telemetry">telemetry</a></dt>
<dd>Manage recording sync telemetry. Assumes some external telemetry
library/code which manages submitting.</dd>
<h2 id="structs-8" class="section-header">Structs<a href="#structs-8" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/sync15/struct.ClientData.html" title="struct sync15::ClientData">Client<wbr>Data</a></dt>
<dd>Argument to Store::prepare_for_sync. See comment there for more info. Only
really intended to be used by tabs engine.</dd>
<dt><a class="struct" href="rust-docs/sync15/struct.EncryptedPayload.html" title="struct sync15::EncryptedPayload">Encrypted<wbr>Payload</a></dt>
<dd>A representation of an encrypted payload. Used as the payload in EncryptedBso and
also anywhere else the sync keys might be used to encrypt/decrypt, such as send-tab payloads.</dd>
<dt><a class="struct" href="rust-docs/sync15/struct.Guid.html" title="struct sync15::Guid">Guid</a></dt>
<dd>This is a type intended to be used to represent the guids used by sync. It
has several benefits over using a <code>String</code>:</dd>
<dt><a class="struct" href="rust-docs/sync15/struct.KeyBundle.html" title="struct sync15::KeyBundle">KeyBundle</a></dt>
<dt><a class="struct" href="rust-docs/sync15/struct.RemoteClient.html" title="struct sync15::RemoteClient">Remote<wbr>Client</a></dt>
<dd>Information about a remote client in the clients collection.</dd>
<dt><a class="struct" href="rust-docs/sync15/struct.ServerTimestamp.html" title="struct sync15::ServerTimestamp">Server<wbr>Timestamp</a></dt>
<dd>Typesafe way to manage server timestamps without accidentally mixing them up with
local ones.</dd>
</dl>
<h2 id="enums-9" class="section-header">Enums<a href="#enums-9" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/sync15/enum.DeviceType.html" title="enum sync15::DeviceType">Device<wbr>Type</a></dt>
<dd>Enumeration for the different types of device.</dd>
<dt><a class="enum" href="rust-docs/sync15/enum.Error.html" title="enum sync15::Error">Error</a></dt>
</dl>
<h2 id="types-6" class="section-header">Type Aliases<a href="#types-6" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="type" href="rust-docs/sync15/type.CollectionName.html" title="type sync15::CollectionName">Collection<wbr>Name</a></dt>
<dt><a class="type" href="rust-docs/sync15/type.Result.html" title="type sync15::Result">Result</a></dt>
</dl>
</p>
<footer id="open-on-gh-51">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/sync15/index.html">Edit this page on GitHub.</a></footer></dd>
</dl>
</section></div>
</main></body></html><div style="break-before: page; page-break-before: always;"></div>
<h1 id="tabs"><a href="#tabs" class="header">tabs</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `tabs` crate."><title>tabs - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="tabs" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate tabs</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#tabs">tabs</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-13" href="rust-docs/tabs/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-13">
<h3><a href="#reexports-6">Crate Items</a></h3>
<ul class="block">
<li><a href="#reexports-6" title="Re-exports">Re-exports</a></li>
<li><a href="#modules-9" title="Modules">Modules</a></li>
<li><a href="#structs-9" title="Structs">Structs</a></li>
<li><a href="#enums-10" title="Enums">Enums</a></li>
<li><a href="#functions-5" title="Functions">Functions</a></li>
<li><a href="#types-7" title="Type Aliases">Type Aliases</a></li>
</ul>
</section>
<div id="rustdoc-modnav-13"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-13" class="content">
<div class="main-heading">
<h1>Crate <span>tabs</span> <button id="copy-path-13" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/tabs/lib.rs.html#5-53">Source</a> </span></div>
<h2 id="reexports-6" class="section-header">Re-exports<a href="#reexports-6" class="anchor">§</a></h2>
<dl class="item-table reexports">
<dt id="reexport.ApiResult-2"><code>pub use error::<a class="type" href="rust-docs/tabs/error/type.ApiResult.html" title="type tabs::error::ApiResult">ApiResult</a>;</code></dt>
<dt id="reexport.Error-1"><code>pub use error::<a class="enum" href="rust-docs/tabs/error/enum.Error.html" title="enum tabs::error::Error">Error</a>;</code></dt>
<dt id="reexport.Result-3"><code>pub use error::<a class="type" href="rust-docs/tabs/error/type.Result.html" title="type tabs::error::Result">Result</a>;</code></dt>
<dt id="reexport.TabsApiError"><code>pub use error::<a class="enum" href="rust-docs/tabs/error/enum.TabsApiError.html" title="enum tabs::error::TabsApiError">TabsApiError</a>;</code></dt>
</dl>
<h2 id="modules-9" class="section-header">Modules<a href="#modules-9" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/tabs/error/index.html" title="mod tabs::error">error</a></dt>
</dl>
<h2 id="structs-9" class="section-header">Structs<a href="#structs-9" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/tabs/struct.ClientRemoteTabs.html" title="struct tabs::ClientRemoteTabs">Client<wbr>Remote<wbr>Tabs</a></dt>
<dt><a class="struct" href="rust-docs/tabs/struct.LocalTabsInfo.html" title="struct tabs::LocalTabsInfo">Local<wbr>Tabs<wbr>Info</a></dt>
<dt><a class="struct" href="rust-docs/tabs/struct.PendingCommand.html" title="struct tabs::PendingCommand">Pending<wbr>Command</a></dt>
<dt><a class="struct" href="rust-docs/tabs/struct.RemoteCommandStore.html" title="struct tabs::RemoteCommandStore">Remote<wbr>Command<wbr>Store</a></dt>
<dt><a class="struct" href="rust-docs/tabs/struct.RemoteTabRecord.html" title="struct tabs::RemoteTabRecord">Remote<wbr>TabRecord</a></dt>
<dt><a class="struct" href="rust-docs/tabs/struct.TabsBridgedEngine.html" title="struct tabs::TabsBridgedEngine">Tabs<wbr>Bridged<wbr>Engine</a></dt>
<dt><a class="struct" href="rust-docs/tabs/struct.TabsEngine.html" title="struct tabs::TabsEngine">Tabs<wbr>Engine</a></dt>
<dt><a class="struct" href="rust-docs/tabs/struct.TabsStore.html" title="struct tabs::TabsStore">Tabs<wbr>Store</a></dt>
<dt><a class="struct" href="rust-docs/tabs/struct.Timestamp.html" title="struct tabs::Timestamp">Timestamp</a></dt>
</dl>
<h2 id="enums-10" class="section-header">Enums<a href="#enums-10" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/tabs/enum.RemoteCommand.html" title="enum tabs::RemoteCommand">Remote<wbr>Command</a></dt>
</dl>
<h2 id="functions-5" class="section-header">Functions<a href="#functions-5" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="fn" href="rust-docs/tabs/fn.get_registered_sync_engine.html" title="fn tabs::get_registered_sync_engine">get_<wbr>registered_<wbr>sync_<wbr>engine</a></dt>
<dd>Called by the sync manager to get a sync engine via the store previously
<p>registered with the sync manager.
<h2 id="types-7" class="section-header">Type Aliases<a href="#types-7" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="type" href="rust-docs/tabs/type.TabsDeviceType.html" title="type tabs::TabsDeviceType">Tabs<wbr>Device<wbr>Type</a></dt>
</dl>
</p>
<footer id="open-on-gh-52">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/tabs/index.html">Edit this page on GitHub.</a></footer></dd>
</dl>
</section></div>
</main></body></html><div style="break-before: page; page-break-before: always;"></div>
<h1 id="viaduct"><a href="#viaduct" class="header">viaduct</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `viaduct` crate."><title>viaduct - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="viaduct" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate viaduct</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#viaduct">viaduct</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-14" href="rust-docs/viaduct/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-14">
<h3><a href="#reexports-7">Crate Items</a></h3>
<ul class="block">
<li><a href="#reexports-7" title="Re-exports">Re-exports</a></li>
<li><a href="#modules-10" title="Modules">Modules</a></li>
<li><a href="#macros-6" title="Macros">Macros</a></li>
<li><a href="#structs-10" title="Structs">Structs</a></li>
<li><a href="#enums-11" title="Enums">Enums</a></li>
<li><a href="#traits-1" title="Traits">Traits</a></li>
<li><a href="#functions-6" title="Functions">Functions</a></li>
<li><a href="#types-8" title="Type Aliases">Type Aliases</a></li>
</ul>
</section>
<div id="rustdoc-modnav-14"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-14" class="content">
<div class="main-heading">
<h1>Crate <span>viaduct</span> <button id="copy-path-14" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/viaduct/lib.rs.html#5-464">Source</a> </span></div>
<h2 id="reexports-7" class="section-header">Re-exports<a href="#reexports-7" class="anchor">§</a></h2>
<dl class="item-table reexports">
<dt id="reexport.clear_ohttp_channels"><code>pub use ohttp::<a class="fn" href="rust-docs/viaduct/ohttp/fn.clear_ohttp_channels.html" title="fn viaduct::ohttp::clear_ohttp_channels">clear_ohttp_channels</a>;</code></dt>
<dt id="reexport.configure_ohttp_channel"><code>pub use ohttp::<a class="fn" href="rust-docs/viaduct/ohttp/fn.configure_ohttp_channel.html" title="fn viaduct::ohttp::configure_ohttp_channel">configure_ohttp_channel</a>;</code></dt>
<dt id="reexport.list_ohttp_channels"><code>pub use ohttp::<a class="fn" href="rust-docs/viaduct/ohttp/fn.list_ohttp_channels.html" title="fn viaduct::ohttp::list_ohttp_channels">list_ohttp_channels</a>;</code></dt>
<dt id="reexport.OhttpConfig"><code>pub use ohttp::<a class="struct" href="rust-docs/viaduct/ohttp/struct.OhttpConfig.html" title="struct viaduct::ohttp::OhttpConfig">OhttpConfig</a>;</code></dt>
<dt id="reexport.allow_android_emulator_loopback"><code>pub use settings::<a class="fn" href="rust-docs/viaduct/settings/fn.allow_android_emulator_loopback.html" title="fn viaduct::settings::allow_android_emulator_loopback">allow_android_emulator_loopback</a>;</code></dt>
<dt id="reexport.GLOBAL_SETTINGS"><code>pub use settings::<a class="static" href="rust-docs/viaduct/settings/static.GLOBAL_SETTINGS.html" title="static viaduct::settings::GLOBAL_SETTINGS">GLOBAL_SETTINGS</a>;</code></dt>
<dt><code>pub use <a class="mod" href="rust-docs/viaduct/error/index.html" title="mod viaduct::error">error</a>::*;</code></dt>
</dl>
<h2 id="modules-10" class="section-header">Modules<a href="#modules-10" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/viaduct/error/index.html" title="mod viaduct::error">error</a></dt>
<dt><a class="mod" href="rust-docs/viaduct/header_names/index.html" title="mod viaduct::header_names">header_<wbr>names</a></dt>
<dt><a class="mod" href="rust-docs/viaduct/ohttp/index.html" title="mod viaduct::ohttp">ohttp</a></dt>
<dt><a class="mod" href="rust-docs/viaduct/settings/index.html" title="mod viaduct::settings">settings</a></dt>
<dt><a class="mod" href="rust-docs/viaduct/status_codes/index.html" title="mod viaduct::status_codes">status_<wbr>codes</a></dt>
<dd>A module containing constants for all HTTP status codes.</dd>
</dl>
<h2 id="macros-6" class="section-header">Macros<a href="#macros-6" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="macro" href="rust-docs/viaduct/macro.debug.html" title="macro viaduct::debug">debug</a></dt>
<dt><a class="macro" href="rust-docs/viaduct/macro.error.html" title="macro viaduct::error">error</a></dt>
<dt><a class="macro" href="rust-docs/viaduct/macro.info.html" title="macro viaduct::info">info</a></dt>
<dt><a class="macro" href="rust-docs/viaduct/macro.trace.html" title="macro viaduct::trace">trace</a></dt>
<dt><a class="macro" href="rust-docs/viaduct/macro.warn.html" title="macro viaduct::warn">warn</a></dt>
</dl>
<h2 id="structs-10" class="section-header">Structs<a href="#structs-10" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/viaduct/struct.Client.html" title="struct viaduct::Client">Client</a></dt>
<dd>HTTP Client</dd>
<dt><a class="struct" href="rust-docs/viaduct/struct.ClientSettings.html" title="struct viaduct::ClientSettings">Client<wbr>Settings</a></dt>
<dt><a class="struct" href="rust-docs/viaduct/struct.Header.html" title="struct viaduct::Header">Header</a></dt>
<dd>A single header. Headers have a name (case insensitive) and a value. The
<p>character set for header and values are both restrictive.
<dt><a class="struct" href="rust-docs/viaduct/struct.HeaderName.html" title="struct viaduct::HeaderName">Header<wbr>Name</a></dt>
<dd>Represents a header name that we know to be both valid and lowercase.
Internally, this avoids allocating for headers that are constant strings,
like the predefined ones in this crate, however even without that
optimization, we would still likely have an equivalent of this for use
as a case-insensitive string guaranteed to only have valid characters.</dd>
<dt><a class="struct" href="rust-docs/viaduct/struct.Headers.html" title="struct viaduct::Headers">Headers</a></dt>
<dd>A list of headers.</dd>
<dt><a class="struct" href="rust-docs/viaduct/struct.InvalidHeaderName.html" title="struct viaduct::InvalidHeaderName">Invalid<wbr>Header<wbr>Name</a></dt>
<dd>Indicates an invalid header name. Note that we only emit
this for response headers, for request headers, we panic
instead. This is because it would likely come through as
a network error if we emitted it for local headers, when
it’s actually a bug that we’d need to fix.</dd>
<dt><a class="struct" href="rust-docs/viaduct/struct.Request.html" title="struct viaduct::Request">Request</a></dt>
<dt><a class="struct" href="rust-docs/viaduct/struct.Response.html" title="struct viaduct::Response">Response</a></dt>
<dd>A response from the server.</dd>
<h2 id="enums-11" class="section-header">Enums<a href="#enums-11" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="enum" href="rust-docs/viaduct/enum.Method.html" title="enum viaduct::Method">Method</a></dt>
<dd>HTTP Methods.</dd>
</dl>
<h2 id="traits-1" class="section-header">Traits<a href="#traits-1" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="trait" href="rust-docs/viaduct/trait.Backend.html" title="trait viaduct::Backend">Backend</a></dt>
<dt><a class="trait" href="rust-docs/viaduct/trait.OldBackend.html" title="trait viaduct::OldBackend">OldBackend</a></dt>
</dl>
<h2 id="functions-6" class="section-header">Functions<a href="#functions-6" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="fn" href="rust-docs/viaduct/fn.init_backend.html" title="fn viaduct::init_backend">init_<wbr>backend</a></dt>
<dt><a class="fn" href="rust-docs/viaduct/fn.note_backend.html" title="fn viaduct::note_backend">note_<wbr>backend</a></dt>
<dt><a class="fn" href="rust-docs/viaduct/fn.parse_url.html" title="fn viaduct::parse_url">parse_<wbr>url</a></dt>
<dt><a class="fn" href="rust-docs/viaduct/fn.send_ohttp_request.html" title="fn viaduct::send_ohttp_request">send_<wbr>ohttp_<wbr>request</a></dt>
<dd>Send a request through an OHTTP channel.</dd>
<dt><a class="fn" href="rust-docs/viaduct/fn.set_backend.html" title="fn viaduct::set_backend">set_<wbr>backend</a></dt>
</dl>
<h2 id="types-8" class="section-header">Type Aliases<a href="#types-8" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="type" href="rust-docs/viaduct/type.ViaductUrl.html" title="type viaduct::ViaductUrl">Viaduct<wbr>Url</a></dt>
</dl>
</p>
<footer id="open-on-gh-53">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/viaduct/index.html">Edit this page on GitHub.</a></footer></dd>
</dl>
</section></div>
</main></body></html><div style="break-before: page; page-break-before: always;"></div>
<h1 id="webext_storage"><a href="#webext_storage" class="header">webext_storage</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `webext_storage` crate."><title>webext_storage - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="webext_storage" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate webext_storage</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#webext_storage">webext_<wbr>storage</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-15" href="rust-docs/webext_storage/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-15">
<h3><a href="#reexports-8">Crate Items</a></h3>
<ul class="block">
<li><a href="#reexports-8" title="Re-exports">Re-exports</a></li>
<li><a href="#modules-11" title="Modules">Modules</a></li>
<li><a href="#structs-11" title="Structs">Structs</a></li>
<li><a href="#constants" title="Constants">Constants</a></li>
</ul>
</section>
<div id="rustdoc-modnav-15"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-15" class="content">
<div class="main-heading">
<h1>Crate <span>webext_<wbr>storage</span> <button id="copy-path-15" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/webext_storage/lib.rs.html#5-48">Source</a> </span></div>
<h2 id="reexports-8" class="section-header">Re-exports<a href="#reexports-8" class="anchor">§</a></h2>
<dl class="item-table reexports">
<dt id="reexport.QuotaReason"><code>pub use crate::error::<a class="enum" href="rust-docs/webext_storage/error/enum.QuotaReason.html" title="enum webext_storage::error::QuotaReason">QuotaReason</a>;</code></dt>
<dt id="reexport.WebExtStorageApiError"><code>pub use crate::error::<a class="enum" href="rust-docs/webext_storage/error/enum.WebExtStorageApiError.html" title="enum webext_storage::error::WebExtStorageApiError">WebExtStorageApiError</a>;</code></dt>
<dt id="reexport.WebExtStorageStore"><code>pub use crate::store::<a class="struct" href="rust-docs/webext_storage/store/struct.WebExtStorageStore.html" title="struct webext_storage::store::WebExtStorageStore">WebExtStorageStore</a>;</code></dt>
</dl>
<h2 id="modules-11" class="section-header">Modules<a href="#modules-11" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="mod" href="rust-docs/webext_storage/error/index.html" title="mod webext_storage::error">error</a></dt>
<dt><a class="mod" href="rust-docs/webext_storage/store/index.html" title="mod webext_storage::store">store</a></dt>
</dl>
<h2 id="structs-11" class="section-header">Structs<a href="#structs-11" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="struct" href="rust-docs/webext_storage/struct.MigrationInfo.html" title="struct webext_storage::MigrationInfo">Migration<wbr>Info</a></dt>
<dt><a class="struct" href="rust-docs/webext_storage/struct.StorageChanges.html" title="struct webext_storage::StorageChanges">Storage<wbr>Changes</a></dt>
<dt><a class="struct" href="rust-docs/webext_storage/struct.StorageValueChange.html" title="struct webext_storage::StorageValueChange">Storage<wbr>Value<wbr>Change</a></dt>
<dt><a class="struct" href="rust-docs/webext_storage/struct.SyncedExtensionChange.html" title="struct webext_storage::SyncedExtensionChange">Synced<wbr>Extension<wbr>Change</a></dt>
<dd>Holds a JSON-serialized map of all synced changes for an extension.</dd>
<dt><a class="struct" href="rust-docs/webext_storage/struct.UsageInfo.html" title="struct webext_storage::UsageInfo">Usage<wbr>Info</a></dt>
<dd>Information about the usage of a single extension.</dd>
<dt><a class="struct" href="rust-docs/webext_storage/struct.WebExtStorageBridgedEngine.html" title="struct webext_storage::WebExtStorageBridgedEngine">WebExt<wbr>Storage<wbr>Bridged<wbr>Engine</a></dt>
</dl>
<h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="constant" href="rust-docs/webext_storage/constant.STORAGE_VERSION.html" title="constant webext_storage::STORAGE_VERSION">STORAGE_<wbr>VERSION</a></dt>
<dt><a class="constant" href="rust-docs/webext_storage/constant.SYNC_MAX_ITEMS.html" title="constant webext_storage::SYNC_MAX_ITEMS">SYNC_<wbr>MAX_<wbr>ITEMS</a></dt>
<dt><a class="constant" href="rust-docs/webext_storage/constant.SYNC_QUOTA_BYTES.html" title="constant webext_storage::SYNC_QUOTA_BYTES">SYNC_<wbr>QUOTA_<wbr>BYTES</a></dt>
<dt><a class="constant" href="rust-docs/webext_storage/constant.SYNC_QUOTA_BYTES_PER_ITEM.html" title="constant webext_storage::SYNC_QUOTA_BYTES_PER_ITEM">SYNC_<wbr>QUOTA_<wbr>BYTES_<wbr>PER_<wbr>ITEM</a></dt>
</dl>
</section></div>
</main></body></html>
<footer id="open-on-gh-54">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/webext_storage/index.html">Edit this page on GitHub.</a></footer><div style="break-before: page; page-break-before: always;"></div>
<h1 id="init_rust_components"><a href="#init_rust_components" class="header">init_rust_components</a></h1>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `init_rust_components` crate."><title>init_rust_components - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="init_rust_components" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)" data-channel="1.91.0" data-search-js="search-e256b49e.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js"><script src="../static.files/storage-e2aeef58.js"></script><script defer="" src="../crates.js"></script><script defer="" src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar>
<h2><a href="#">Crate init_rust_components</a></h2>
</rustdoc-topbar><nav class="sidebar">
<div class="sidebar-crate">
<h2><a href="#init_rust_components">init_<wbr>rust_<wbr>components</a><span class="version">0.1.0</span></h2>
</div>
<div class="sidebar-elems">
<ul class="block">
<li><a id="all-types-16" href="rust-docs/init_rust_components/all.html">All Items</a></li>
</ul>
<section id="rustdoc-toc-16">
<h3><a href="#functions-7">Crate Items</a></h3>
<ul class="block">
<li><a href="#functions-7" title="Functions">Functions</a></li>
</ul>
</section>
<div id="rustdoc-modnav-16"></div>
</div>
</nav>
<div class="sidebar-resizer" title="Drag to resize sidebar"></div>
<main>
<div class="width-limiter"><section id="main-content-16" class="content">
<div class="main-heading">
<h1>Crate <span>init_<wbr>rust_<wbr>components</span> <button id="copy-path-16" title="Copy item path to clipboard">Copy item path</button></h1>
<rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="rust-docs/src/init_rust_components/lib.rs.html#6-50">Source</a> </span></div>
<h2 id="functions-7" class="section-header">Functions<a href="#functions-7" class="anchor">§</a></h2>
<dl class="item-table">
<dt><a class="fn" href="rust-docs/init_rust_components/fn.initialize.html" title="fn init_rust_components::initialize">initialize</a></dt>
<dd>Global initialization routines for Rust components, when <code>logins/keydb</code> feature is activated. Must be
<p>called before any other calls to Rust components.</p>
<footer id="open-on-gh-55">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/rust-docs/init_rust_components/index.html">Edit this page on GitHub.</a></footer></dd>
</dl>
</section></div>
</main></body></html><div style="break-before: page; page-break-before: always;"></div>
<h1 id="developing-documentation"><a class="header" href="#developing-documentation">Developing documentation</a></h1>
<p>The documentation in this repository pertains to the application-services library, primarily the sync and storage components, firefox account client and the nimbus-sdk experimentation client.</p>
<p>The markdown is converted to static HTML using <a href="https://rust-lang.github.io/mdBook/">mdbook</a>.  To add a new document, you need to add it to the SUMMARY.md file which produces the sidebar table of contents.</p>
<h2 id="building-documentation"><a class="header" href="#building-documentation">Building documentation</a></h2>
<h3 id="building-the-narrative-book-documentation"><a class="header" href="#building-the-narrative-book-documentation">Building the narrative (book) documentation</a></h3>
<p>The <code>mdbook</code> crate is required in order to build the documentation:</p>
<pre><code class="language-sh">cargo install mdbook mdbook-mermaid mdbook-open-on-gh
</code></pre>
<p>The repository documents are be built with:</p>
<pre><code class="language-sh">./tools/build.docs.sh
</code></pre>
<p>The built documentation is saved in <code>build/docs/book</code>.</p>
<footer id="open-on-gh-56">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/adding-docs.md">Edit this page on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
