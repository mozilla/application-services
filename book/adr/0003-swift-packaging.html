<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ADR-0003 - Cross-platform Rust Components</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-8a137ef6.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-5592c39f.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Cross-platform Rust Components</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="distributing-swift-packages"><a class="header" href="#distributing-swift-packages">Distributing Swift Packages</a></h1>
<ul>
<li>Status: accepted</li>
<li>Deciders: rfkelly</li>
<li>Date: 2021-07-22</li>
</ul>
<h2 id="context-and-problem-statement"><a class="header" href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>Our iOS consumers currently obtain application-services as a pre-compiled <code>.framework</code> bundle
distributed via <a href="https://github.com/Carthage/Carthage">Carthage</a>. The current setup is not
compatible with building on new M1 Apple Silicon machines and has a number of other problems.
As part of a broader effort to modernize the build process of iOS applications at Mozilla,
we have been asked to re-evaluate how application-services components are dsitributed for iOS.</p>
<p>See <a href="#problems-with-the-current-setup">Problems with the current setup</a> for more details.</p>
<h2 id="decision-drivers"><a class="header" href="#decision-drivers">Decision Drivers</a></h2>
<ul>
<li>Ease-of-use for iOS consumers.</li>
<li>Compatibility with M1 Apple Silicon machines.</li>
<li>Consistency with other iOS components being developed at Mozilla.</li>
<li>Ability for the Nimbus Swift bindings to easily depend on Glean.</li>
<li>Ease of maintainability for application-services developers.</li>
</ul>
<h2 id="considered-options"><a class="header" href="#considered-options">Considered Options</a></h2>
<ul>
<li><strong>(A) Do Nothing</strong>
<ul>
<li>Keep our current build and distribution setup as-is.</li>
</ul>
</li>
<li><strong>(B) Use Carthage to build XCFramework bundles</strong>
<ul>
<li>Make a minimal change to our Carthage setup so that it builds
the newer XCFramework format, which can support M1 Apple Silicon.</li>
</ul>
</li>
<li><strong>(C) Distribute a single pre-compiled Swift Package</strong>
<ul>
<li>Convert the all-in-one <code>MozillaAppServices</code> Carthage build to a similar
all-in-one Swift Package, distributed as a binary artifact.</li>
</ul>
</li>
<li><strong>(D) Distribute multiple source-based Swift Package targets, with pre-compiled Rust code</strong>
<ul>
<li>Split the all-in-one <code>MozillaAppServices</code> Carthage build into a separate
Swift Package target for each component, with a shared dependency on pre-compiled
Rust code as a binary artiact.</li>
</ul>
</li>
</ul>
<h2 id="decision-outcome"><a class="header" href="#decision-outcome">Decision Outcome</a></h2>
<p>Chosen option: <strong>(D) Distribute multiple source-based Swift Packages, with pre-compiled Rust code</strong>.</p>
<p>This option will provide the best long-term consumer experience for iOS developers, and
has the potential to simplify maintenance for application-services developers after an
initial investment of effort.</p>
<h3 id="positive-consequences"><a class="header" href="#positive-consequences">Positive Consequences</a></h3>
<ul>
<li>Swift packages are very convenient to consume in newer versions of Xcode.</li>
<li>Different iOS apps can choose to import a different subset of the available components,
potentiallying helping keep application size down.</li>
<li>Avoids issues with mis-matched Swift version between application-services build
and consumers, since Swift files are distributed in source form.</li>
<li>Encourages better conceptual separation between Swift code for different components;
e.g. it will make it possible for two Swift components to define an item of the same
name without conflicts.</li>
<li>Reduces the need to use Xcode as part of application-services build process, in favour
of command-line tools.</li>
</ul>
<h3 id="negative-consequences"><a class="header" href="#negative-consequences">Negative Consequences</a></h3>
<ul>
<li>More up-front work to move to this new setup.</li>
<li>We may be less likely to notice if our build setup breaks when used from within Xcode,
because we’re not exercising that code path ourselves.</li>
<li>May be harder to concurrently publish a Carthage framework for current consumers who aren’t
able to move to Swift packages.</li>
<li>There is likely to be some amount of API breakage for existing consumers, if only in having
to replace a single <code>import MozillaAppServices</code> with independent imports of each component.</li>
</ul>
<h3 id="implementation-sketch"><a class="header" href="#implementation-sketch">Implementation Sketch</a></h3>
<p>We will maintain the existing Carthage build infrastructure in the application-services repo and continue publishing a pre-built Carthage framework,
to support firefox-ios until they migrate to Swift Packages.</p>
<p>We will add an additional iOS build task in the application-services repo, that builds <em>just the Rust code</em> as a <code>.xcframework</code> bundle.
An initial prototype shows that this can be achieved using a relatively straightforward shell script, rather than requiring a second Xcode project.
It will be published as a <code>.zip</code> artifact on each release in the same way as the current Carthage framework.
The Rust code will be built as a static library, so that the linking process of the consuming application can pull in
just the subset of the Rust code that is needed for the components it consumes.</p>
<p>We will initially include only Nimbus and its dependencies in the <code>.xcframework</code> bundle,
but will eventually expand it to include all Rust components (including Glean, which will continue
to be included in the <code>application-services</code> repo as a git submodule)</p>
<p>We will create a new repository <code>rust-components-swift</code> to serve as the root of the new Swift Package distribution.
It will import the <code>application-services</code> repository as a git submodule. This will let us iterate quickly on the
Swift packaging setup without impacting existing consumers.</p>
<p>We will initially include only Nimbus and its dependencies in this new repository, and the Nimbus swift code
it will depend on Glean via the external <code>glean-swift</code> package. In the future we will publish all application-services
components that have a Swift interface through this repository, as well as Glean and any future Rust components.
(That’s why the repository is being given a deliberately generic name).</p>
<p>The <code>rust-components-swift</code> repo will contain a <code>Package.swift</code> file that defines:</p>
<ul>
<li>A single binary target that references the pre-built <code>.xcframework</code> bundle of Rust code.</li>
<li>One Swift target for each component, that references the Swift code from the git submodule
and depends on the pre-built Rust code.</li>
</ul>
<p>We will add automation to the <code>rust-components-swift</code> repo so that it automatically tracks
releases made in the <code>application-services</code> repo and creates a corresponding git tag for
the Swift package.</p>
<p>At some future date when all consumers have migrated to using Swift packages, we will remove
the Carthage build setup from the application-services repo.</p>
<p>At some future date, we will consider whether to move the <code>Package.swift</code> definition in to the <code>application-services</code> repo,
or whether it’s better to keep it separate. (Attempting to move it into the <code>application-services</code> will involve non-trivial
changes to the release process, because the checksum of the released <code>.xcframework</code> bundle needs to be included in
the release tagged version of the <code>Package.swift</code> file.)</p>
<h1 id="pros-and-cons-of-the-options"><a class="header" href="#pros-and-cons-of-the-options">Pros and Cons of the Options</a></h1>
<h3 id="a-do-nothing"><a class="header" href="#a-do-nothing"><strong>(A) Do Nothing</strong></a></h3>
<p>In this option, we would make no changes to our iOS build and publishing process.</p>
<ul>
<li>Good, because it’s the least amount of work.</li>
<li>Neutral, because it doesn’t change the maintainability of the system for appservices
developers.</li>
<li>Neutral, because it doesn’t change the amount of separation between Swift code
for our various components.</li>
<li>Neutral, because it doesn’t address the Swift version incompatibility issues around
binary artifacts.</li>
<li>Bad, because it will frustrate consumers who want to develop on M1 Apple Silicon.</li>
<li>Bad, because it may prevent consumers from migrating to a more modern build setup.</li>
<li>Bad, because it would prevent consumers from consuming Glean as a Swift package;
we would require them to use the Glean that is bundled in our build.</li>
</ul>
<p>This option isn’t really tractable for us, but it’s included for completeness.</p>
<h3 id="b-use-carthage-to-build-xcframework-bundles"><a class="header" href="#b-use-carthage-to-build-xcframework-bundles"><strong>(B) Use Carthage to build XCFramework bundles</strong></a></h3>
<p>In this option, we would try to change our iOS build and publishing process as little
as possible, but use Carthage’s recent support for <a href="https://github.com/Carthage/carthage#building-platform-independent-xcframeworks-Xcode-12-and-above">building platform-independent
XCFrameworks</a> in order
to support consumers running on M1 Apple Silicon.</p>
<ul>
<li>Good, because the size of the change is small.</li>
<li>Good, because we can support development on newer Apple machines.</li>
<li>Neutral, because it doesn’t change the maintainability of the system for appservices
developers.</li>
<li>Neutral, because it doesn’t change the amount of separation between Swift code
for our various components.</li>
<li>Neutral, because it doesn’t address the Swift version incompatibility issues around
binary artifacts.</li>
<li>Bad, because our iOS consumers have expressed a preference for moving away from Carthage.</li>
<li>Bad, because other iOS projects at Mozilla are moving to Swift Packages, making
us inconsistent with perceived best practice.</li>
<li>Bad, because it would prevent consumers from consuming Glean as a Swift package;
we would require them to use the Glean that is bundled in our build.</li>
<li>Bad, because consumers don’t get to choose which components they want to use (without
us building a whole new “megazord” with just the components they want).</li>
</ul>
<p>Overall, current circumstances feel like a good opportunity to invest a little more
time in order to set ourselves up for better long-term maintainability
and happier consumers. The main benefit of this option (it’s quicker!) is less attractive
under those circumstances.</p>
<h3 id="c-distribute-a-single-pre-compiled-swift-package"><a class="header" href="#c-distribute-a-single-pre-compiled-swift-package"><strong>(C) Distribute a single pre-compiled Swift Package</strong></a></h3>
<p>In this option, we would compile the Rust code and Swift code for all our components into
a single <code>.xcframework</code> bundle, and then distribute that as a
<a href="https://developer.apple.com/documentation/swift_packages/distributing_binary_frameworks_as_swift_packages">binary artifact</a> via Swift Package. This is similar to the approach
currently taken by Glean (ref <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1711447">Bug 1711447</a>)
except that they only have a single component.</p>
<ul>
<li>Good, because Swift Packages are the preferred distribution format for new iOS consumers.</li>
<li>Good, because we can support development on newer Apple machines.</li>
<li>Good, because it aligns with what other iOS component developers are doing at Mozilla.</li>
<li>Neutral, because it doesn’t change the maintainability of the system for appservices
developers.
<ul>
<li>(We’d need to keep the current Xcode project broadly intact).</li>
</ul>
</li>
<li>Neutral, because it doesn’t change the amount of separation between Swift code
for our various components.</li>
<li>Neutral, because it doesn’t address the Swift version incompatibility issues around
binary artifacts.</li>
<li>Neutral, because it would prevent consumers from consuming Glean as a separate Swift package;
they’d have to get it as part of <em>our</em> all-in-one Swift package.</li>
<li>Bad, because it’s a larger change and we have to learn about a new package manager.</li>
<li>Bad, because consumers don’t get to choose which components they want to use (without
building a whole new “megazord” with just the components they want).</li>
</ul>
<p>Overall, this option would be a marked improvement on the status quo, but leaves out some potential
improvements. For not that much more work, we can make some of the “Neutral” and “Bad” points
here into “Good” points.</p>
<h3 id="d-distribute-multiple-source-based-swift-packages-with-pre-compiled-rust-code"><a class="header" href="#d-distribute-multiple-source-based-swift-packages-with-pre-compiled-rust-code"><strong>(D) Distribute multiple source-based Swift Packages, with pre-compiled Rust code</strong></a></h3>
<p>In this option, we would compile <em>just the Rust code</em> for all our components into a single
<code>.xcframework</code> bundle and distribute that as a <a href="https://developer.apple.com/documentation/swift_packages/distributing_binary_frameworks_as_swift_packages">binary artifact</a> via Swift Package.
We would then declare a separate Swift <em>source</em> target for the Swift wrapper of each component,
each depending on the compiled Rust code but appearing as a separate item in the Swift package
definition.</p>
<ul>
<li>Good, because Swift Packages are the preferred distribution format for new iOS consumers.</li>
<li>Good, because we can support development on newer Apple machines.</li>
<li>Good, because it aligns with what other iOS component developers are doing at Mozilla.</li>
<li>Good, because it can potentially simplify the maintenance of the system for appservices
developers, by removing Xcode in favour of some command-line scripts.</li>
<li>Good, because it introduces strict separation between the Swift code for each component,
instead of compiling them all together in a single shared namespace.</li>
<li>Good, because the Nimbus Swift package could cleanly depend on the Glean Swift package.</li>
<li>Good, because consumers can choose which components they want to include.</li>
<li>Good, because it avoids issues with Swift version incompatibility in binary artifacts.</li>
<li>Bad, because it’s a larger change and we have to learn about a new package manager.</li>
</ul>
<p>The only downside to this option appears to be the amount of work involved, but an initial
prototype has given us some confidence that the change is tractable and that it may lead
to a system that is easier to maintain over time. It is thus our preferred option.</p>
<h1 id="appendix"><a class="header" href="#appendix">Appendix</a></h1>
<h2 id="further-reading"><a class="header" href="#further-reading">Further Reading</a></h2>
<ul>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1711447">Bug 1711447</a> has good historical context on the work to move Glean to using a Swift Package.</li>
<li>Some material on swift packages:
<ul>
<li><a href="https://www.swiftbysundell.com/articles/managing-dependencies-using-the-swift-package-manager/">Managing dependencies using the Swift Package Manager</a> was a useful overview.</li>
<li><a href="https://www.timc.dev/posts/understanding-swift-packages/">Understanding Swift Packages and Dependency Declarations</a> gives a bit of a deeper dive into having multiple targets
with different names in a single package.</li>
</ul>
</li>
<li>Outputs of initial prototype:
<ul>
<li>A prototype of Option (C): <a href="https://github.com/mozilla/application-services/pull/4216">Nimbus + Glean as a pre-built XCFramework Swift Package</a></li>
<li>A prototype of Option (D): <a href="https://github.com/mozilla/application-services/pull/4225">Rust code as XCFRamework</a> plus a <a href="https://github.com/rfk/rust-components-swift">Multi-product Swift Package</a> that depends on it.
<ul>
<li>A <a href="https://drive.google.com/file/d/12xsOMoFkxHZAEZ8tL5gBaiTYTYoQN1OO/view">video demo</a> of the resulting consumer experience.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="problems-with-the-current-setup"><a class="header" href="#problems-with-the-current-setup">Problems with the current setup</a></h2>
<p>It doesn’t build for M1 Apple Silicon machines, because it’s not possible to support
both arm64 device builds and arm64 simulator builds in a single binary <code>.framework</code>.</p>
<p>Carthage is dispreferred by our current iOS consumers.</p>
<p>We don’t have much experience with the setup on the current Application Services team,
and many of its details are under-documented. Changing the build setup requires Xcode
and some baseline knowledge of how to use it.</p>
<p>All components are built as a single Swift module, meaning they can see each other’s
internal symbols and may accidentally conflict when naming things. For example we can’t
currently have two components that define a structure of the same name.</p>
<p>Consumers can only use the pre-built binary artifacts if they are using the same
version of Xcode as was used during the application-services build. We are not able
to use Swift’s <code>BUILD_LIBRARY_FOR_DISTRIBUTION</code> flag to overcome this, because some
of our dependencies do not support this flag (specifically, the Swift protobuf lib).</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/adr/0003-swift-packaging.md">Edit this page on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../adr/0002-database-corruption.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../adr/0004-early-startup-experiments.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../adr/0002-database-corruption.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../adr/0004-early-startup-experiments.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
