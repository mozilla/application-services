<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Shipping Rust Components as Swift Packages - Cross-platform Rust Components</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../shared/a-s.css">
        <link rel="stylesheet" href="../shared/mermaid.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cross-platform Rust Components</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/mozilla/application-services" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="high-level-design-for-shipping-rust-components-as-swift-packages"><a class="header" href="#high-level-design-for-shipping-rust-components-as-swift-packages">High level design for shipping Rust Components as Swift Packages</a></h1>
<blockquote>
<p>This is a high level description of the decision highlighted in the <a href="../adr/0003-swift-packaging.html">ADR that introduced Swift Packages as a strategy to ship our Rust components</a>. That document includes that tradeoffs and why we chose this approach.</p>
</blockquote>
<!--
  N.B. you can edit this image in Google Docs and changes will be reflected automatically:

    https://docs.google.com/drawings/d/1tX05I-e6hNBQxch7PescDH7k4G7ddAJwXDPoIqp1RYk/edit
-->
<img src="https://docs.google.com/drawings/d/e/2PACX-1vRnyxy7VjdD3bYTso8V3AL5FpIQ4_S54dOCDI6fxfZEbG3_CVBwZZP1uLYbUVE9M54GSXUkNgewzOQm/pub?w=720&h=540" width="720" height="540" alt="A box diagram describing how the rust-components-swift repo, applicaiton-services repo, and MozillaRustComponents XCFramework interact">
<p>The strategy includes two main parts:</p>
<ul>
<li>The <a href="https://developer.apple.com/documentation/swift_packages/distributing_binary_frameworks_as_swift_packages">xcframework</a> that is built from a <a href="./megazords.html">megazord</a>. The xcframework contains the following, built for all our target iOS platforms.
<ul>
<li>The compiled Rust code for all the crates listed in <code>Cargo.toml</code> as a static library</li>
<li>The C header files and <a href="https://clang.llvm.org/docs/Modules.html">Swift module maps</a> for the components</li>
</ul>
</li>
<li>The firefox-ios repo uses a local <a href="https://github.com/mozilla-mobile/firefox-ios/blob/main/MozillaRustComponents/Package.swift">swift package</a> and an example of how they consume the xcframework <a href="https://github.com/mozilla/application-services/pull/6898">here</a>.</li>
</ul>
<h2 id="the-xcframework-and-application-services"><a class="header" href="#the-xcframework-and-application-services">The xcframework and <code>application-services</code></a></h2>
<p>In <code>application-services</code>, in the <a href="https://github.com/mozilla/application-services/tree/main/megazords/ios-rust"><code>megazords/ios-rust</code></a> directory, we have the following:</p>
<ul>
<li>A Rust crate that serves as the <a href="./megazords.html">megazord</a> for our iOS distributions. The megazord depends on all the Rust Component crates and re-exports their public APIs.</li>
<li>Some skeleton files for building an xcframework:
1. <a href="https://clang.llvm.org/docs/Modules.html"><code>module.modulemap</code></a>: The module map tells the Swift compiler how to use C APIs.
1. <code>MozillaRustComponents.h</code>: The header is used by the module map as a shortcut to specify all the available header files
1. <code>Info.plist</code>: The <code>plist</code> file specifies metadata about the resulting xcframework. For example, architectures and subdirectories.</li>
<li>The <code>build-xcframework.sh</code> script that stitches things together into a full xcframework bundle:
<ul>
<li>The <code>xcframework</code> format is not well documented; briefly:
<ul>
<li>The xcframework is a directory containing the resources compiled for multiple target architectures. The xcframework is distributed as a <code>.zip</code> file.</li>
<li>The top-level directory contains a subdirectory per architecture and an <code>Info.plist</code>. The <code>Info.plist</code> describes what lives in which directory.</li>
<li>Each subdirectory represents an architecture. And contains a <code>.framework</code> directory for that architecture.</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>It's a little unusual that we're building the xcframework by hand, rather than defining it as the build output of an Xcode project. It turns out to be simpler for our purposes, but does risk diverging from the expected format if Apple changes the details of xcframeworks in future Xcode releases.</p>
</blockquote>
<h2 id="consuming-application-services-in-a-swift-package-firefox-ios"><a class="header" href="#consuming-application-services-in-a-swift-package-firefox-ios">Consuming Application Services in a Swift package (Firefox iOS)</a></h2>
<p>Firefox iOS consumes the XCFramework via a local swift package: <a href="https://github.com/mozilla-mobile/firefox-ios/blob/main/MozillaRustComponents/Package.swift">MozillaRustComponents/Package.swift</a>.</p>
<p>Core requirements:</p>
<ul>
<li>A <code>binaryTarget</code> for <code>MozillaRustComponents</code> (URL+checksum for published zips, or a local <code>path:</code> for testing).</li>
<li>A location for UniFFI-generated Swift bindings in your package targets.</li>
<li>A target app that supports swift packages to consume the above binary + files.</li>
</ul>
<p>Example (URL-based):</p>
<pre><code class="language-swift">.binaryTarget(
  name: "MozillaRustComponents",
  url: "&lt;artifact-url&gt;/MozillaRustComponents.xcframework.zip",
  checksum: "&lt;sha256&gt;"
)

.target(
    name: "MozillaAppServices",
    dependencies: ["MozillaRustComponents"],
    path: "Sources/MozillaRustComponentsWrapper"
),
</code></pre>
<h2 id="the-rust-components-swift-repository"><a class="header" href="#the-rust-components-swift-repository">The <code>rust-components-swift</code> repository</a></h2>
<blockquote>
<p>[!WARNING]
rust-components-swift has been deprecated and is only around until there are no more potential uplifts to already-landed versions of firefox-ios. firefox-ios now consumes application-services via <a href="https://github.com/mozilla-mobile/firefox-ios/tree/main/MozillaRustComponents">local swift package</a></p>
</blockquote>
<p>The repository is a Swift Package for distributing releases of Mozilla's various Rust-based application components. It provides the Swift source code packaged in a format understood by the Swift package manager, and depends on a pre-compiled binary release of the underlying Rust code published from <code>application-services</code></p>
<p>The <code>rust-components-swift</code> repo mainly includes the following:</p>
<ul>
<li><code>Package.swift</code>: Defines all the <a href="https://developer.apple.com/documentation/swift_packages/target"><code>targets</code></a> and <a href="https://developer.apple.com/documentation/swift_packages/product"><code>products</code></a> the package exposes.
<ul>
<li><code>Package.swift</code> also includes where the package gets the <code>xcframework</code> that <code>application-services</code> builds</li>
</ul>
</li>
<li><code>make_tag.sh</code>: A script that does the following:
<ul>
<li>Generates any dynamically generated Swift code, mainly:
<ul>
<li>The <a href="https://github.com/mozilla/uniffi-rs/">uniffi</a> generated Swift bindings</li>
<li><a href="https://mozilla.github.io/glean/book/user/adding-glean-to-your-project/swift.html#setting-up-metrics-and-pings-code-generation">The Glean metrics</a></li>
</ul>
</li>
<li>Creates and commits a git tag that can be pushed to cut a release</li>
</ul>
</li>
</ul>
<blockquote>
<p>Consumers would then import the <code>rust-components-swift</code> swift package, by indicating the url of the package on github (i.e <a href="https://github.com/mozilla/rust-components-swift">https://github.com/mozilla/rust-components-swift</a>) and selecting a version using the git tag.</p>
</blockquote>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/swift-package-manager.md">Edit this page on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../design/sync-overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../design/components-strategy.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../design/sync-overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../design/components-strategy.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../shared/tabs.js"></script>
        <script src="../shared/mermaid.min.js"></script>
        <script src="../shared/mermaid-init.js"></script>



    </div>
    </body>
</html>
