<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Writing efficient tests - Cross-platform Rust Components</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../shared/a-s.css">
        <link rel="stylesheet" href="../shared/mermaid.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cross-platform Rust Components</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/mozilla/application-services" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="testing-faster-how-to-avoid-making-compile-times-worse-by-adding-tests"><a class="header" href="#testing-faster-how-to-avoid-making-compile-times-worse-by-adding-tests">Testing faster: How to avoid making compile times worse by adding tests</a></h1>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>We'd like to keep <code>cargo test</code>, <code>cargo build</code>, <code>cargo check</code>, ... reasonably
fast, and we'd <em>really</em> like to keep them fast if you pass <code>-p</code> for a specific
project. Unfortunately, there are a few ways this can become unexpectedly slow.
The easiest of these problems for us to combat at the moment is the unfortunate
placement of dev-dependencies in our build graph.</p>
<p>If you perform a <code>cargo test -p foo</code>, all dev-dependencies of <code>foo</code> must be
compiled before <code>foo</code>'s tests can start. This includes dependencies only used
non-test targets, such as examples or benchmarks.</p>
<p>In an ideal world, cargo could run your tests as soon as it finished with the
dependencies it needs for those tests, instead of waiting for your benchmark
suite, or the arg-parser your examples use, or etc.</p>
<p>Unfortunately, all cargo knows is that these are <code>dev-dependencies</code>, and not
which targets actually use them.</p>
<p>Additionally, unqualified invocations of cargo (that is, without <code>-p</code>) might
have an even worse time if we aren't careful. If I run, <code>cargo test</code>, cargo
knows <em>every</em> crate in the workspace needs to be built with all dev
dependencies, if <code>places</code> depends on <code>fxa-client</code>, all of <code>fxa-clients</code>
dev-dependencies must be compiled, ready, and linked in at least to the <code>lib</code>
target before we can even think about starting on <code>places</code>.</p>
<p>We have not been careful about what shape the dependency graph ends up as when example code is
taken into consideration (as it is by cargo during certain builds), and as a
result, we have this problem. Which isn't really a problem we
want to fix: Example code can and should depend on several different components,
and use them together in interesting ways.</p>
<p>So, because we don't want to change what our examples do, or make
major architectural changes of the non-test code for something like this, we
need to do something else.</p>
<h2 id="the-solution"><a class="header" href="#the-solution">The Solution</a></h2>
<p>To fix this, we manually insert "cuts" into the dependency graph to help cargo
out. That is, we pull some of these build targets (e.g. examples, benchmarks,
tests if they cause a substantial compile overhead) into their own dedicated
crates so that:</p>
<ol>
<li>They can be built in parallel with each other.</li>
<li>Crates depending on the component itself are not waiting on the
test/bench/example build in order for their test build to begin.</li>
<li>A potentially smaller set of our crates need to be rebuilt -- and a smaller
set of possible configurations exist meaning fewer items to add pressure to
caches.</li>
<li>...</li>
</ol>
<p>Some rules of thumb for when / when not to do this:</p>
<ul>
<li>
<p>All rust examples should be put in <code>examples/*</code>.</p>
</li>
<li>
<p>All rust benchmarks should be put in <code>testing/separated/*</code>. See the section
below on how to set your benchmark up to avoid redundant compiles.</p>
</li>
<li>
<p>Rust tests which brings in heavyweight dependencies should be evaluated on an
ad-hoc basis. If you're concerned, measure how long compilation takes
with/without, and consider how many crates depend on the crate where the test
lives (e.g. a slow test in support/foo might be far worse than one in a leaf
crate), etc...</p>
</li>
</ul>
<h3 id="appendix-how-to-avoid-redundant-compiles-for-benchmarks-and-integration-tests"><a class="header" href="#appendix-how-to-avoid-redundant-compiles-for-benchmarks-and-integration-tests">Appendix: How to avoid redundant compiles for benchmarks and integration tests</a></h3>
<p>To be clear, this is way more important for benchmarks (which always compile as
release and have a costly link phase).</p>
<p>Say you have a directory structure like the following:</p>
<pre><code>mycrate
 ├── src
 │   └── lib.rs
 | ...
 ├── benches
 │   ├── bench0.rs
 |   ├── bench1.rs
 │   └── bench2.rs
 ├── tests
 │   ├── test0.rs
 |   ├── test1.rs
 │   └── test2.rs
 └── ...
</code></pre>
<p>When you run your integration tests or benchmarks, each of <code>test0</code>, <code>test1</code>,
<code>test2</code> or <code>bench0</code>, <code>bench1</code>, <code>bench2</code> is compiled as it's own crate that runs
the tests in question and exits.</p>
<p>That means 3 benchmark executables are built on release settings, and 3
integration test executables.</p>
<p>If you've ever tried to add a piece of shared utility code into your integration
tests, only to have cargo (falsely) complain that it is dead code: this is why.
Even if <code>test0.rs</code> and <code>test2.rs</code> <em>both</em> use the utility function, unless
<em>every</em> test crate uses <em>every</em> shared utility, the crate that doesn't will
complain.</p>
<p>(Aside: This turns out to be an unintentional secondary benefit of this approach
-- easier shared code among tests, without having to put a
<code>#![allow(dead_code)]</code> in your utils.rs. We haven't hit that very much here,
since we tend to stick to unit tests, but it came up in mentat several times,
and is a frequent complaint people have)</p>
<p>Anyway, the solution here is simple: Create a new crate. If you were working in
<code>components/mycrate</code> and you want to add some integration tests or benchmarks,
you should do <code>cargo new --lib testing/separated/mycrate-test</code> (or
<code>.../mycrate-bench</code>).</p>
<p>Delete <code>.../mycrate-test/src/lib.rs</code>. Yep, really, we're making a crate that
only has integration tests/benchmarks (See the "FAQ0" section at the bottom of
the file if you're getting incredulous).</p>
<p>Now, add a <code>src/tests.rs</code> or a <code>src/benches.rs</code>. This file should contain <code>mod foo;</code> declarations for each submodule containing tests/benchmarks, if any.</p>
<p>For benches, this is also where you set up the benchmark harness (refer to
benchmark library docs for how).</p>
<p>Now, for a test, add: into your Cargo.toml</p>
<pre><code class="language-toml">[[test]]
name = "mycrate-test"
path = "src/tests.rs"
</code></pre>
<p>and for a benchmark, add:</p>
<pre><code class="language-toml">[[bench]]
name = "mycrate-benches"
path = "src/benches.rs"
harness = false
</code></pre>
<p>Because we aren't using <code>src/lib.rs</code>, this is what declares which file is the
root of the test/benchmark crate. Because there's only one target (unlike with
<code>tests/*</code> / <code>benches/*</code> under default settings), this will compile more quickly.</p>
<p>Additionally, <code>src/tests.rs</code> and <code>src/benches.rs</code> will behave like a normal
crate, the only difference being that they don't produce a lib, and that they're
triggered by <code>cargo test</code>/<code>cargo run</code> respectively.</p>
<h3 id="faq0-why-put-testsbenches-in-src-instead-of-disabling-autotestsautobenches"><a class="header" href="#faq0-why-put-testsbenches-in-src-instead-of-disabling-autotestsautobenches">FAQ0: Why put tests/benches in <code>src/*</code> instead of disabling <code>autotests</code>/<code>autobenches</code></a></h3>
<p>Instead of putting tests/benchmarks inside <code>src</code>, we could just delete the <code>src</code>
dir outright, and place everything in <code>tests</code>/<code>benches</code>.</p>
<p>Then, to get the same one-rebuild-per-file behavior that we'll get in <code>src</code>, we
need to add <code>autotests = false</code> or <code>autobenches = false</code> to our Cargo.toml,
adding a root <code>tests/tests.rs</code> (or <code>benches/benches.rs</code>) containing <code>mod</code> decls
for all submodules, and finally by referencing that "root" in the Cargo.toml
<code>[[tests]]</code> / <code>[[benches]]</code> list, exactly the same way we did for using <code>src/*</code>.</p>
<p>This would work, and on the surface, using <code>tests/*.rs</code> and <code>benches/*.rs</code> seems
more consistent, so it seems weird to use <code>src/*.rs</code> for these files.</p>
<p>My reasoning is as follows: Almost universally, <code>tests/*.rs</code>, <code>examples/*.rs</code>,
<code>benches/*.rs</code>, etc. are automatic. If you add a test into the tests folder, it
will run without anything else.</p>
<p>If we're going to set up one-build-per-{test,bench}suite as I described, this
fundamentally cannot be true. In this paradigm, if you add a test file named
<code>blah.rs</code>, you must add a <code>mod blah</code> it to the parent module.</p>
<p>It seems both confusing and error-prone to use <code>tests/*</code>, but have it behave
that way, however this is absolutely the normal behavior for files in <code>src/*.rs</code>
-- When you add a file, you then need to add it to it's parent module, and this
is something Rust programmers are pretty used to.</p>
<p>(In fact, we even replicated this behavior (for no reason) in the places
integration tests, and added the <code>mod</code> declarations to a "controlling" parent
module -- It seems weird to be in an environment where this <em>isn't</em> required)</p>
<p>So, that's why. This way, we make it <em>way</em> less likely that you add a test file
to some directory, and have it get ignored because you didn't realize that in
this one folder, you need to add a <code>mod mytest</code> into a neighboring tests.rs.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/design/test-faster.md">Edit this page on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../howtos/smoke-testing-app-services.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../howtos/debug-sql.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../howtos/smoke-testing-app-services.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../howtos/debug-sql.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../shared/tabs.js"></script>
        <script src="../shared/mermaid.min.js"></script>
        <script src="../shared/mermaid-init.js"></script>



    </div>
    </body>
</html>
